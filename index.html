<script type="module">
    // Importa√ß√µes do Firebase 
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
    import {
      getAuth,
      signInWithEmailAndPassword,
      signInWithPopup,
      GoogleAuthProvider,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";
    import {
      getFirestore,
      collection,
      doc,
      getDoc,
      getDocs,
      setDoc,
      updateDoc,
      deleteDoc,
      addDoc,
      query,
      orderBy,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

    // ===== CONFIG FIREBASE (SUBSTITUA PELO SEU) =====
    const firebaseConfig = {
      apiKey: "AIzaSyDa1z9LwlSHxwSTC974ci9RMEYdEiA_wEg", // Use sua chave!
      authDomain: "controle-validade-fc108.firebaseapp.com",
      projectId: "controle-validade-fc108",
      storageBucket: "controle-validade-fc108.firebasestorage.app",
      messagingSenderId: "737065688686",
      appId: "1:737065688686:web:ed3e602baf64c1fb4f907f",
      measurementId: "G-VJ8DMM47EN"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const googleProvider = new GoogleAuthProvider();

    // ===== VARI√ÅVEIS GLOBAIS DE ESTADO =====
    let html5QrCode = null; 
    let currentUserProfile = null; 
    
    // ===== ELEMENTOS (DOM) =====
    const loginView = document.getElementById("loginView");
    const appView = document.getElementById("appView");
    const loginEmail = document.getElementById("loginEmail");
    const loginSenha = document.getElementById("loginSenha");
    const btnLoginEmail = document.getElementById("btnLoginEmail");
    const btnLoginGoogle = document.getElementById("btnLoginGoogle");
    const userBox = document.getElementById("userBox");
    const menuNovo = document.getElementById("menu-novo");
    const menuItens = document.getElementById("menu-itens");
    const menuUsuarios = document.getElementById("menu-usuarios");
    const sideMenu = document.querySelector(".side-menu");
    const menuOverlay = document.getElementById("menuOverlay");
    const btnToggleMenu = document.getElementById("btnToggleMenu");
    const dataLancamento = document.getElementById("dataLancamento");
    const codigoBarras = document.getElementById("codigoBarras");
    const btnScan = document.getElementById("btnScan");
    const tabelaItensBody = document.getElementById("tabelaItensBody");
    const totalItensSpan = document.getElementById("totalItens");
    const scannerModal = document.getElementById("scannerModal");
    const btnCloseScanner = document.getElementById("btnCloseScanner");
    const novaLoja = document.getElementById("novaLoja");
    const departamento = document.getElementById("departamento");
    const descricao = document.getElementById("descricao");
    const lote = document.getElementById("lote");
    const quantidade = document.getElementById("quantidade");
    const validade = document.getElementById("validade");
    const observacao = document.getElementById("observacao");
    const btnSalvarLancamento = document.getElementById("btnSalvarLancamento");
    const filtroStatus = document.getElementById("filtroStatus");
    const filtroDepartamento = document.getElementById("filtroDepartamento");
    const filtroOferta = document.getElementById("filtroOferta");
    const btnMarcarTodosOferta = document.getElementById("btnMarcarTodosOferta");
    const btnExportExcel = document.getElementById("btnExportExcel");
    const btnExportPDF = document.getElementById("btnExportPDF");
    const usuariosBody = document.getElementById("usuariosBody");
    const novoUsuarioNome = document.getElementById("novoUsuarioNome");
    const novoUsuarioEmail = document.getElementById("novoUsuarioEmail");
    const novoUsuarioPerfil = document.getElementById("novoUsuarioPerfil");
    const novoUsuarioLoja = document.getElementById("novoUsuarioLoja");
    const btnSalvarUsuario = document.getElementById("btnSalvarUsuario");
    const btnReloadUsuarios = document.getElementById("btnReloadUsuarios");


    // ===================================
    // FUN√á√ïES DO SCANNER (CORRE√á√ÉO APLICADA) üì∑
    // ===================================

    function handleScanButtonClick() {
        scannerModal.classList.add('show');
        
        if (!html5QrCode && window.Html5Qrcode) {
            html5QrCode = new window.Html5Qrcode("qr-reader");
            console.log("Html5Qrcode instanciado via global.");
        } else if (!window.Html5Qrcode) {
             console.error("Html5Qrcode n√£o encontrado. Verifique se o script foi carregado.");
             alert("Erro ao iniciar o scanner. Biblioteca n√£o carregada.");
             scannerModal.classList.remove('show');
             return;
        }
        
        startScanner();
    }

    function closeScannerModal() {
        scannerModal.classList.remove('show');
        
        if (html5QrCode && html5QrCode.isScanning) {
            html5QrCode.stop().then(ignore => {
                console.log("Scanner parado com sucesso.");
            }).catch(err => {
                console.error("Erro ao parar o scanner:", err);
            });
        }
    }

    function startScanner() {
        const qrCodeSuccessCallback = (decodedText, decodedResult) => {
            codigoBarras.value = decodedText;
            closeScannerModal();
            console.log(`C√≥digo lido: ${decodedText}`);
        };

        const config = {
            fps: 10,
            qrbox: { width: 250, height: 100 },
            facingMode: "environment" 
        };

        if (html5QrCode && !html5QrCode.isScanning) { 
            html5QrCode.start(
                { facingMode: "environment" }, 
                config, 
                qrCodeSuccessCallback,
                (errorMessage) => {
                    // Opcional: callback para erro de leitura
                } 
            ).catch(err => {
                console.error("Erro ao iniciar a c√¢mera:", err);
                alert("N√£o foi poss√≠vel iniciar a c√¢mera. Verifique as permiss√µes do navegador ou do sistema.");
                closeScannerModal();
            });
        }
    }

    // ===================================
    // FUN√á√ïES DE UTILIDADE E FORMATA√á√ÉO
    // ===================================

    const formatarData = (date) => {
        if (!date) return '';
        const d = date.toDate ? date.toDate() : new Date(date); 
        return d.toLocaleDateString('pt-BR');
    };

    const getStatusVencimento = (validadeStr) => {
        const hoje = new Date();
        const validade = new Date(validadeStr + 'T00:00:00'); 
        const diffTime = validade.getTime() - hoje.getTime();
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

        if (diffDays < 0) return { label: 'Vencido', class: 'danger' };
        if (diffDays <= 7) return { label: `Vence em ${diffDays} dias`, class: 'danger' };
        if (diffDays <= 30) return { label: `Vence em ${diffDays} dias`, class: 'warning' };
        return { label: 'OK', class: 'ok' };
    };
    
    // TIDP: Verifica√ß√£o de autoriza√ß√£o antes de deletar
    window.deleteItem = async (id) => { 
        if (!currentUserProfile || currentUserProfile.perfil !== 'admin') {
            alert('Apenas administradores podem excluir itens.');
            return;
        }

        if(confirm(`Deseja EXCLUIR permanentemente o item ${id}? (Requer perfil de Admin)`)) { 
            try {
                const itemRef = doc(db, "lancamentos", id);
                await deleteDoc(itemRef);
                alert("Item exclu√≠do com sucesso!");
                loadItens(); // Recarrega a tabela
            } catch (error) {
                console.error("Erro ao excluir item:", error);
                alert("Falha ao excluir item. Verifique o console.");
            }
        } 
    };
    
    window.editItem = (id) => { console.log(`Fun√ß√£o editar item ${id}`); }; // Placeholder


    // ===================================
    // FUN√á√ïES DE CARREGAMENTO DE DADOS üíæ
    // ===================================

    async function loadItens() {
        // ... (l√≥gica de carregamento e renderiza√ß√£o da tabela)
        tabelaItensBody.innerHTML = '<tr><td colspan="14" style="text-align:center; padding: 20px;">Carregando dados...</td></tr>';
        
        try {
            const itensCol = collection(db, "lancamentos");
            const q = query(itensCol, orderBy("validade", "asc"));
            const itemSnapshot = await getDocs(q);
            
            const itensList = [];
            itemSnapshot.forEach(doc => {
                itensList.push({ id: doc.id, ...doc.data() });
            });

            totalItensSpan.textContent = itensList.length;
            renderItensTable(itensList); 

        } catch (error) {
            console.error("Erro ao carregar itens:", error);
            tabelaItensBody.innerHTML = '<tr><td colspan="14" style="color:red; text-align:center; padding: 20px;">Falha ao carregar itens. Verifique o console.</td></tr>';
        }
    }
    
    function renderItensTable(itens) {
        // ... (l√≥gica de renderiza√ß√£o da tabela, mantida)
        tabelaItensBody.innerHTML = '';
        if (itens.length === 0) {
            tabelaItensBody.innerHTML = '<tr><td colspan="14" style="text-align:center; padding: 20px;">Nenhum item encontrado.</td></tr>';
            return;
        }

        itens.forEach(item => {
            const status = getStatusVencimento(item.validade);
            const isOferta = item.isOferta ? 'lancado' : 'nao_lancado';
            const dataLancamentoFormatada = formatarData(item.dataLancamento);
            const dataCriacaoFormatada = item.dataCriacao ? formatarData(item.dataCriacao) : '-';

            const row = `
                <tr>
                    <td>${dataLancamentoFormatada}</td>
                    <td>${item.loja}</td>
                    <td>${item.codigoBarras}</td>
                    <td>${item.descricao}</td>
                    <td>${item.lote || '-'}</td>
                    <td>${item.quantidade}</td>
                    <td>${formatarData(item.validade)}</td>
                    <td>${item.observacao || '-'}</td>
                    <td>
                        <span class="badge-oferta badge-oferta-${isOferta}">
                            ${isOferta === 'lancado' ? '‚úÖ Lan√ßado' : '‚ùå N√£o Lan√ßado'}
                        </span>
                    </td>
                    <td>${item.departamento}</td>
                    <td>
                        <span class="badge-status badge-status-${status.class}">${status.label}</span>
                    </td>
                    <td>${item.usuarioNome || 'Desconhecido'}</td>
                    <td>${dataCriacaoFormatada}</td>
                    <td class="actions-cell">
                        <button onclick="editItem('${item.id}')">‚úèÔ∏è Editar</button>
                        <button class="btn-delete" onclick="deleteItem('${item.id}')">üóëÔ∏è Excluir</button>
                    </td>
                </tr>
            `;
            tabelaItensBody.innerHTML += row;
        });
    }

    // ===================================
    // FUN√á√ÉO DE SALVAR LAN√áAMENTO (TIDP: VALIDA√á√ÉO E AUTORIZA√á√ÉO)
    // ===================================
    
    btnSalvarLancamento.addEventListener('click', async () => {
        if (!currentUserProfile) {
            alert("Erro de autentica√ß√£o. Por favor, fa√ßa login novamente.");
            return;
        }

        // TIDP: 1. Valida√ß√£o de Campos Obrigat√≥rios
        const loja = novaLoja.value;
        const dept = departamento.value;
        const codBarras = codigoBarras.value.trim();
        const desc = descricao.value.trim();
        const qtd = parseInt(quantidade.value);
        const dataValidade = validade.value;
        
        if (!loja || !dept || !codBarras || !desc || !qtd || !dataValidade) {
            alert("Preencha todos os campos obrigat√≥rios (Loja, Depto, C√≥d. Barras, Descri√ß√£o, Quantidade, Validade).");
            return;
        }
        
        // TIDP: 2. Valida√ß√£o do C√≥digo de Barras
        if (!/^\d{1,13}$/.test(codBarras)) {
            alert("O c√≥digo de barras deve conter apenas n√∫meros e ter no m√°ximo 13 d√≠gitos.");
            return;
        }
        
        // TIDP: 3. Sanitariza√ß√£o (para prevenir XSS se os dados fossem renderizados sem cuidado)
        const sanitizedData = {
            loja: loja,
            departamento: dept,
            codigoBarras: codBarras,
            descricao: desc,
            lote: lote.value.trim(),
            quantidade: qtd,
            validade: dataValidade,
            observacao: observacao.value.trim(),
            // TIDP: 4. Adicionar Metadados do Usu√°rio (Para RBAC e Auditoria)
            usuarioUid: auth.currentUser.uid,
            usuarioNome: currentUserProfile.nome || auth.currentUser.email,
            dataLancamento: dataLancamento.value,
            dataCriacao: serverTimestamp(),
            isOferta: false
        };

        try {
            await addDoc(collection(db, "lancamentos"), sanitizedData);
            alert("Lan√ßamento salvo com sucesso!");
            
            // Limpar formul√°rio
            document.querySelectorAll('#view-novo input:not([readonly]), #view-novo textarea, #view-novo select').forEach(el => {
                if (el.tagName !== 'SELECT' && el.id !== 'dataLancamento') el.value = '';
                if (el.tagName === 'SELECT') el.value = '';
            });

        } catch (error) {
            console.error("Erro ao salvar lan√ßamento:", error);
            alert("Falha ao salvar lan√ßamento. Verifique o console.");
        }
    });

    // ===================================
    // L√ìGICA DE AUTENTICA√á√ÉO E PERFIL üîë
    // ===================================

    const logout = () => {
        closeScannerModal(); 
        signOut(auth);
    };

    const login = async (email, password) => {
        try {
            await signInWithEmailAndPassword(auth, email, password);
        } catch (error) {
            alert(`Erro no Login: ${error.message}`);
            console.error(error);
        }
    };

    const loginGoogle = async () => {
        try {
            await signInWithPopup(auth, googleProvider);
        } catch (error) {
            alert(`Erro no Login com Google: ${error.message}`);
            console.error(error);
        }
    };

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            loginView.style.display = 'none';
            appView.style.display = 'flex';
            
            // TIDP: 5. Carregar Perfil (Base para RBAC)
            // Mantido o perfil simplificado/default para fidelidade ao c√≥digo, 
            // mas em produ√ß√£o, o perfil deve ser lido do Firestore.
            currentUserProfile = { 
                perfil: 'repositor', 
                loja: '', 
                nome: user.displayName || user.email
            }; 
            
            // 2. Atualiza a caixa de usu√°rio com dados do perfil (default)
            const userProfileLabel = currentUserProfile.perfil.charAt(0).toUpperCase() + currentUserProfile.perfil.slice(1);
            userBox.innerHTML = `
                <strong>${currentUserProfile.nome || user.email}</strong>
                <span class="user-profile-label">${userProfileLabel} (${currentUserProfile.loja || 'Sem Loja'})</span>
                <a onclick="logout()">Sair</a>
            `;

            // 3. TIDP: RBAC para Menu (Esconde/mostra Admin)
            if (currentUserProfile.perfil === 'admin') {
                menuUsuarios.style.display = 'flex'; 
            } else {
                menuUsuarios.style.display = 'none';
            }
            
            // 4. Carrega os dados principais
            loadItens();

        } else {
            loginView.style.display = 'flex';
            appView.style.display = 'none';
            currentUserProfile = null;
            menuUsuarios.style.display = 'none';
        }
    });

    window.logout = logout;


    // ===================================
    // EVENT LISTENERS E INICIALIZA√á√ïES
    // ===================================

    // Listeners de Autentica√ß√£o
    btnLoginEmail.addEventListener('click', () => {
        login(loginEmail.value, loginSenha.value);
    });

    btnLoginGoogle.addEventListener('click', loginGoogle);
    
    // Listeners do Scanner
    btnScan.addEventListener('click', handleScanButtonClick);
    btnCloseScanner.addEventListener('click', closeScannerModal);

    // Fun√ß√µes de navega√ß√£o e UI
    const switchView = (viewId) => {
        document.querySelectorAll('.app-view').forEach(view => {
            view.classList.remove('app-view-active');
        });
        document.getElementById(viewId).classList.add('app-view-active');

        document.querySelectorAll('.menu-item').forEach(item => {
            item.classList.remove('menu-item-active');
        });
        document.getElementById(`menu-${viewId.replace('view-', '')}`).classList.add('menu-item-active');

        if (sideMenu.classList.contains('open')) {
            sideMenu.classList.remove('open');
            menuOverlay.classList.remove('show');
        }
    };

    menuNovo.addEventListener('click', () => switchView('view-novo'));
    menuItens.addEventListener('click', () => {
        switchView('view-itens');
        loadItens(); 
    });
    menuUsuarios.addEventListener('click', () => {
        // TIDP: Prote√ß√£o de Rota (RBAC)
        if(currentUserProfile && currentUserProfile.perfil === 'admin') {
            switchView('view-usuarios');
            // loadUsuarios(); 
        } else {
             alert('Acesso restrito a administradores.');
        }
    });

    btnToggleMenu.addEventListener('click', () => {
        sideMenu.classList.toggle('open');
        menuOverlay.classList.toggle('show');
    });

    menuOverlay.addEventListener('click', () => {
        sideMenu.classList.remove('open');
        menuOverlay.classList.remove('show');
    });

    // Inicializa√ß√£o da data
    window.onload = () => {
        dataLancamento.value = new Date().toLocaleDateString('pt-BR'); 
    };

</script>
