<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Controle de Validade</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- √çcones -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/remixicon@4.1.0/fonts/remixicon.css" />

  <!-- SheetJS para Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- jsPDF + autoTable para PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

  <!-- Leitor de c√≥digo de barras -->
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

  <style>
    body { background-color: #0f172a; }
    .blur-bg { backdrop-filter: blur(10px); }
    .tag {
      font-size: 0.75rem;
      padding: 0.15rem 0.5rem;
      border-radius: 999px;
      font-weight: 600;
    }
  </style>
</head>
<body class="text-slate-100 min-h-screen">

  <!-- Navbar -->
  <header class="bg-slate-900/80 border-b border-slate-700 sticky top-0 z-20 blur-bg">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-8 h-8 rounded-xl bg-emerald-500 flex items-center justify-center font-bold text-slate-900">
          CV
        </div>
        <div>
          <h1 class="text-lg font-semibold">Controle de Validade</h1>
          <p class="text-xs text-slate-400">Multi-loja ‚Ä¢ Acesso por perfil</p>
        </div>
      </div>
      <div id="userInfo" class="text-right text-xs hidden">
        <div id="userName" class="font-semibold"></div>
        <div id="userRole" class="text-slate-400"></div>
        <button id="logoutBtn" class="mt-1 text-[11px] text-red-400 hover:text-red-300">
          Sair
        </button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6">

    <!-- Tela de login -->
    <section id="loginSection" class="max-w-md mx-auto">
      <div class="bg-slate-900/80 border border-slate-700 rounded-2xl p-6 shadow-xl">
        <h2 class="text-xl font-semibold mb-1">Entrar</h2>
        <p class="text-sm text-slate-400 mb-4">
          Acesse o Controle de Validade com seu e-mail corporativo.
        </p>

        <form id="loginForm" class="space-y-3">
          <div>
            <label class="text-xs text-slate-300">E-mail</label>
            <input id="emailInput" type="email" required
              class="mt-1 w-full px-3 py-2 rounded-xl bg-slate-800 border border-slate-700 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500" />
          </div>
          <div>
            <label class="text-xs text-slate-300">Senha</label>
            <input id="passwordInput" type="password" required
              class="mt-1 w-full px-3 py-2 rounded-xl bg-slate-800 border border-slate-700 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500" />
          </div>

          <button type="submit"
            class="w-full mt-2 bg-emerald-500 hover:bg-emerald-400 text-slate-900 font-semibold py-2 rounded-xl text-sm flex items-center justify-center gap-2">
            <i class="ri-mail-line text-base"></i> Entrar com e-mail
          </button>
        </form>

        <div class="mt-4 border-t border-slate-700 pt-4">
          <button id="googleLoginBtn"
            class="w-full border border-slate-600 hover:bg-slate-800 text-sm py-2 rounded-xl flex items-center justify-center gap-2">
            <i class="ri-google-fill text-red-400"></i> Entrar com Google
          </button>
        </div>

        <p class="mt-4 text-[11px] text-slate-500">
          A conta precisa ter um perfil cadastrado (admin, gerente ou repositor) na cole√ß√£o
          <span class="font-mono text-slate-300">users</span> do Firestore.
        </p>

        <p id="loginError" class="mt-2 text-xs text-red-400 hidden"></p>
      </div>
    </section>

    <!-- App principal -->
    <section id="appSection" class="hidden space-y-6">
      <!-- Abas -->
      <div
        class="bg-slate-900/80 border border-slate-700 rounded-2xl p-3 flex flex-wrap gap-2 text-xs font-medium">
        <button data-tab="cadastroTab"
          class="tab-btn px-3 py-1.5 rounded-xl bg-emerald-500 text-slate-900 flex items-center gap-1">
          <i class="ri-add-circle-line"></i> Cadastro
        </button>
        <button data-tab="itensTab"
          class="tab-btn px-3 py-1.5 rounded-xl bg-slate-800 text-slate-200 flex items-center gap-1">
          <i class="ri-database-2-line"></i> Itens cadastrados
        </button>
      </div>

      <!-- CADASTRO -->
      <div id="cadastroTab" class="tab-panel space-y-4">
        <div class="bg-slate-900/80 border border-slate-700 rounded-2xl p-4">
          <h2 class="text-sm font-semibold mb-4 flex items-center gap-2">
            <i class="ri-add-box-line text-emerald-400"></i> Cadastro de produto
          </h2>

          <form id="cadastroForm" class="grid grid-cols-1 md:grid-cols-4 gap-3 text-xs">
            <!-- Loja -->
            <div>
              <label class="block text-[11px] text-slate-300 mb-1">Loja</label>
              <select id="lojaSelect" required
                class="w-full px-3 py-2 rounded-xl bg-slate-800 border border-slate-700 focus:outline-none focus:ring-2 focus:ring-emerald-500 text-xs">
                <option value="">Selecione</option>
                <option value="Ponta Verde">Ponta Verde</option>
                <option value="Farol">Farol</option>
                <option value="Praia">Praia</option>
                <option value="Riomar">Riomar</option>
              </select>
            </div>

            <!-- Data lan√ßamento -->
            <div>
              <label class="block text-[11px] text-slate-300 mb-1">Data lan√ßamento</label>
              <input id="dataLancamentoInput" type="text" readonly
                class="w-full px-3 py-2 rounded-xl bg-slate-800 border border-slate-700 text-xs text-slate-400" />
            </div>

            <!-- Departamento -->
            <div>
              <label class="block text-[11px] text-slate-300 mb-1">Departamento</label>
              <select id="departamentoSelect" required
                class="w-full px-3 py-2 rounded-xl bg-slate-800 border border-slate-700 focus:outline-none focus:ring-2 focus:ring-emerald-500 text-xs">
                <option value="">Selecione</option>
                <option>A√ßougue</option>
                <option>Adega</option>
                <option>Bebidas</option>
                <option>Mercearia Alimentos</option>
                <option>Mercearia N√£o Alimentos</option>
                <option>Perec√≠veis Processados</option>
              </select>
            </div>

            <!-- C√≥digo de barras + scanner -->
            <div>
              <label class="block text-[11px] text-slate-300 mb-1">C√≥d. barras (n√∫meros, m√°x. 13)</label>
              <div class="flex gap-2">
                <input id="codigoBarrasInput" required maxlength="13" inputmode="numeric" pattern="[0-9]{1,13}"
                  class="flex-1 px-3 py-2 rounded-xl bg-slate-800 border border-slate-700 focus:outline-none focus:ring-2 focus:ring-emerald-500 text-xs" />
                <button type="button" id="scanButton"
                  class="px-3 py-2 rounded-xl bg-slate-700 hover:bg-slate-600 text-xs flex items-center gap-1">
                  <i class="ri-qr-scan-2-line text-emerald-400"></i>
                </button>
              </div>
            </div>

            <!-- Descri√ß√£o -->
            <div class="md:col-span-2">
              <label class="block text-[11px] text-slate-300 mb-1">Descri√ß√£o</label>
              <input id="descricaoInput" required
                class="w-full px-3 py-2 rounded-xl bg-slate-800 border border-slate-700 focus:outline-none focus:ring-2 focus:ring-emerald-500 text-xs" />
            </div>

            <!-- Lote -->
            <div>
              <label class="block text-[11px] text-slate-300 mb-1">Lote</label>
              <input id="loteInput"
                class="w-full px-3 py-2 rounded-xl bg-slate-800 border border-slate-700 text-xs" />
            </div>

            <!-- Quantidade -->
            <div>
              <label class="block text-[11px] text-slate-300 mb-1">Quantidade</label>
              <input id="quantidadeInput" type="number" min="1" required
                class="w-full px-3 py-2 rounded-xl bg-slate-800 border border-slate-700 focus:outline-none focus:ring-2 focus:ring-emerald-500 text-xs" />
            </div>

            <!-- Validade -->
            <div>
              <label class="block text-[11px] text-slate-300 mb-1">Validade</label>
              <input id="validadeInput" type="date" required
                class="w-full px-3 py-2 rounded-xl bg-slate-800 border border-slate-700 focus:outline-none focus:ring-2 focus:ring-emerald-500 text-xs" />
            </div>

            <!-- Observa√ß√£o -->
            <div class="md:col-span-4">
              <label class="block text-[11px] text-slate-300 mb-1">Observa√ß√£o</label>
              <textarea id="observacaoInput" rows="2"
                class="w-full px-3 py-2 rounded-xl bg-slate-800 border border-slate-700 text-xs"></textarea>
            </div>

            <div class="md:col-span-4 flex justify-end mt-2">
              <button type="submit"
                class="px-4 py-2 rounded-xl bg-emerald-500 hover:bg-emerald-400 text-slate-900 font-semibold text-xs flex items-center gap-2">
                <i class="ri-save-3-line"></i> Salvar item
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- ITENS CADASTRADOS -->
      <div id="itensTab" class="tab-panel hidden space-y-4">
        <div class="bg-slate-900/80 border border-slate-700 rounded-2xl p-4 space-y-4">
          <div class="flex flex-wrap gap-3 items-center justify-between">
            <div>
              <h2 class="text-sm font-semibold flex items-center gap-2">
                <i class="ri-database-2-line text-emerald-400"></i> Itens cadastrados
              </h2>
              <p class="text-[11px] text-slate-400">
                Filtros por status de vencimento e controle de oferta.
              </p>
            </div>

            <div class="flex flex-wrap gap-2 text-[11px]">
              <select id="statusFilter"
                class="px-3 py-1.5 rounded-xl bg-slate-800 border border-slate-700">
                <option value="todos">Todos</option>
                <option value="7">Vence em at√© 7 dias</option>
                <option value="15">Vence em at√© 15 dias</option>
                <option value="30">Vence em at√© 30 dias</option>
                <option value="vencidos">Vencidos</option>
              </select>

              <select id="departamentoFilter"
                class="px-3 py-1.5 rounded-xl bg-slate-800 border border-slate-700">
                <option value="todos">Todos departamentos</option>
                <option>A√ßougue</option>
                <option>Adega</option>
                <option>Bebidas</option>
                <option>Mercearia Alimentos</option>
                <option>Mercearia N√£o Alimentos</option>
                <option>Perec√≠veis Processados</option>
              </select>

              <button id="excelBtn"
                class="px-3 py-1.5 rounded-xl bg-emerald-500 hover:bg-emerald-400 text-slate-900 font-semibold flex items-center gap-1">
                <i class="ri-file-excel-2-line"></i> Excel
              </button>

              <button id="pdfBtn"
                class="px-3 py-1.5 rounded-xl bg-slate-700 hover:bg-slate-600 text-slate-100 font-semibold flex items-center gap-1">
                <i class="ri-file-pdf-2-line text-red-400"></i> PDF
              </button>
            </div>
          </div>

          <div class="flex items-center justify-between mb-2 text-[11px]">
            <div class="flex items-center gap-2">
              <button id="ofertaToggleAllBtn"
                class="px-3 py-1.5 rounded-xl bg-slate-700 hover:bg-slate-600 flex items-center gap-1">
                <i class="ri-megaphone-line text-amber-300"></i> Marcar todos como oferta
              </button>
            </div>
            <div id="totalItensInfo" class="text-slate-400"></div>
          </div>

          <div class="overflow-x-auto border border-slate-800 rounded-xl">
            <table class="min-w-full text-[11px]" id="itensTable">
              <thead class="bg-slate-800/80">
                <tr>
                  <th class="px-2 py-2 text-left">Loja</th>
                  <th class="px-2 py-2 text-left">Data lan√ßamento</th>
                  <th class="px-2 py-2 text-left">Departamento</th>
                  <th class="px-2 py-2 text-left">C√≥d. barras</th>
                  <th class="px-2 py-2 text-left">Descri√ß√£o</th>
                  <th class="px-2 py-2 text-right">Qtd</th>
                  <th class="px-2 py-2 text-left">Validade</th>
                  <th class="px-2 py-2 text-left">Status</th>
                  <th class="px-2 py-2 text-left">Oferta</th>
                  <th class="px-2 py-2 text-left">Flag</th>
                  <th class="px-2 py-2 text-left">Lote</th>
                  <th class="px-2 py-2 text-left">Usu√°rio</th>
                  <th class="px-2 py-2 text-left">Lan√ßado em</th>
                  <th class="px-2 py-2 text-left">Obs.</th>
                  <th class="px-2 py-2 text-right">A√ß√µes</th>
                </tr>
              </thead>
              <tbody id="itensTbody" class="divide-y divide-slate-800">
              </tbody>
            </table>
          </div>

          <p id="semItensMsg" class="text-[11px] text-slate-400 mt-2 hidden">
            Nenhum item encontrado com os filtros atuais.
          </p>
        </div>
      </div>
    </section>

    <!-- Modal leitor c√≥digo de barras -->
    <div id="barcodeModal"
      class="fixed inset-0 bg-black/60 flex items-center justify-center z-30 hidden">
      <div class="bg-slate-900 border border-slate-700 rounded-2xl p-4 w-full max-w-sm">
        <div class="flex items-center justify-between mb-2">
          <h3 class="text-sm font-semibold flex items-center gap-1">
            <i class="ri-qr-scan-2-line text-emerald-400"></i> Leitor de c√≥digo de barras
          </h3>
          <button id="closeBarcodeModal" class="text-slate-400 text-lg">
            <i class="ri-close-line"></i>
          </button>
        </div>
        <p class="text-[11px] text-slate-400 mb-2">
          Aponte a c√¢mera para o c√≥digo de barras. Ao ler, o c√≥digo ser√° preenchido automaticamente.
        </p>
        <div id="barcodeReader" class="w-full"></div>
      </div>
    </div>

  </main>

  <!-- Firebase + App -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import {
      getAuth,
      signInWithEmailAndPassword,
      signInWithPopup,
      GoogleAuthProvider,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
    import {
      getFirestore,
      collection,
      addDoc,
      getDocs,
      getDoc,
      doc,
      serverTimestamp,
      updateDoc,
      deleteDoc,
      query,
      where,
      orderBy
    } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

    // üî• CONFIG FIREBASE
    const firebaseConfig = {
      apiKey: "AIzaSyDa1z9LwlSHxwSTC974ci9RMEYdEiA_wEg",
      authDomain: "controle-validade-fc108.firebaseapp.com",
      projectId: "controle-validade-fc108",
      storageBucket: "controle-validade-fc108.firebasestorage.app",
      messagingSenderId: "737065688686",
      appId: "1:737065688686:web:ed3e602baf64c1fb4f907f",
      measurementId: "G-VJ8DMM47EN"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const googleProvider = new GoogleAuthProvider();

    // üîê Estado global
    let currentUser = null;
    let currentRole = null; // admin | gerente | repositor
    let currentLoja = null;
    let html5QrCode = null;

    // ‚è±Ô∏è data hoje travada no cadastro
    const dataLancamentoInput = document.getElementById("dataLancamentoInput");
    const hoje = new Date();
    const pad = (n) => (n < 10 ? "0" + n : n);
    const dataHojeStr =
      pad(hoje.getDate()) + "/" + pad(hoje.getMonth() + 1) + "/" + hoje.getFullYear();
    dataLancamentoInput.value = dataHojeStr;

    // ------------------ LOGIN ------------------ //
    const loginSection = document.getElementById("loginSection");
    const appSection = document.getElementById("appSection");
    const loginForm = document.getElementById("loginForm");
    const loginError = document.getElementById("loginError");
    const googleLoginBtn = document.getElementById("googleLoginBtn");
    const userInfo = document.getElementById("userInfo");
    const userNameEl = document.getElementById("userName");
    const userRoleEl = document.getElementById("userRole");
    const logoutBtn = document.getElementById("logoutBtn");

    // üîë BUSCAR PERFIL (com override para compras.3076@gmail.com)
    async function fetchUserRole(user) {
      try {
        // ‚úÖ Override direto: esse e-mail SEMPRE √© admin
        if (user.email === "compras.3076@gmail.com") {
          currentRole = "admin";
          currentLoja = "Compras";
          return;
        }

        // 1) tenta pelo UID
        let data = null;
        const uidRef = doc(db, "users", user.uid);
        const uidSnap = await getDoc(uidRef);
        if (uidSnap.exists()) {
          data = uidSnap.data();
        } else {
          // 2) tenta por e-mail
          const qRef = query(
            collection(db, "users"),
            where("email", "==", user.email)
          );
          const qSnap = await getDocs(qRef);
          if (!qSnap.empty) {
            data = qSnap.docs[0].data();
          }
        }

        if (data) {
          currentRole =
            data.role || data.perfil || data.tipo || "repositor";
          currentLoja = data.loja || null;
        } else {
          currentRole = "repositor";
          currentLoja = null;
        }
      } catch (err) {
        console.error("Erro ao buscar perfil:", err);
        currentRole = "repositor";
        currentLoja = null;
      }
    }

    function updateUIAuth() {
      if (currentUser) {
        loginSection.classList.add("hidden");
        appSection.classList.remove("hidden");
        userInfo.classList.remove("hidden");
        userNameEl.textContent = currentUser.displayName || currentUser.email;
        userRoleEl.textContent = currentRole
          ? `Perfil: ${currentRole}${currentLoja ? " ‚Ä¢ " + currentLoja : ""}`
          : "Perfil: n√£o definido";
        loadItens();
      } else {
        loginSection.classList.remove("hidden");
        appSection.classList.add("hidden");
        userInfo.classList.add("hidden");
      }
    }

    loginForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      loginError.classList.add("hidden");
      const email = document.getElementById("emailInput").value.trim();
      const password = document.getElementById("passwordInput").value.trim();
      try {
        const cred = await signInWithEmailAndPassword(auth, email, password);
        await fetchUserRole(cred.user);
      } catch (err) {
        console.error(err);
        loginError.textContent = "Erro ao entrar. Verifique e-mail/senha.";
        loginError.classList.remove("hidden");
      }
    });

    googleLoginBtn.addEventListener("click", async () => {
      loginError.classList.add("hidden");
      try {
        const result = await signInWithPopup(auth, googleProvider);
        await fetchUserRole(result.user);
      } catch (err) {
        console.error(err);
        loginError.textContent = "Erro ao entrar com Google.";
        loginError.classList.remove("hidden");
      }
    });

    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
    });

    onAuthStateChanged(auth, async (user) => {
      currentUser = user;
      if (user) {
        await fetchUserRole(user);
      }
      updateUIAuth();
    });

    // ------------------ ABAS ------------------ //
    const tabButtons = document.querySelectorAll(".tab-btn");
    const tabPanels = document.querySelectorAll(".tab-panel");
    tabButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const tabId = btn.dataset.tab;
        tabButtons.forEach((b) =>
          b.classList.toggle("bg-emerald-500", b === btn)
        );
        tabButtons.forEach((b) =>
          b.classList.toggle("text-slate-900", b === btn)
        );
        tabButtons.forEach((b) =>
          b.classList.toggle("bg-slate-800", b !== btn)
        );
        tabPanels.forEach((panel) => {
          panel.classList.toggle("hidden", panel.id !== tabId);
        });
      });
    });

    // ------------------ CADASTRO ------------------ //
    const cadastroForm = document.getElementById("cadastroForm");
    const lojaSelect = document.getElementById("lojaSelect");
    const departamentoSelect = document.getElementById("departamentoSelect");
    const codigoBarrasInput = document.getElementById("codigoBarrasInput");
    const descricaoInput = document.getElementById("descricaoInput");
    const loteInput = document.getElementById("loteInput");
    const quantidadeInput = document.getElementById("quantidadeInput");
    const validadeInput = document.getElementById("validadeInput");
    const observacaoInput = document.getElementById("observacaoInput");

    cadastroForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!currentUser) return;

      const codigo = codigoBarrasInput.value.trim();
      if (!/^[0-9]{1,13}$/.test(codigo)) {
        alert("C√≥digo de barras deve ter apenas n√∫meros e no m√°ximo 13 d√≠gitos.");
        return;
      }

      try {
        await addDoc(collection(db, "validadeItens"), {
          loja: lojaSelect.value,
          dataLancamentoTexto: dataLancamentoInput.value,
          departamento: departamentoSelect.value,
          codigoBarras: codigo,
          descricao: descricaoInput.value.trim(),
          lote: loteInput.value.trim(),
          quantidade: Number(quantidadeInput.value),
          validade: validadeInput.value,
          observacao: observacaoInput.value.trim(),
          createdAt: serverTimestamp(),
          createdByUid: currentUser.uid,
          createdByName: currentUser.displayName || currentUser.email,
          ofertaStatus: "N√£o lan√ßado"
        });

        cadastroForm.reset();
        dataLancamentoInput.value = dataHojeStr;
        alert("Item cadastrado com sucesso!");
        loadItens();
      } catch (err) {
        console.error(err);
        alert("Erro ao salvar item.");
      }
    });

    // ------------------ LISTAGEM / FILTROS ------------------ //
    const statusFilter = document.getElementById("statusFilter");
    const departamentoFilter = document.getElementById("departamentoFilter");
    const itensTbody = document.getElementById("itensTbody");
    const semItensMsg = document.getElementById("semItensMsg");
    const totalItensInfo = document.getElementById("totalItensInfo");

    statusFilter.addEventListener("change", loadItens);
    departamentoFilter.addEventListener("change", loadItens);

    function calcStatus(validadeStr) {
      const hoje = new Date();
      const validade = new Date(validadeStr + "T00:00:00");
      const diffMs = validade.getTime() - hoje.getTime();
      const diffDias = Math.floor(diffMs / (1000 * 60 * 60 * 24));

      if (diffDias < 0) return { label: "Vencido", tipo: "vencidos" };
      if (diffDias <= 7) return { label: `Vence em ${diffDias} dia(s)`, tipo: "7" };
      if (diffDias <= 15) return { label: `Vence em ${diffDias} dia(s)`, tipo: "15" };
      if (diffDias <= 30) return { label: `Vence em ${diffDias} dia(s)`, tipo: "30" };
      return { label: `> 30 dias`, tipo: "ok" };
    }

    function statusClass(tipo) {
      switch (tipo) {
        case "vencidos":
          return "bg-red-500/20 text-red-200 border border-red-400/60";
        case "7":
          return "bg-rose-500/20 text-rose-100 border border-rose-400/60";
        case "15":
          return "bg-amber-500/20 text-amber-100 border border-amber-400/60";
        case "30":
          return "bg-yellow-500/20 text-yellow-100 border border-yellow-400/60";
        default:
          return "bg-emerald-500/20 text-emerald-100 border border-emerald-400/60";
      }
    }

    function ofertaClass(status) {
      return status === "Lan√ßado"
        ? "bg-emerald-500/20 text-emerald-100 border border-emerald-400/60"
        : "bg-slate-600/30 text-slate-200 border border-slate-500/80";
    }

    async function loadItens() {
      if (!currentUser) return;

      let qRef = query(collection(db, "validadeItens"), orderBy("validade", "asc"));
      if (currentRole === "gerente" && currentLoja) {
        qRef = query(
          collection(db, "validadeItens"),
          where("loja", "==", currentLoja),
          orderBy("validade", "asc")
        );
      }
      if (currentRole === "repositor" && currentLoja) {
        qRef = query(
          collection(db, "validadeItens"),
          where("loja", "==", currentLoja),
          where("createdByUid", "==", currentUser.uid),
          orderBy("validade", "asc")
        );
      }

      const snap = await getDocs(qRef);
      itensTbody.innerHTML = "";
      let total = 0;

      const statusFiltro = statusFilter.value;
      const depFiltro = departamentoFilter.value;

      snap.forEach((docSnap) => {
        const d = docSnap.data();
        const st = calcStatus(d.validade);
        if (statusFiltro !== "todos" && st.tipo !== statusFiltro) return;
        if (depFiltro !== "todos" && d.departamento !== depFiltro) return;

        total++;

        const ofertaStatus = d.ofertaStatus || "N√£o lan√ßado";

        const tr = document.createElement("tr");
        tr.className = "hover:bg-slate-800/60";

        // diff para controle de edi√ß√£o (24h)
        let podeEditar = currentRole === "admin";
        if (!podeEditar && currentRole === "repositor" && d.createdAt) {
          const created = d.createdAt.toDate ? d.createdAt.toDate() : new Date(d.createdAt);
          const diffHoras = (Date.now() - created.getTime()) / (1000 * 60 * 60);
          if (diffHoras <= 24) podeEditar = true;
        }
        if (!podeEditar && currentRole === "gerente") {
          podeEditar = true;
        }

        const podeExcluir = currentRole === "admin";

        const criadoEmTexto = d.createdAt?.toDate
          ? formatDateTime(d.createdAt.toDate())
          : "";

        tr.innerHTML = `
          <td class="px-2 py-1.5">${d.loja || ""}</td>
          <td class="px-2 py-1.5 whitespace-nowrap">${d.dataLancamentoTexto || ""}</td>
          <td class="px-2 py-1.5">${d.departamento || ""}</td>
          <td class="px-2 py-1.5 whitespace-nowrap">${d.codigoBarras || ""}</td>
          <td class="px-2 py-1.5">${d.descricao || ""}</td>
          <td class="px-2 py-1.5 text-right">${d.quantidade || ""}</td>
          <td class="px-2 py-1.5 whitespace-nowrap">${formatDate(d.validade)}</td>
          <td class="px-2 py-1.5">
            <span class="tag ${statusClass(st.tipo)}">${st.label}</span>
          </td>
          <td class="px-2 py-1.5">
            <span class="tag oferta-tag ${ofertaClass(ofertaStatus)}">${ofertaStatus}</span>
          </td>
          <td class="px-2 py-1.5 text-center">
            <input type="checkbox" class="oferta-toggle" ${ofertaStatus === "Lan√ßado" ? "checked" : ""} />
          </td>
          <td class="px-2 py-1.5">${d.lote || ""}</td>
          <td class="px-2 py-1.5 whitespace-nowrap">${d.createdByName || ""}</td>
          <td class="px-2 py-1.5 whitespace-nowrap">${criadoEmTexto}</td>
          <td class="px-2 py-1.5 max-w-[180px] truncate" title="${d.observacao || ""}">
            ${d.observacao || ""}
          </td>
          <td class="px-2 py-1.5 text-right">
            ${
              podeEditar
                ? `<button class="text-xs text-amber-300 hover:text-amber-200 mr-2 editar-btn">Editar</button>`
                : ""
            }
            ${
              podeExcluir
                ? `<button class="text-xs text-red-400 hover:text-red-300 excluir-btn">Excluir</button>`
                : ""
            }
          </td>
        `;

        const ofertaCheckbox = tr.querySelector(".oferta-toggle");
        const ofertaTag = tr.querySelector(".oferta-tag");
        ofertaCheckbox.addEventListener("change", async () => {
          const novoStatus = ofertaCheckbox.checked ? "Lan√ßado" : "N√£o lan√ßado";
          ofertaTag.textContent = novoStatus;
          ofertaTag.className = "tag oferta-tag " + ofertaClass(novoStatus);
          await updateDoc(doc(db, "validadeItens", docSnap.id), {
            ofertaStatus: novoStatus
          });
        });

        const excluirBtn = tr.querySelector(".excluir-btn");
        if (excluirBtn) {
          excluirBtn.addEventListener("click", async () => {
            if (!confirm("Tem certeza que deseja excluir este item?")) return;
            await deleteDoc(doc(db, "validadeItens", docSnap.id));
            loadItens();
          });
        }

        const editarBtn = tr.querySelector(".editar-btn");
        if (editarBtn) {
          editarBtn.addEventListener("click", () => {
            lojaSelect.value = d.loja || "";
            departamentoSelect.value = d.departamento || "";
            codigoBarrasInput.value = d.codigoBarras || "";
            descricaoInput.value = d.descricao || "";
            loteInput.value = d.lote || "";
            quantidadeInput.value = d.quantidade || "";
            validadeInput.value = d.validade || "";
            observacaoInput.value = d.observacao || "";
            window.scrollTo({ top: 0, behavior: "smooth" });
            alert("Edite os campos e salve como um novo lan√ßamento. (Edi√ß√£o direta est√° simplificada.)");
          });
        }

        itensTbody.appendChild(tr);
      });

      semItensMsg.classList.toggle("hidden", total > 0);
      totalItensInfo.textContent = `Total de itens: ${total}`;
    }

    function formatDate(dateStr) {
      if (!dateStr) return "";
      const d = new Date(dateStr + "T00:00:00");
      const pad = (n) => (n < 10 ? "0" + n : n);
      return pad(d.getDate()) + "/" + pad(d.getMonth() + 1) + "/" + d.getFullYear();
    }

    function formatDateTime(date) {
      const pad = (n) => (n < 10 ? "0" + n : n);
      return (
        pad(date.getDate()) +
        "/" +
        pad(date.getMonth() + 1) +
        "/" +
        date.getFullYear() +
        " " +
        pad(date.getHours()) +
        ":" +
        pad(date.getMinutes())
      );
    }

    // ------------------ EXCEL / PDF ------------------ //
    const excelBtn = document.getElementById("excelBtn");
    const pdfBtn = document.getElementById("pdfBtn");

    excelBtn.addEventListener("click", () => {
      const table = document.getElementById("itensTable");
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.table_to_sheet(table);
      XLSX.utils.book_append_sheet(wb, ws, "Itens");
      XLSX.writeFile(wb, "controle-validade.xlsx");
    });

    pdfBtn.addEventListener("click", () => {
      const { jsPDF } = window.jspdf;
      const docPdf = new jsPDF("l", "pt", "a4");

      docPdf.setFontSize(14);
      docPdf.text("Controle de Validade - Itens Cadastrados", 40, 40);

      const head = [
        [
          "Loja",
          "Data lan√ßamento",
          "Depto.",
          "C√≥d. barras",
          "Descri√ß√£o",
          "Qtd",
          "Validade",
          "Status",
          "Oferta",
          "Lote",
          "Usu√°rio",
          "Lan√ßado em",
          "Obs."
        ]
      ];

      const body = [];
      document.querySelectorAll("#itensTbody tr").forEach((tr) => {
        const tds = tr.querySelectorAll("td");
        if (!tds.length) return;
        body.push([
          tds[0].innerText,
          tds[1].innerText,
          tds[2].innerText,
          tds[3].innerText,
          tds[4].innerText,
          tds[5].innerText,
          tds[6].innerText,
          tds[7].innerText,
          tds[8].innerText,
          tds[10].innerText,
          tds[11].innerText,
          tds[12].innerText,
          tds[13].innerText
        ]);
      });

      docPdf.autoTable({
        head,
        body,
        startY: 60,
        styles: { fontSize: 7, cellPadding: 3 },
        headStyles: { fillColor: [15, 23, 42], textColor: [248, 250, 252] },
        alternateRowStyles: { fillColor: [30, 41, 59] },
        bodyStyles: { textColor: [15, 23, 42] }
      });

      docPdf.save("controle-validade.pdf");
    });

    // ------------------ OFERTA: SELECIONAR TODOS ------------------ //
    const ofertaToggleAllBtn = document.getElementById("ofertaToggleAllBtn");
    ofertaToggleAllBtn.addEventListener("click", async () => {
      const checkboxes = document.querySelectorAll(".oferta-toggle");
      if (!checkboxes.length) return;

      const marcarComoLancado = Array.from(checkboxes).some((c) => !c.checked);
      const novoStatus = marcarComoLancado ? "Lan√ßado" : "N√£o lan√ßado";

      const snap = await getDocs(collection(db, "validadeItens"));
      const updates = [];
      snap.forEach((docSnap) => {
        updates.push(
          updateDoc(doc(db, "validadeItens", docSnap.id), { ofertaStatus: novoStatus })
        );
      });
      await Promise.all(updates);
      loadItens();
    });

    // ------------------ LEITOR C√ìDIGO DE BARRAS ------------------ //
    const barcodeModal = document.getElementById("barcodeModal");
    const barcodeReaderDiv = document.getElementById("barcodeReader");
    const scanButton = document.getElementById("scanButton");
    const closeBarcodeModal = document.getElementById("closeBarcodeModal");

    scanButton.addEventListener("click", () => {
      if (typeof Html5Qrcode === "undefined") {
        alert("Leitor de c√≥digo de barras n√£o carregou corretamente. Verifique sua internet.");
        return;
      }
      openBarcodeModal();
    });

    closeBarcodeModal.addEventListener("click", closeBarcode);

    function openBarcodeModal() {
      barcodeModal.classList.remove("hidden");

      if (html5QrCode) {
        return;
      }

      html5QrCode = new Html5Qrcode("barcodeReader");
      Html5Qrcode.getCameras()
        .then((devices) => {
          if (!devices || !devices.length) {
            alert("Nenhuma c√¢mera encontrada.");
            return;
          }
          const cameraId = devices[0].id;
          html5QrCode.start(
            cameraId,
            { fps: 10, qrbox: 250 },
            (decodedText) => {
              codigoBarrasInput.value = decodedText.replace(/\D/g, "").slice(0, 13);
              closeBarcode();
            },
            (errorMessage) => {
              console.log(errorMessage);
            }
          );
        })
        .catch((err) => {
          console.error(err);
          alert("Erro ao acessar a c√¢mera.");
        });
    }

    function closeBarcode() {
      barcodeModal.classList.add("hidden");
      if (html5QrCode) {
        html5QrCode
          .stop()
          .then(() => {
            html5QrCode.clear();
            html5QrCode = null;
          })
          .catch((err) => console.error(err));
      }
    }
  </script>
</body>
</html>
