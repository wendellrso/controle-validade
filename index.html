<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Controle de Validade - Palato</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Paleta Palato: fundo preto, texto branco, detalhes em vermelho -->
  <style>
    :root {
      --bg-main: #050608;
      --bg-card: #10121a;
      --bg-card-soft: #151824;
      --border-soft: #242838;
      --accent-red: #e30613;
      --accent-green: #2ecc71;
      --accent-yellow: #f1c40f;
      --accent-badge: #b33939;
      --text-main: #ffffff;
      --text-muted: #a0a4b8;
      --input-bg: #0f1119;
      --input-border: #2b3045;
      --pill-bg: #1e2233;
      --pill-offer-bg: #1f2833;
      --danger: #e74c3c;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      background: radial-gradient(circle at top, #151821 0, #050608 60%);
      color: var(--text-main);
      min-height: 100vh;
    }

    .hidden { display: none !important; }

    /* HEADER */

    header.app-header {
      height: 64px;
      background: #000000;
      border-bottom: 1px solid #1d202b;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 24px;
    }

    .app-header-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .logo-box {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-box img {
      height: 28px;
      object-fit: contain;
    }

    .app-title {
      display: flex;
      flex-direction: column;
    }

    .app-title-main {
      font-weight: 600;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      font-size: 15px;
    }

    .app-title-sub {
      font-size: 12px;
      color: var(--text-muted);
    }

    .app-header-right {
      display: flex;
      align-items: center;
      gap: 16px;
      font-size: 13px;
    }

    .user-name {
      font-weight: 500;
    }

    .user-role {
      color: var(--accent-yellow);
      font-size: 11px;
    }

    .btn-text-danger {
      color: var(--danger);
      cursor: pointer;
      font-size: 13px;
    }

    .btn-text-danger:hover {
      text-decoration: underline;
    }

    /* LAYOUT GERAL */

    .app-wrapper {
      display: flex;
      min-height: calc(100vh - 64px);
    }

    .sidebar {
      width: 230px;
      background: #050608;
      border-right: 1px solid #151823;
      padding: 24px 16px;
    }

    .sidebar h3 {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      margin-bottom: 12px;
    }

    .nav-list {
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .nav-item {
      padding: 10px 12px;
      border-radius: 999px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text-muted);
      font-size: 13px;
    }

    .nav-item span.icon {
      width: 18px;
      text-align: center;
      font-size: 14px;
    }

    .nav-item.active {
      background: var(--accent-red);
      color: #ffffff;
    }

    .nav-item:not(.active):hover {
      background: #11131e;
      color: var(--text-main);
    }

    .content {
      flex: 1;
      padding: 24px 24px 40px;
      overflow-x: auto;
    }

    /* CARDS / SECTIONS */

    .section-row {
      display: grid;
      grid-template-columns: minmax(320px, 380px) minmax(0, 1fr);
      gap: 24px;
      align-items: flex-start;
    }

    .card {
      background: var(--bg-card);
      border-radius: 18px;
      border: 1px solid var(--border-soft);
      padding: 18px 20px 20px;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.45);
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .card-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 15px;
      font-weight: 600;
    }

    .card-title span.icon {
      width: 20px;
      height: 20px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: rgba(227, 6, 19, 0.12);
      color: var(--accent-red);
      font-size: 12px;
    }

    .card-subtitle {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 10px;
    }

    /* FORM */

    .form-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
      margin-top: 4px;
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }

    label {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 4px;
      display: block;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .field {
      display: flex;
      flex-direction: column;
    }

    input[type="text"],
    input[type="number"],
    input[type="password"],
    input[type="email"],
    input[type="date"],
    select,
    textarea {
      background: var(--input-bg);
      border-radius: 999px;
      border: 1px solid var(--input-border);
      color: var(--text-main);
      padding: 8px 12px;
      font-size: 13px;
      outline: none;
    }

    select,
    select option {
      background-color: var(--input-bg);
      color: var(--text-main);
    }

    textarea {
      border-radius: 14px;
      resize: vertical;
      min-height: 68px;
    }

    input:focus,
    select:focus,
    textarea:focus {
      border-color: var(--accent-red);
      box-shadow: 0 0 0 1px rgba(227, 6, 19, 0.4);
    }

    .input-with-icon {
      position: relative;
    }

    .input-with-icon button {
      position: absolute;
      right: 6px;
      top: 50%;
      transform: translateY(-50%);
      border: none;
      background: #202538;
      color: var(--text-main);
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 11px;
      cursor: pointer;
    }

    .input-with-icon button:hover {
      background: var(--accent-red);
    }

    .btn-main {
      margin-top: 12px;
      width: 100%;
      border-radius: 999px;
      border: none;
      padding: 10px 14px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      background: linear-gradient(90deg, var(--accent-red), #ff4b5c);
      color: #fff;
      box-shadow: 0 10px 22px rgba(227, 6, 19, 0.4);
    }

    .btn-main:hover {
      filter: brightness(1.05);
    }

    /* TABLE */

    .table-header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .badge-muted {
      background: #1a1d28;
      color: var(--text-muted);
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 11px;
    }

    .btn-pill {
      border-radius: 999px;
      border: none;
      padding: 8px 12px;
      font-size: 12px;
      cursor: pointer;
      background: #1b1f2b;
      color: var(--accent-yellow);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn-pill:hover {
      background: #23283a;
    }

    .btn-pill svg {
      width: 14px;
      height: 14px;
    }

    .btn-export {
      border-radius: 999px;
      border: none;
      padding: 8px 12px;
      font-size: 12px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #102713;
      color: #aef6b3;
    }

    .btn-export.pdf {
      background: #2d1515;
      color: #ffb1b1;
      margin-left: 8px;
    }

    .btn-export:hover {
      filter: brightness(1.05);
    }

    .filters-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .filters-row select {
      min-width: 160px;
    }

    .table-wrapper {
      border-radius: 16px;
      border: 1px solid var(--border-soft);
      overflow: hidden;
      background: var(--bg-card-soft);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    thead {
      background: #191d29;
    }

    th, td {
      padding: 8px 10px;
      border-bottom: 1px solid #151823;
      white-space: nowrap;
    }

    th {
      text-align: left;
      font-weight: 500;
      color: var(--text-muted);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    tbody tr:hover {
      background: rgba(255, 255, 255, 0.02);
    }

    .badge-status {
      display: inline-flex;
      border-radius: 999px;
      padding: 3px 10px;
      font-size: 11px;
      background: var(--accent-badge);
      color: #ffe6e6;
    }

    .badge-status.vencido {
      background: #6c1c1c;
      color: #ffd1d1;
    }

    .badge-status.curto {
      background: #9b2c2c;
    }

    .badge-status.medio {
      background: #9b6b2c;
    }

    .badge-status.longo {
      background: #2c7a4b;
    }

    .badge-oferta {
      display: inline-flex;
      border-radius: 999px;
      padding: 3px 10px;
      font-size: 11px;
      background: var(--pill-offer-bg);
      color: #d7dfff;
    }

    .badge-oferta.lancado {
      background: #14301b;
      color: #aef6b3;
    }

    .table-actions a {
      color: #f5d76e;
      font-size: 11px;
      cursor: pointer;
      margin-right: 8px;
    }

    .table-actions a.delete {
      color: #ff8a8a;
    }

    .table-footer {
      padding: 6px 10px;
      font-size: 11px;
      color: var(--text-muted);
      text-align: right;
      background: #141724;
    }

    /* ADMIN USU√ÅRIOS */

    .users-table-wrapper {
      margin-top: 8px;
    }

    .btn-outline {
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      padding: 6px 10px;
      font-size: 12px;
      background: transparent;
      color: var(--text-muted);
      cursor: pointer;
    }

    .btn-outline:hover {
      border-color: var(--accent-red);
      color: var(--text-main);
    }

    /* LOGIN */

    .login-wrapper {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at top, #202331 0, #050608 60%);
    }

    .login-card {
      width: 100%;
      max-width: 420px;
      background: #050608;
      border-radius: 20px;
      padding: 24px 26px 26px;
      border: 1px solid #1d2030;
      box-shadow: 0 24px 50px rgba(0, 0, 0, 0.9);
    }

    .login-logo {
      text-align: center;
      margin-bottom: 10px;
    }

    .login-logo img {
      height: 34px;
    }

    .login-title {
      text-align: center;
      margin-bottom: 4px;
      font-weight: 600;
      font-size: 18px;
    }

    .login-sub {
      text-align: center;
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 18px;
    }

    .login-divider {
      text-align: center;
      margin: 12px 0;
      font-size: 11px;
      color: var(--text-muted);
      position: relative;
    }

    .login-divider::before,
    .login-divider::after {
      content: "";
      position: absolute;
      top: 50%;
      width: 38%;
      height: 1px;
      background: #1b1e2a;
    }

    .login-divider::before {
      left: 0;
    }

    .login-divider::after {
      right: 0;
    }

    .btn-google {
      width: 100%;
      border-radius: 999px;
      border: 1px solid #2b3040;
      padding: 9px 12px;
      background: #10121a;
      color: #f5f5f5;
      font-size: 13px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-bottom: 10px;
    }

    .btn-google img {
      width: 16px;
      height: 16px;
    }

    .btn-google:hover {
      border-color: var(--accent-red);
    }

    .login-footer {
      margin-top: 10px;
      font-size: 11px;
      color: var(--text-muted);
      text-align: center;
    }

    .scanner-modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.85);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    .scanner-box {
      width: min(420px, 96vw);
      background: #050608;
      border-radius: 18px;
      border: 1px solid #2b3045;
      padding: 14px 14px 18px;
    }

    .scanner-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
      font-size: 13px;
    }

    .scanner-close {
      background: transparent;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 13px;
    }

    .scanner-close:hover {
      color: var(--accent-red);
    }

    #reader {
      width: 100%;
      background: #000;
      border-radius: 12px;
      overflow: hidden;
    }

    @media (max-width: 1024px) {
      .section-row {
        grid-template-columns: 1fr;
      }
      .sidebar {
        display: none;
      }
      .content {
        padding: 16px;
      }
    }
  </style>
</head>
<body>

<!-- LOGIN -->
<div id="loginView" class="login-wrapper">
  <div class="login-card">
    <div class="login-logo">
      <!-- Substitua o src pelo caminho da logo do Palato no seu repo -->
      <img src="palato-logo.png" alt="Palato" />
    </div>
    <div class="login-title">Controle de Validade</div>
    <div class="login-sub">Acesso restrito a colaboradores autorizados.</div>

    <button id="btnGoogle" class="btn-google">
      <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="">
      Entrar com Google
    </button>

    <div class="login-divider">ou acessar com e-mail corporativo</div>

    <div class="form-grid">
      <div class="field">
        <label for="loginEmail">E-mail *</label>
        <input id="loginEmail" type="email" placeholder="seu.email@palato.com.br" />
      </div>
      <div class="field">
        <label for="loginPassword">Senha *</label>
        <input id="loginPassword" type="password" placeholder="Sua senha" />
      </div>
      <button id="btnLogin" class="btn-main" type="button">Entrar</button>
    </div>

    <div class="login-footer">
      Dica: primeiro acesso via Google cria seu usu√°rio como <b>repositor</b>.
    </div>
  </div>
</div>

<!-- APP -->
<div id="appView" class="hidden">
  <header class="app-header">
    <div class="app-header-left">
      <div class="logo-box">
        <img src="palato-logo.png" alt="Palato" />
        <div class="app-title">
          <span class="app-title-main">Controle de Validade</span>
          <span class="app-title-sub">Multi-loja ¬∑ Lote ¬∑ Ofertas</span>
        </div>
      </div>
    </div>
    <div class="app-header-right">
      <div>
        <div class="user-name" id="headerUserName">Usu√°rio</div>
        <div class="user-role" id="headerUserRole">Perfil</div>
      </div>
      <span class="btn-text-danger" id="btnLogout">Sair</span>
    </div>
  </header>

  <div class="app-wrapper">
    <aside class="sidebar">
      <h3>Menu</h3>
      <ul class="nav-list">
        <li class="nav-item active" data-section="section-main">
          <span class="icon">Ôºã</span> <span>Novo lan√ßamento</span>
        </li>
        <li class="nav-item" data-section="section-main">
          <span class="icon">üìã</span> <span>Itens cadastrados</span>
        </li>
        <li class="nav-item" id="nav-admin" data-section="section-admin">
          <span class="icon">‚öôÔ∏è</span> <span>Gerenciar usu√°rios</span>
        </li>
      </ul>
    </aside>

    <main class="content">
      <!-- SE√á√ÉO PRINCIPAL (FORM + TABELA) -->
      <section id="section-main" class="section-row">
        <!-- FORM -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <span class="icon">Ôºã</span>
              <span>Novo lan√ßamento</span>
            </div>
            <span class="badge-muted" id="labelCadastroRapido">Cadastro r√°pido</span>
          </div>
          <div class="card-subtitle">
            Registrar validade por loja, departamento e lote.
          </div>

          <div class="form-grid">
            <div class="form-row">
              <div class="field">
                <label for="lojaSelect">Loja *</label>
                <select id="lojaSelect">
                  <option value="">Selecione</option>
                  <option>Ponta Verde</option>
                  <option>Farol</option>
                  <option>Praia</option>
                  <option>Riomar</option>
                  <option>CD Farol</option>
                </select>
              </div>
              <div class="field">
                <label for="dataLancamento">Data lan√ßamento</label>
                <input id="dataLancamento" type="text" disabled />
              </div>
            </div>

            <div class="form-row">
              <div class="field">
                <label for="departamentoSelect">Departamento *</label>
                <select id="departamentoSelect">
                  <option value="">Selecione</option>
                  <option>A√ßougue</option>
                  <option>Adega</option>
                  <option>Bebidas</option>
                  <option>Mercearia Alimentos</option>
                  <option>Mercearia N√£o Alimentos</option>
                  <option>Perec√≠veis Processados</option>
                </select>
              </div>
              <div class="field">
                <label for="codigoBarras">C√≥d. barras (n√∫meros, m√°x. 13) *</label>
                <div class="input-with-icon">
                  <input id="codigoBarras" type="text" maxlength="13" placeholder="789..." />
                  <button type="button" id="btnScan">Scan</button>
                </div>
              </div>
            </div>

            <div class="form-row">
              <div class="field">
                <label for="descricao">Descri√ß√£o *</label>
                <input id="descricao" type="text" />
              </div>
              <div class="field">
                <label for="lote">Lote</label>
                <input id="lote" type="text" />
              </div>
            </div>

            <div class="form-row">
              <div class="field">
                <label for="quantidade">Quantidade *</label>
                <input id="quantidade" type="number" min="1" />
              </div>
              <div class="field">
                <label for="validadeInput">Validade *</label>
                <input id="validadeInput" type="date" />
              </div>
            </div>

            <div class="field">
              <label for="observacao">Observa√ß√£o</label>
              <textarea id="observacao" placeholder="Lote em oferta, ponto extra, etc."></textarea>
            </div>

            <button id="btnSalvarLancamento" class="btn-main" type="button">
              üíæ Salvar lan√ßamento
            </button>
          </div>
        </div>

        <!-- TABELA -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <span class="icon">üìã</span>
              <span>Itens cadastrados</span>
            </div>
            <button id="btnMarcarTodosOferta" class="btn-pill" type="button">
              üì¢ Marcar todos como oferta
            </button>
          </div>
          <div class="card-subtitle">
            Filtros por status de vencimento e controle de oferta.
          </div>

          <div class="filters-row">
            <div class="field" style="min-width: 180px;">
              <label for="filtroStatus">Filtros</label>
              <select id="filtroStatus">
                <option value="todos">Todos</option>
                <option value="7">Vence em 7 dias</option>
                <option value="15">Vence em 15 dias</option>
                <option value="30">Vence em 30 dias</option>
                <option value="vencidos">Vencidos</option>
              </select>
            </div>
            <div class="field" style="min-width: 190px;">
              <label for="filtroDepartamento">Departamento</label>
              <select id="filtroDepartamento">
                <option value="todos">Todos departamentos</option>
                <option>A√ßougue</option>
                <option>Adega</option>
                <option>Bebidas</option>
                <option>Mercearia Alimentos</option>
                <option>Mercearia N√£o Alimentos</option>
                <option>Perec√≠veis Processados</option>
              </select>
            </div>

            <div style="margin-left:auto; display:flex; gap:8px; align-items:flex-end;">
              <button id="btnExportExcel" class="btn-export" type="button">
                üìä Excel
              </button>
              <button id="btnExportPdf" class="btn-export pdf" type="button">
                üìÑ PDF
              </button>
            </div>
          </div>

          <div class="table-wrapper">
            <table>
              <thead>
              <tr>
                <th>Loja</th>
                <th>Data lan√ßamento</th>
                <th>Departamento</th>
                <th>C√≥d. barras</th>
                <th>Descri√ß√£o</th>
                <th>Qtd</th>
                <th>Validade</th>
                <th>Status</th>
                <th>Oferta</th>
                <th>Flag</th>
                <th>Lote</th>
                <th>Usu√°rio</th>
                <th>Lan√ßado em</th>
                <th>Obs.</th>
                <th>A√ß√µes</th>
              </tr>
              </thead>
              <tbody id="tbodyItens"></tbody>
            </table>
            <div class="table-footer" id="totalItensLabel">Total de itens: 0</div>
          </div>
        </div>
      </section>

      <!-- SE√á√ÉO ADMIN USU√ÅRIOS -->
      <section id="section-admin" class="hidden">
        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <span class="icon">üõ°</span>
              <span>Administra√ß√£o de usu√°rios</span>
            </div>
            <button id="btnRecarregarUsuarios" class="btn-outline" type="button">
              üîÑ Recarregar
            </button>
          </div>
          <div class="card-subtitle">
            Gerencie perfis (<b>admin</b>, <b>gerente</b>, <b>repositor</b>) e lojas vinculadas.
          </div>

          <div class="form-grid" style="margin-top:14px;">
            <div class="form-row">
              <div class="field">
                <label for="novoUserNome">Nome</label>
                <input id="novoUserNome" type="text" />
              </div>
              <div class="field">
                <label for="novoUserEmail">E-mail</label>
                <input id="novoUserEmail" type="email" />
              </div>
            </div>
            <div class="form-row">
              <div class="field">
                <label for="novoUserTipo">Perfil</label>
                <select id="novoUserTipo">
                  <option value="repositor">Repositor</option>
                  <option value="gerente">Gerente</option>
                  <option value="admin">Admin</option>
                </select>
              </div>
              <div class="field">
                <label for="novoUserLoja">Loja</label>
                <select id="novoUserLoja">
                  <option value="">Nenhuma</option>
                  <option>Ponta Verde</option>
                  <option>Farol</option>
                  <option>Praia</option>
                  <option>Riomar</option>
                  <option>CD Farol</option>
                </select>
              </div>
            </div>
            <button id="btnSalvarUsuario" class="btn-main" type="button">üíæ Salvar usu√°rio</button>
          </div>

          <div class="users-table-wrapper table-wrapper" style="margin-top:16px;">
            <table>
              <thead>
              <tr>
                <th>Nome</th>
                <th>E-mail</th>
                <th>Perfil</th>
                <th>Loja</th>
                <th>A√ß√µes</th>
              </tr>
              </thead>
              <tbody id="tbodyUsuarios"></tbody>
            </table>
          </div>
        </div>
      </section>
    </main>
  </div>
</div>

<!-- MODAL SCANNER -->
<div id="scannerModal" class="scanner-modal hidden">
  <div class="scanner-box">
    <div class="scanner-header">
      <span>Leitor de c√≥digo de barras</span>
      <button class="scanner-close" id="btnFecharScanner">Fechar</button>
    </div>
    <div id="reader"></div>
  </div>
</div>

<!-- LIB HTML5-QRCODE -->
<script src="https://unpkg.com/html5-qrcode"></script>
<!-- SheetJS para Excel -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<!-- jsPDF + autotable para PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<!-- FIREBASE -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
  import {
    getAuth,
    signInWithEmailAndPassword,
    signInWithPopup,
    GoogleAuthProvider,
    onAuthStateChanged,
    signOut
  } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
  import {
    getFirestore,
    collection,
    getDocs,
    addDoc,
    updateDoc,
    deleteDoc,
    doc,
    query,
    where,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

  // === CONFIG FIREBASE (O MESMO QUE VOC√ä COPIOU DO CONSOLE) ===
  const firebaseConfig = {
    apiKey: "AIzaSyDa1z9LwlSHxwSTC974ci9RMEYdEiA_wEg",
    authDomain: "controle-validade-fc108.firebaseapp.com",
    projectId: "controle-validade-fc108",
    storageBucket: "controle-validade-fc108.firebasestorage.app",
    messagingSenderId: "737065688686",
    appId: "1:737065688686:web:ed3e602baf64c1fb4f907f",
    measurementId: "G-VJ8DMM47EN"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const googleProvider = new GoogleAuthProvider();

  // === ELEMENTOS GERAIS ===
  const loginView = document.getElementById('loginView');
  const appView = document.getElementById('appView');
  const headerUserName = document.getElementById('headerUserName');
  const headerUserRole = document.getElementById('headerUserRole');
  const btnLogout = document.getElementById('btnLogout');

  const navItems = document.querySelectorAll('.nav-item');
  const sectionMain = document.getElementById('section-main');
  const sectionAdmin = document.getElementById('section-admin');
  const navAdmin = document.getElementById('nav-admin');

  // Login
  const btnGoogle = document.getElementById('btnGoogle');
  const btnLogin = document.getElementById('btnLogin');
  const loginEmail = document.getElementById('loginEmail');
  const loginPassword = document.getElementById('loginPassword');

  // Form lan√ßamento
  const lojaSelect = document.getElementById('lojaSelect');
  const dataLancamento = document.getElementById('dataLancamento');
  const departamentoSelect = document.getElementById('departamentoSelect');
  const codigoBarras = document.getElementById('codigoBarras');
  const descricao = document.getElementById('descricao');
  const lote = document.getElementById('lote');
  const quantidade = document.getElementById('quantidade');
  const validadeInput = document.getElementById('validadeInput');
  const observacao = document.getElementById('observacao');
  const btnSalvarLancamento = document.getElementById('btnSalvarLancamento');
  const btnScan = document.getElementById('btnScan');

  // Tabela
  const tbodyItens = document.getElementById('tbodyItens');
  const totalItensLabel = document.getElementById('totalItensLabel');
  const filtroStatus = document.getElementById('filtroStatus');
  const filtroDepartamento = document.getElementById('filtroDepartamento');
  const btnExportExcel = document.getElementById('btnExportExcel');
  const btnExportPdf = document.getElementById('btnExportPdf');
  const btnMarcarTodosOferta = document.getElementById('btnMarcarTodosOferta');

  // Admin usu√°rios
  const tbodyUsuarios = document.getElementById('tbodyUsuarios');
  const btnRecarregarUsuarios = document.getElementById('btnRecarregarUsuarios');
  const btnSalvarUsuario = document.getElementById('btnSalvarUsuario');
  const novoUserNome = document.getElementById('novoUserNome');
  const novoUserEmail = document.getElementById('novoUserEmail');
  const novoUserTipo = document.getElementById('novoUserTipo');
  const novoUserLoja = document.getElementById('novoUserLoja');

  // Scanner
  const scannerModal = document.getElementById('scannerModal');
  const btnFecharScanner = document.getElementById('btnFecharScanner');
  let html5QrCode = null;

  // Estado
  let currentUser = null;
  let currentProfile = null; // { email, tipo, loja, nome, docId }
  let currentItens = [];     // array de docs de validade

  // Utils

  function formatDateTimeBR(date) {
    const d = date instanceof Date ? date : new Date(date);
    const pad = (n) => String(n).padStart(2, '0');
    return `${pad(d.getDate())}/${pad(d.getMonth() + 1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }

  function formatDateBR(date) {
    const d = date instanceof Date ? date : new Date(date);
    const pad = (n) => String(n).padStart(2, '0');
    return `${pad(d.getDate())}/${pad(d.getMonth() + 1)}/${d.getFullYear()}`;
  }

  function showAlert(msg) {
    alert(msg);
  }

  function setTodayInForm() {
    const now = new Date();
    dataLancamento.value = formatDateTimeBR(now);
  }

  function setActiveSection(sectionId) {
    sectionMain.classList.add('hidden');
    sectionAdmin.classList.add('hidden');
    if (sectionId === 'section-main') sectionMain.classList.remove('hidden');
    if (sectionId === 'section-admin') sectionAdmin.classList.remove('hidden');

    navItems.forEach(li => li.classList.toggle('active', li.dataset.section === sectionId));
  }

  navItems.forEach(li => {
    li.addEventListener('click', () => {
      const target = li.dataset.section;
      if (target === 'section-admin' && currentProfile?.tipo !== 'admin') return;
      setActiveSection(target);
    });
  });

  // === PERFIL DE USU√ÅRIO (FIRESTORE /usuarios) ===

  async function ensureUserProfile(user) {
    const col = collection(db, 'usuarios');
    const q = query(col, where('email', '==', user.email));
    const snap = await getDocs(q);

    if (!snap.empty) {
      // se j√° tem, s√≥ retorna primeiro
      const docSnap = snap.docs[0];
      return {
        docId: docSnap.id,
        ...docSnap.data()
      };
    }

    // se n√£o tem, criar como repositor padr√£o, sem loja
    const docRef = await addDoc(col, {
      criadoEm: serverTimestamp(),
      email: user.email,
      nome: user.displayName || '',
      loja: '',
      tipo: 'repositor'
    });
    return {
      docId: docRef.id,
      email: user.email,
      nome: user.displayName || '',
      loja: '',
      tipo: 'repositor'
    };
  }

  async function loadCurrentProfile(user) {
    const profile = await ensureUserProfile(user);
    currentProfile = profile;
    headerUserName.textContent = profile.nome || (user.email ?? 'Usu√°rio');
    headerUserRole.textContent = `Perfil: ${profile.tipo}${profile.loja ? ' ¬∑ ' + profile.loja : ''}`;

    // Admin enxerga menu de usu√°rios; outros n√£o
    if (profile.tipo === 'admin') {
      navAdmin.classList.remove('hidden');
    } else {
      navAdmin.classList.add('hidden');
    }
  }

  // === LOGIN ===

  async function handleLoginEmail() {
    const email = loginEmail.value.trim();
    const senha = loginPassword.value;
    if (!email || !senha) {
      showAlert('Informe e-mail e senha.');
      return;
    }
    try {
      const cred = await signInWithEmailAndPassword(auth, email, senha);
      currentUser = cred.user;
      await loadCurrentProfile(currentUser);
      await loadItens();
      await loadUsuariosIfAdmin();
      loginView.classList.add('hidden');
      appView.classList.remove('hidden');
      setActiveSection('section-main');
    } catch (e) {
      console.error(e);
      showAlert('Erro no login: ' + (e.message || e.code || 'verifique usu√°rio/senha.'));
    }
  }

  async function handleLoginGoogle() {
    try {
      const result = await signInWithPopup(auth, googleProvider);
      currentUser = result.user;
      await loadCurrentProfile(currentUser);
      await loadItens();
      await loadUsuariosIfAdmin();
      loginView.classList.add('hidden');
      appView.classList.remove('hidden');
      setActiveSection('section-main');
    } catch (e) {
      console.error(e);
      showAlert('Erro no login com Google: ' + (e.message || e.code || 'verifique configura√ß√£o de dom√≠nio no Firebase.'));
    }
  }

  btnLogin.addEventListener('click', handleLoginEmail);
  btnGoogle.addEventListener('click', handleLoginGoogle);

  btnLogout.addEventListener('click', async () => {
    await signOut(auth);
    currentUser = null;
    currentProfile = null;
    loginView.classList.remove('hidden');
    appView.classList.add('hidden');
  });

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      loginView.classList.remove('hidden');
      appView.classList.add('hidden');
      return;
    }
    try {
      currentUser = user;
      await loadCurrentProfile(user);
      await loadItens();
      await loadUsuariosIfAdmin();
      loginView.classList.add('hidden');
      appView.classList.remove('hidden');
      setActiveSection('section-main');
    } catch (e) {
      console.error('Erro carregando perfil ap√≥s onAuthStateChanged', e);
    }
  });

  // === Lan√ßamentos (cole√ß√£o "lancamentos") ===

  async function salvarLancamento() {
    if (!currentUser || !currentProfile) {
      showAlert('Fa√ßa login novamente.');
      return;
    }

    const loja = lojaSelect.value.trim();
    const departamento = departamentoSelect.value.trim();
    const cod = codigoBarras.value.trim();
    const desc = descricao.value.trim();
    const qtde = Number(quantidade.value);
    const validade = validadeInput.value;

    if (!loja || !departamento || !cod || !desc || !qtde || !validade) {
      showAlert('Preencha todos os campos obrigat√≥rios (*).');
      return;
    }

    if (!/^\d{1,13}$/.test(cod)) {
      showAlert('C√≥digo de barras deve ter at√© 13 d√≠gitos num√©ricos.');
      return;
    }

    const lanc = {
      loja,
      departamento,
      codigoBarras: cod,
      descricao: desc,
      lote: lote.value.trim(),
      quantidade: qtde,
      validade, // ISO yyyy-mm-dd
      observacao: observacao.value.trim(),
      usuarioNome: currentProfile.nome || currentUser.email,
      usuarioEmail: currentUser.email,
      criadoPorEmail: currentUser.email,
      oferta: false,
      criadoEm: serverTimestamp(),
      dataLancamentoTexto: dataLancamento.value // para visual
    };

    try {
      await addDoc(collection(db, 'lancamentos'), lanc);
      showAlert('Lan√ßamento salvo com sucesso.');
      // limpa alguns campos
      descricao.value = '';
      quantidade.value = '';
      lote.value = '';
      observacao.value = '';
      validadeInput.value = '';
      codigoBarras.value = '';
      setTodayInForm();
      await loadItens();
    } catch (e) {
      console.error(e);
      showAlert('Erro ao salvar lan√ßamento: ' + (e.message || e.code));
    }
  }

  btnSalvarLancamento.addEventListener('click', salvarLancamento);

  function calcularStatus(validadeIso) {
    if (!validadeIso) return { label: '-', classe: '' };
    const hoje = new Date();
    const v = new Date(validadeIso + 'T00:00:00');
    const diffMs = v.getTime() - hoje.setHours(0, 0, 0, 0);
    const dias = Math.floor(diffMs / 86400000);

    if (dias < 0) return { label: 'Vencido', classe: 'vencido' };
    if (dias <= 7) return { label: `Vence em ${dias} dia(s)`, classe: 'curto' };
    if (dias <= 15) return { label: `Vence em ${dias} dia(s)`, classe: 'curto' };
    if (dias <= 30) return { label: `Vence em ${dias} dia(s)`, classe: 'medio' };
    return { label: `Vence em ${dias} dia(s)`, classe: 'longo' };
  }

  async function loadItens() {
    if (!currentUser || !currentProfile) return;

    try {
      const snap = await getDocs(collection(db, 'lancamentos'));
      let itens = snap.docs.map(d => ({
        id: d.id,
        ...d.data()
      }));

      // Permiss√µes:
      if (currentProfile.tipo === 'gerente') {
        itens = itens.filter(i => i.loja === currentProfile.loja);
      } else if (currentProfile.tipo === 'repositor') {
        itens = itens.filter(i => i.criadoPorEmail === currentUser.email);
      }
      // Admin enxerga tudo.

      currentItens = itens.sort((a, b) => {
        const aDate = a.criadoEm?.toDate ? a.criadoEm.toDate().getTime() : 0;
        const bDate = b.criadoEm?.toDate ? b.criadoEm.toDate().getTime() : 0;
        return bDate - aDate;
      });

      renderTabelaItens();
    } catch (e) {
      console.error(e);
      showAlert('Erro ao carregar itens: ' + (e.message || e.code));
    }
  }

  function aplicaFiltroStatus(item) {
    const filtro = filtroStatus.value;
    if (filtro === 'todos') return true;

    const hoje = new Date();
    const v = new Date(item.validade + 'T00:00:00');
    const diffMs = v.getTime() - hoje.setHours(0, 0, 0, 0);
    const dias = Math.floor(diffMs / 86400000);

    if (filtro === 'vencidos') return dias < 0;
    const limite = Number(filtro);
    return dias >= 0 && dias <= limite;
  }

  function aplicaFiltroDepartamento(item) {
    const dep = filtroDepartamento.value;
    if (dep === 'todos') return true;
    return item.departamento === dep;
  }

  function renderTabelaItens() {
    tbodyItens.innerHTML = '';
    let filtrados = currentItens.filter(i => aplicaFiltroStatus(i) && aplicaFiltroDepartamento(i));

    filtrados.forEach(item => {
      const tr = document.createElement('tr');

      const statusInfo = calcularStatus(item.validade);
      const ofertaLabel = item.oferta ? 'Lan√ßado' : 'N√£o lan√ßado';

      const dataLancTxt = item.dataLancamentoTexto || (item.criadoEm?.toDate ? formatDateTimeBR(item.criadoEm.toDate()) : '');
      const validadeBR = item.validade ? formatDateBR(new Date(item.validade)) : '';

      tr.innerHTML = `
        <td>${item.loja || ''}</td>
        <td>${dataLancTxt}</td>
        <td>${item.departamento || ''}</td>
        <td>${item.codigoBarras || ''}</td>
        <td>${item.descricao || ''}</td>
        <td>${item.quantidade || ''}</td>
        <td>${validadeBR}</td>
        <td><span class="badge-status ${statusInfo.classe}">${statusInfo.label}</span></td>
        <td><span class="badge-oferta ${item.oferta ? 'lancado' : ''}" data-id="${item.id}" data-oferta="${item.oferta ? '1' : '0'}">${ofertaLabel}</span></td>
        <td style="text-align:center;"><input type="checkbox" data-flag-id="${item.id}" ${item.flag ? 'checked' : ''}></td>
        <td>${item.lote || ''}</td>
        <td>${item.usuarioNome || ''}</td>
        <td>${item.criadoEm?.toDate ? formatDateTimeBR(item.criadoEm.toDate()) : ''}</td>
        <td>${item.observacao || ''}</td>
        <td class="table-actions">
          <a href="#" data-edit-id="${item.id}">Editar</a>
          ${currentProfile.tipo === 'admin' ? '<a href="#" class="delete" data-del-id="' + item.id + '">Excluir</a>' : ''}
        </td>
      `;

      tbodyItens.appendChild(tr);
    });

    totalItensLabel.textContent = `Total de itens: ${filtrados.length}`;
  }

  filtroStatus.addEventListener('change', renderTabelaItens);
  filtroDepartamento.addEventListener('change', renderTabelaItens);

  tbodyItens.addEventListener('click', async (ev) => {
    const ofertaSpan = ev.target.closest('.badge-oferta');
    const delLink = ev.target.closest('[data-del-id]');

    if (ofertaSpan) {
      const id = ofertaSpan.dataset.id;
      const atual = ofertaSpan.dataset.oferta === '1';
      try {
        await updateDoc(doc(db, 'lancamentos', id), { oferta: !atual });
        await loadItens();
      } catch (e) {
        console.error(e);
        showAlert('Erro ao atualizar oferta.');
      }
      ev.preventDefault();
      return;
    }

    if (delLink) {
      ev.preventDefault();
      if (currentProfile.tipo !== 'admin') return;
      if (!confirm('Deseja realmente excluir este lan√ßamento?')) return;
      try {
        await deleteDoc(doc(db, 'lancamentos', delLink.dataset.delId));
        await loadItens();
      } catch (e) {
        console.error(e);
        showAlert('Erro ao excluir.');
      }
      return;
    }
  });

  btnMarcarTodosOferta.addEventListener('click', async () => {
    const filtrados = currentItens.filter(i => aplicaFiltroStatus(i) && aplicaFiltroDepartamento(i));
    if (!filtrados.length) {
      showAlert('Nenhum item filtrado para marcar.');
      return;
    }
    if (!confirm(`Marcar ${filtrados.length} item(ns) como "Lan√ßado"?`)) return;
    try {
      for (const item of filtrados) {
        await updateDoc(doc(db, 'lancamentos', item.id), { oferta: true });
      }
      await loadItens();
    } catch (e) {
      console.error(e);
      showAlert('Erro ao marcar itens como oferta.');
    }
  });

  // === EXPORTA√á√ïES ===

  btnExportExcel.addEventListener('click', () => {
    const dados = currentItens.filter(i => aplicaFiltroStatus(i) && aplicaFiltroDepartamento(i));
    if (!dados.length) {
      showAlert('Nenhum dado para exportar.');
      return;
    }
    const rows = [
      ['Loja', 'Data lan√ßamento', 'Departamento', 'C√≥d. barras', 'Descri√ß√£o', 'Qtd', 'Validade', 'Status', 'Oferta', 'Lote', 'Usu√°rio', 'Lan√ßado em', 'Obs.']
    ];

    dados.forEach(i => {
      const statusInfo = calcularStatus(i.validade);
      rows.push([
        i.loja || '',
        i.dataLancamentoTexto || (i.criadoEm?.toDate ? formatDateTimeBR(i.criadoEm.toDate()) : ''),
        i.departamento || '',
        i.codigoBarras || '',
        i.descricao || '',
        i.quantidade || '',
        i.validade ? formatDateBR(new Date(i.validade)) : '',
        statusInfo.label,
        i.oferta ? 'Lan√ßado' : 'N√£o lan√ßado',
        i.lote || '',
        i.usuarioNome || '',
        i.criadoEm?.toDate ? formatDateTimeBR(i.criadoEm.toDate()) : '',
        i.observacao || ''
      ]);
    });

    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(rows);
    XLSX.utils.book_append_sheet(wb, ws, 'Validades');
    XLSX.writeFile(wb, 'controle_validade_palato.xlsx');
  });

  btnExportPdf.addEventListener('click', () => {
    const dados = currentItens.filter(i => aplicaFiltroStatus(i) && aplicaFiltroDepartamento(i));
    if (!dados.length) {
      showAlert('Nenhum dado para exportar.');
      return;
    }
    const { jsPDF } = window.jspdf;
    const docPdf = new jsPDF('l', 'pt', 'a4');

    const columns = ['Loja', 'Data lan√ßamento', 'Departamento', 'C√≥d. barras', 'Descri√ß√£o', 'Qtd', 'Validade', 'Status', 'Oferta', 'Lote', 'Usu√°rio', 'Lan√ßado em', 'Obs.'];
    const rows = dados.map(i => {
      const statusInfo = calcularStatus(i.validade);
      return [
        i.loja || '',
        i.dataLancamentoTexto || (i.criadoEm?.toDate ? formatDateTimeBR(i.criadoEm.toDate()) : ''),
        i.departamento || '',
        i.codigoBarras || '',
        i.descricao || '',
        i.quantidade || '',
        i.validade ? formatDateBR(new Date(i.validade)) : '',
        statusInfo.label,
        i.oferta ? 'Lan√ßado' : 'N√£o lan√ßado',
        i.lote || '',
        i.usuarioNome || '',
        i.criadoEm?.toDate ? formatDateTimeBR(i.criadoEm.toDate()) : '',
        i.observacao || ''
      ];
    });

    docPdf.setFontSize(14);
    docPdf.text('Controle de Validade - Palato', 40, 40);
    docPdf.setFontSize(10);

    docPdf.autoTable({
      startY: 60,
      head: [columns],
      body: rows,
      styles: { fontSize: 7 },
      headStyles: { fillColor: [0, 0, 0], textColor: 255 },
      alternateRowStyles: { fillColor: [245, 245, 245] }
    });

    docPdf.save('controle_validade_palato.pdf');
  });

  // === ADMIN USU√ÅRIOS ===

  async function loadUsuariosIfAdmin() {
    if (!currentProfile || currentProfile.tipo !== 'admin') {
      tbodyUsuarios.innerHTML = '';
      return;
    }
    try {
      const snap = await getDocs(collection(db, 'usuarios'));
      const users = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      renderUsuarios(users);
    } catch (e) {
      console.error(e);
      showAlert('Erro ao carregar usu√°rios.');
    }
  }

  function renderUsuarios(users) {
    tbodyUsuarios.innerHTML = '';
    users.forEach(u => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${u.nome || ''}</td>
        <td>${u.email || ''}</td>
        <td>
          <select data-user-id="${u.id}" data-field="tipo">
            <option value="repositor" ${u.tipo === 'repositor' ? 'selected' : ''}>Repositor</option>
            <option value="gerente" ${u.tipo === 'gerente' ? 'selected' : ''}>Gerente</option>
            <option value="admin" ${u.tipo === 'admin' ? 'selected' : ''}>Admin</option>
          </select>
        </td>
        <td>
          <select data-user-id="${u.id}" data-field="loja">
            <option value="" ${!u.loja ? 'selected' : ''}>Nenhuma</option>
            <option value="Ponta Verde" ${u.loja === 'Ponta Verde' ? 'selected' : ''}>Ponta Verde</option>
            <option value="Farol" ${u.loja === 'Farol' ? 'selected' : ''}>Farol</option>
            <option value="Praia" ${u.loja === 'Praia' ? 'selected' : ''}>Praia</option>
            <option value="Riomar" ${u.loja === 'Riomar' ? 'selected' : ''}>Riomar</option>
            <option value="CD Farol" ${u.loja === 'CD Farol' ? 'selected' : ''}>CD Farol</option>
          </select>
        </td>
        <td class="table-actions">
          <a href="#" data-save-user="${u.id}">Salvar</a>
          <a href="#" class="delete" data-del-user="${u.id}">Excluir</a>
        </td>
      `;
      tbodyUsuarios.appendChild(tr);
    });
  }

  btnRecarregarUsuarios.addEventListener('click', loadUsuariosIfAdmin);

  btnSalvarUsuario.addEventListener('click', async () => {
    const nome = novoUserNome.value.trim();
    const email = novoUserEmail.value.trim();
    const tipo = novoUserTipo.value;
    const loja = novoUserLoja.value;

    if (!email) {
      showAlert('Informe ao menos o e-mail do usu√°rio.');
      return;
    }
    try {
      await addDoc(collection(db, 'usuarios'), {
        criadoEm: serverTimestamp(),
        nome,
        email,
        tipo,
        loja
      });
      novoUserNome.value = '';
      novoUserEmail.value = '';
      novoUserLoja.value = '';
      novoUserTipo.value = 'repositor';
      await loadUsuariosIfAdmin();
      showAlert('Usu√°rio salvo/atualizado.');
    } catch (e) {
      console.error(e);
      showAlert('Erro ao salvar usu√°rio.');
    }
  });

  tbodyUsuarios.addEventListener('click', async (ev) => {
    const saveBtn = ev.target.closest('[data-save-user]');
    const delBtn = ev.target.closest('[data-del-user]');
    if (saveBtn) {
      ev.preventDefault();
      const id = saveBtn.dataset.saveUser;
      const tipoSel = tbodyUsuarios.querySelector(`select[data-user-id="${id}"][data-field="tipo"]`);
      const lojaSel = tbodyUsuarios.querySelector(`select[data-user-id="${id}"][data-field="loja"]`);
      try {
        await updateDoc(doc(db, 'usuarios', id), {
          tipo: tipoSel.value,
          loja: lojaSel.value
        });
        showAlert('Usu√°rio atualizado.');
        await loadUsuariosIfAdmin();
        if (currentProfile && currentUser && currentProfile.email === currentUser.email) {
          await loadCurrentProfile(currentUser); // atualiza header se alterou o pr√≥prio perfil
        }
      } catch (e) {
        console.error(e);
        showAlert('Erro ao atualizar usu√°rio.');
      }
    }
    if (delBtn) {
      ev.preventDefault();
      const id = delBtn.dataset.delUser;
      if (!confirm('Excluir este usu√°rio da tabela (n√£o exclui do Auth)?')) return;
      try {
        await deleteDoc(doc(db, 'usuarios', id));
        await loadUsuariosIfAdmin();
      } catch (e) {
        console.error(e);
        showAlert('Erro ao excluir usu√°rio.');
      }
    }
  });

  // === SCANNER C√ìDIGO DE BARRAS ===

  btnScan.addEventListener('click', () => {
    scannerModal.classList.remove('hidden');
    startScanner();
  });

  btnFecharScanner.addEventListener('click', () => {
    stopScanner();
    scannerModal.classList.add('hidden');
  });

  async function startScanner() {
    try {
      if (!html5QrCode) {
        html5QrCode = new Html5Qrcode("reader");
      }
      await html5QrCode.start(
        { facingMode: { exact: "environment" } }, // tenta c√¢mera traseira
        {
          fps: 10,
          qrbox: { width: 250, height: 150 }
        },
        (decodedText) => {
          codigoBarras.value = decodedText.replace(/\D/g, '').slice(0, 13);
          stopScanner();
          scannerModal.classList.add('hidden');
        },
        (errorMessage) => {
          // erros de leitura podem ser ignorados
        }
      );
    } catch (e) {
      console.error(e);
      showAlert('Leitor de c√≥digo de barras n√£o carregou corretamente.');
    }
  }

  async function stopScanner() {
    if (html5QrCode && html5QrCode.isScanning) {
      await html5QrCode.stop();
    }
  }

  // Inicial
  setTodayInForm();
</script>

</body>
</html>
