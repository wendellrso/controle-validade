 (cd "$(git rev-parse --show-toplevel)" && git apply --3way <<'EOF' 
diff --git a/index.html b/index.html
index 7531e10d2af7579f6d609ed77d879bc45518261f..63cd9c0e425780fa0f15406ba99b19e91f70e0f2 100644
--- a/index.html
+++ b/index.html
@@ -1514,52 +1514,55 @@
   </div>
 
   <!-- FIREBASE + APP -->
   <script type="module">
     import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
     import {
       getAuth,
       signInWithEmailAndPassword,
       signInWithPopup,
       GoogleAuthProvider,
       onAuthStateChanged,
       signOut
     } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";
     import {
       getFirestore,
       collection,
       doc,
       getDoc,
       getDocs,
       setDoc,
       updateDoc,
       deleteDoc,
       addDoc,
       query,
       orderBy,
-      serverTimestamp
-    } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";
+      serverTimestamp,
+      where,
+      limit,
+      startAfter
+    } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";
 
     const firebaseConfig = {
       apiKey: "AIzaSyDa1z9LwlSHxwSTC974ci9RMEYdEiA_wEg",
       authDomain: "controle-validade-fc108.firebaseapp.com",
       projectId: "controle-validade-fc108",
       storageBucket: "controle-validade-fc108.firebasestorage.app",
       messagingSenderId: "737065688686",
       appId: "1:737065688686:web:ed3e602baf64c1fb4f907f",
       measurementId: "G-VJ8DMM47EN"
     };
 
     const app = initializeApp(firebaseConfig);
     const auth = getAuth(app);
     const db = getFirestore(app);
     const googleProvider = new GoogleAuthProvider();
 
     /* ===== ELEMENTOS ===== */
     const loginView = document.getElementById("loginView");
     const onboardingView = document.getElementById("onboardingView");
     const appView = document.getElementById("appView");
 
     const loginEmail = document.getElementById("loginEmail");
     const loginSenha = document.getElementById("loginSenha");
     const btnLoginEmail = document.getElementById("btnLoginEmail");
     const btnLoginGoogle = document.getElementById("btnLoginGoogle");
@@ -1621,66 +1624,71 @@
     const novoUsuarioEmail = document.getElementById("novoUsuarioEmail");
     const novoUsuarioPerfil = document.getElementById("novoUsuarioPerfil");
     const novoUsuarioLoja = document.getElementById("novoUsuarioLoja");
     const btnSalvarUsuario = document.getElementById("btnSalvarUsuario");
     const btnReloadUsuarios = document.getElementById("btnReloadUsuarios");
 
     // Scanner modal
     const scannerModal = document.getElementById("scannerModal");
     const btnCloseScanner = document.getElementById("btnCloseScanner");
     let html5QrCode = null;
     let scannerAtivo = false;
 
     // Onboarding elementos
     const onboardingStep1 = document.getElementById("onboardingStep1");
     const onboardingStep2 = document.getElementById("onboardingStep2");
     const onboardingNext = document.getElementById("onboardingNext");
     const onboardingBack = document.getElementById("onboardingBack");
     const lojaButtons = document.querySelectorAll(".loja-btn");
     const cargoButtons = document.querySelectorAll(".cargo-btn");
 
     /* ===== ESTADO ===== */
     let usuarioAtual = null;
     let perfilAtual = null;
     let perfilLojaAtual = null;
 
-    let lancamentosCache = [];
-
-    let currentPage = 1;
-    const pageSize = 10;
+    let lancamentosCache = [];
+    let ultimoLancamentoDoc = null;
+    let temMaisLancamentos = true;
+
+    let currentPage = 1;
+    const pageSize = 10;
+    const firestorePageSize = 50;
 
     // Onboarding estado
     let onboardingStep = 1;
     let onboardingSelectedLoja = null;
     let onboardingSelectedCargo = null;
     let onboardingDocRef = null;
     let onboardingUser = null;
 
     /* ===== HELPERS ===== */
-    function showAlert(msg) {
-      alert(msg);
-    }
+    function showAlert(msg) {
+      alert(msg);
+    }
+
+    const PERFIS_PRIVILEGIADOS = ["admin", "gestor_categoria", "assistente_comercial"];
 
     function formatarDataHora(date) {
       const d = new Date(date);
       const pad = (n) => (n < 10 ? "0" + n : "" + n);
       return `${pad(d.getDate())}/${pad(d.getMonth() + 1)}/${d.getFullYear()} ${pad(
         d.getHours()
       )}:${pad(d.getMinutes())}`;
     }
 
     function formatarSomenteData(date) {
       const d = new Date(date);
       const pad = (n) => (n < 10 ? "0" + n : "" + n);
       return `${pad(d.getDate())}/${pad(d.getMonth() + 1)}/${d.getFullYear()}`;
     }
 
     function diasEntreHoje(eData) {
       const hoje = new Date();
       hoje.setHours(0, 0, 0, 0);
       const dt = new Date(eData);
       dt.setHours(0, 0, 0, 0);
       const diffMs = dt - hoje;
       return Math.round(diffMs / (1000 * 60 * 60 * 24));
     }
 
     function calcularStatus(validadeStr) {
@@ -1808,68 +1816,76 @@
       lote.value = "";
       quantidade.value = "";
       validade.value = "";
       observacao.value = "";
       const agora = new Date();
       dataLancamento.value = formatarDataHora(agora);
     }
 
     function labelPerfil(perfil, loja) {
       switch (perfil) {
         case "admin":
           return "Perfil: admin";
         case "gerente":
           return `Perfil: gerente${loja ? " (" + loja + ")" : ""}`;
         case "repositor":
           return `Perfil: repositor${loja ? " (" + loja + ")" : ""}`;
         case "gestor_categoria":
           return "Perfil: Gestor de Categoria";
         case "assistente_comercial":
           return "Perfil: Assistente Comercial";
         default:
           return "Perfil não definido";
       }
     }
 
-    function atualizarUserBox() {
-      if (!usuarioAtual) {
-        userBox.innerHTML = "";
-        return;
-      }
-      const nome = usuarioAtual.displayName || usuarioAtual.email || "";
-      const perfilLabel = labelPerfil(perfilAtual, perfilLojaAtual);
-
-      userBox.innerHTML = `
-        <strong>${nome}</strong>
-        <span class="user-profile-label">${perfilLabel}</span>
-        <a id="btnLogout">Sair</a>
-      `;
-      const btnLogout = document.getElementById("btnLogout");
-      btnLogout.addEventListener("click", async () => {
-        await signOut(auth);
-      });
-    }
+    function atualizarUserBox() {
+      if (!usuarioAtual) {
+        userBox.innerHTML = "";
+        return;
+      }
+      const nome = usuarioAtual.displayName || usuarioAtual.email || "";
+      const perfilLabel = labelPerfil(perfilAtual, perfilLojaAtual);
+
+      userBox.innerHTML = "";
+      const strongNome = document.createElement("strong");
+      strongNome.textContent = nome;
+      const spanPerfil = document.createElement("span");
+      spanPerfil.className = "user-profile-label";
+      spanPerfil.textContent = perfilLabel;
+      const linkLogout = document.createElement("a");
+      linkLogout.id = "btnLogout";
+      linkLogout.textContent = "Sair";
+
+      userBox.appendChild(strongNome);
+      userBox.appendChild(spanPerfil);
+      userBox.appendChild(linkLogout);
+
+      linkLogout.addEventListener("click", async () => {
+        await signOut(auth);
+      });
+    }
 
     function atualizarClassePerfilBody() {
       document.body.classList.remove("perfil-admin", "perfil-nao-admin");
       if (!perfilAtual) return;
       if (perfilAtual === "admin") document.body.classList.add("perfil-admin");
       else document.body.classList.add("perfil-nao-admin");
     }
 
     async function abrirAppAposLogin() {
       atualizarClassePerfilBody();
       atualizarUserBox();
       limparFormularioLancamento();
 
       loginView.style.display = "none";
       onboardingView.style.display = "none";
       appView.style.display = "flex";
 
       setView("dashboard");
       await carregarLancamentos();
     }
 
     /* ===== ONBOARDING ===== */
 
     function atualizarOnboardingUI() {
       if (onboardingStep === 1) {
@@ -2118,160 +2134,212 @@
       setView("novo");
       limparFormularioLancamento();
       fecharMenu();
     });
     menuItens.addEventListener("click", async () => {
       setView("itens");
       fecharMenu();
       await carregarLancamentos();
     });
     menuUsuarios.addEventListener("click", async () => {
       if (perfilAtual !== "admin") return;
       setView("usuarios");
       fecharMenu();
       await carregarUsuarios();
     });
 
     /* ===== NOVO LANÇAMENTO ===== */
     btnSalvarLancamento.addEventListener("click", async () => {
       if (!usuarioAtual) {
         showAlert("Faça login novamente.");
         return;
       }
       const loja = novaLoja.value;
       const dep = departamento.value;
       let cod = codigoBarras.value.trim();
-      const desc = descricao.value.trim();
-      const loteVal = lote.value.trim();
-      const qtd = Number(quantidade.value);
-      const val = validade.value;
-      const obs = observacao.value.trim();
+      const desc = descricao.value.trim();
+      const loteVal = lote.value.trim();
+      const qtd = Number(quantidade.value);
+      const val = validade.value;
+      const obs = observacao.value.trim();
 
       if (perfilAtual === "repositor" || perfilAtual === "gerente") {
         if (!perfilLojaAtual) {
           showAlert("Seu usuário ainda não tem uma loja vinculada. Procure o administrador.");
           return;
         }
         if (loja !== perfilLojaAtual) {
           showAlert(`Você só pode lançar produtos para a loja ${perfilLojaAtual}.`);
           return;
         }
       }
 
-      if (!loja || !dep || !cod || !desc || !qtd || !val) {
-        showAlert("Preencha todos os campos obrigatórios.");
-        return;
-      }
-
-      if (!/^[0-9]+$/.test(cod)) {
-        showAlert("Código de barras deve ter apenas números.");
-        return;
-      }
+      if (!loja || !dep || !cod || !desc || !qtd || !val) {
+        showAlert("Preencha todos os campos obrigatórios.");
+        return;
+      }
+
+      if (!Number.isFinite(qtd) || qtd <= 0) {
+        showAlert("Quantidade deve ser um número maior que zero.");
+        return;
+      }
+
+      if (desc.length > 200) {
+        showAlert("Descrição deve ter no máximo 200 caracteres.");
+        return;
+      }
+
+      if (loteVal.length > 50) {
+        showAlert("Lote deve ter no máximo 50 caracteres.");
+        return;
+      }
+
+      if (!/^[0-9]+$/.test(cod)) {
+        showAlert("Código de barras deve ter apenas números.");
+        return;
+      }
 
       if (cod.length > 13) {
         showAlert("Código de barras deve ter no máximo 13 dígitos.");
         return;
       }
 
       const hoje = new Date();
       hoje.setHours(0, 0, 0, 0);
-      const dtVal = new Date(val);
-      dtVal.setHours(0, 0, 0, 0);
-      if (dtVal < hoje) {
-        showAlert("A validade não pode ser menor que a data de hoje.");
-        return;
-      }
-
-      try {
-        await addDoc(collection(db, "lancamentos"), {
-          loja,
-          departamento: dep,
-          codigoBarras: cod,
+      const dtVal = new Date(val);
+      dtVal.setHours(0, 0, 0, 0);
+      if (dtVal < hoje) {
+        showAlert("A validade não pode ser menor que a data de hoje.");
+        return;
+      }
+
+      try {
+        const duplicidadeQuery = query(
+          collection(db, "lancamentos"),
+          where("codigoBarras", "==", cod),
+          where("validade", "==", val),
+          where("loja", "==", loja),
+          limit(1)
+        );
+        const dupSnap = await getDocs(duplicidadeQuery);
+        if (!dupSnap.empty) {
+          showAlert("Já existe um lançamento com o mesmo código, validade e loja.");
+          return;
+        }
+
+        await addDoc(collection(db, "lancamentos"), {
+          loja,
+          departamento: dep,
+          codigoBarras: cod,
           descricao: desc,
           lote: loteVal,
           quantidade: qtd,
           validade: val,
           observacao: obs,
           oferta: "nao_lancado",
           usuarioNome: usuarioAtual.displayName || "",
           usuarioEmail: usuarioAtual.email || "",
           usuarioUid: usuarioAtual.uid,
           dataLancamentoTexto: dataLancamento.value,
           criadoEm: serverTimestamp()
-        });
-
-        showAlert("Lançamento salvo com sucesso.");
-        limparFormularioLancamento();
-        await carregarLancamentos();
-      } catch (err) {
-        console.error(err);
-        showAlert("Erro ao salvar lançamento.");
-      }
-    });
+        });
+
+        showAlert("Lançamento salvo com sucesso.");
+        limparFormularioLancamento();
+        await carregarLancamentos({ reset: true });
+      } catch (err) {
+        console.error(err);
+        showAlert("Erro ao salvar lançamento.");
+      }
+    });
 
     /* ===== CARREGAR LANÇAMENTOS ===== */
-    async function carregarLancamentos() {
-      if (!usuarioAtual) return;
-      const colRef = collection(db, "lancamentos");
-      const q = query(colRef, orderBy("criadoEm", "desc"));
-
-      const snap = await getDocs(q);
-      lancamentosCache = [];
-
-      snap.forEach((docSnap) => {
-        const item = docSnap.data();
-        const id = docSnap.id;
-
-        let visivel = false;
-        if (
-          perfilAtual === "admin" ||
-          perfilAtual === "gestor_categoria" ||
-          perfilAtual === "assistente_comercial"
-        ) {
-          visivel = true;
-        } else if (perfilAtual === "gerente") {
-          if (!perfilLojaAtual || item.loja === perfilLojaAtual) visivel = true;
-        } else {
-          // repositor
-          const uid = item.usuarioUid;
-          const email = item.usuarioEmail;
-          if (
-            (uid === usuarioAtual.uid || email === usuarioAtual.email) &&
-            (!perfilLojaAtual || item.loja === perfilLojaAtual)
-          ) {
-            visivel = true;
-          }
-        }
-        if (!visivel) return;
-
-        lancamentosCache.push({ id, ...item });
-      });
-
-      currentPage = 1;
-      aplicarFiltrosETabela();
-      atualizarDashboard();
-    }
+    async function carregarLancamentos({ reset = true } = {}) {
+      if (!usuarioAtual) return;
+
+      if (reset) {
+        lancamentosCache = [];
+        ultimoLancamentoDoc = null;
+        temMaisLancamentos = true;
+        currentPage = 1;
+      }
+
+      if (!temMaisLancamentos && !reset) return;
+
+      try {
+        const filtros = [];
+        if (!PERFIS_PRIVILEGIADOS.includes(perfilAtual)) {
+          if (perfilAtual === "gerente" && perfilLojaAtual) {
+            filtros.push(where("loja", "==", perfilLojaAtual));
+          }
+          if (perfilAtual === "repositor") {
+            filtros.push(where("usuarioUid", "==", usuarioAtual.uid));
+            if (perfilLojaAtual) filtros.push(where("loja", "==", perfilLojaAtual));
+          }
+        }
+
+        const colRef = collection(db, "lancamentos");
+        let consulta = query(
+          colRef,
+          ...filtros,
+          orderBy("criadoEm", "desc"),
+          limit(firestorePageSize)
+        );
+
+        if (ultimoLancamentoDoc && !reset) {
+          consulta = query(
+            colRef,
+            ...filtros,
+            orderBy("criadoEm", "desc"),
+            startAfter(ultimoLancamentoDoc),
+            limit(firestorePageSize)
+          );
+        }
+
+        const snap = await getDocs(consulta);
+        if (snap.docs.length < firestorePageSize) {
+          temMaisLancamentos = false;
+        }
+        if (snap.docs.length) {
+          ultimoLancamentoDoc = snap.docs[snap.docs.length - 1];
+        }
+
+        const idsExistentes = new Set(lancamentosCache.map((l) => l.id));
+        snap.forEach((docSnap) => {
+          const item = docSnap.data();
+          const id = docSnap.id;
+          if (idsExistentes.has(id)) return;
+          lancamentosCache.push({ id, ...item });
+        });
+
+        aplicarFiltrosETabela();
+        atualizarDashboard();
+      } catch (err) {
+        console.error(err);
+        showAlert("Erro ao carregar lançamentos. Tente novamente.");
+      }
+    }
 
     function parseValidadeDate(item) {
       if (!item.validade) return null;
       const d = new Date(item.validade);
       d.setHours(0, 0, 0, 0);
       return d;
     }
 
     function aplicarFiltrosETabela() {
       tabelaItensBody.innerHTML = "";
       mobileCardsContainer.innerHTML = "";
 
       let filtrados = [...lancamentosCache];
 
       const filtroStatusVal = filtroStatus.value;
       const filtroDepVal = filtroDepartamento.value;
       const filtroOfertaVal = filtroOferta.value;
       const buscaCodigoVal = filtroCodigo.value.trim();
 
       const hoje = new Date();
       hoje.setHours(0, 0, 0, 0);
 
       filtrados = filtrados.filter((item) => {
         if (item.validade) {
           const dt = new Date(item.validade);
@@ -2535,74 +2603,90 @@
     ofertaSpan.textContent =
       item.oferta === "lancado" ? "Oferta: Lançado" : "Oferta: Não lançado";
 
     footer.appendChild(statusSpan);
     footer.appendChild(ofertaSpan);
 
     card.appendChild(header);
     card.appendChild(desc);
     card.appendChild(row1);
     card.appendChild(row2);
     card.appendChild(footer);
 
     mobileCardsContainer.appendChild(card);
   });
 }
 
 
     filtroStatus.addEventListener("change", () => {
       currentPage = 1;
       aplicarFiltrosETabela();
     });
     filtroDepartamento.addEventListener("change", () => {
       currentPage = 1;
       aplicarFiltrosETabela();
     });
-    filtroOferta.addEventListener("change", () => {
-      currentPage = 1;
-      aplicarFiltrosETabela();
-    });
-    filtroCodigo.addEventListener("input", () => {
-      currentPage = 1;
-      aplicarFiltrosETabela();
-    });
-
-    btnPaginaAnterior.addEventListener("click", () => {
-      if (currentPage > 1) {
-        currentPage--;
-        aplicarFiltrosETabela();
-      }
-    });
-
-    btnPaginaProxima.addEventListener("click", () => {
-      const total = Number(totalItensSpan.textContent || "0");
-      const totalPages = Math.max(1, Math.ceil(total / pageSize));
-      if (currentPage < totalPages) {
-        currentPage++;
-        aplicarFiltrosETabela();
-      }
-    });
+    filtroOferta.addEventListener("change", () => {
+      currentPage = 1;
+      aplicarFiltrosETabela();
+    });
+    filtroCodigo.addEventListener("input", () => {
+      currentPage = 1;
+      aplicarFiltrosETabela();
+    });
+
+    async function garantirDadosParaPagina(targetPage) {
+      const itemsNecessarios = targetPage * pageSize;
+      while (lancamentosCache.length < itemsNecessarios && temMaisLancamentos) {
+        await carregarLancamentos({ reset: false });
+      }
+    }
+
+    btnPaginaAnterior.addEventListener("click", () => {
+      if (currentPage > 1) {
+        currentPage--;
+        aplicarFiltrosETabela();
+      }
+    });
+
+    btnPaginaProxima.addEventListener("click", async () => {
+      const total = Number(totalItensSpan.textContent || "0");
+      const totalPages = Math.max(1, Math.ceil(total / pageSize));
+      if (currentPage < totalPages) {
+        currentPage++;
+        await garantirDadosParaPagina(currentPage);
+        aplicarFiltrosETabela();
+      } else if (temMaisLancamentos) {
+        await garantirDadosParaPagina(currentPage + 1);
+        const novoTotal = Number(totalItensSpan.textContent || "0");
+        const novasPaginas = Math.max(1, Math.ceil(novoTotal / pageSize));
+        if (currentPage < novasPaginas) {
+          currentPage++;
+          aplicarFiltrosETabela();
+        }
+      }
+    });
 
     /* ===== EXPORTAR ===== */
     btnExportExcel.addEventListener("click", () => {
       if (!window.XLSX) {
         showAlert("Biblioteca de Excel não carregou.");
         return;
       }
 
       const dados = [
         [
           "Loja",
           "Data lançamento",
           "Departamento",
           "Cód. barras",
           "Descrição",
           "Qtd",
           "Validade",
           "Status",
           "Oferta",
           "Lote",
           "Usuário",
           "Lançado em",
           "Obs."
         ]
       ];
@@ -2701,162 +2785,184 @@
           fillColor: [15, 23, 42]
         }
       });
 
       docPdf.save("controle-validade.pdf");
     });
 
     btnMarcarTodosOferta.addEventListener("click", async () => {
       if (!confirm("Marcar todos os itens filtrados como 'Lançado'?")) return;
 
       const promises = lancamentosCache.map((item) =>
         updateDoc(doc(db, "lancamentos", item.id), { oferta: "lancado" })
       );
       try {
         await Promise.all(promises);
         lancamentosCache.forEach((item) => (item.oferta = "lancado"));
         aplicarFiltrosETabela();
         atualizarDashboard();
       } catch (err) {
         console.error(err);
         showAlert("Erro ao marcar ofertas.");
       }
     });
 
     /* ===== ADMIN USUÁRIOS ===== */
-    async function carregarUsuarios() {
-      if (perfilAtual !== "admin") return;
-      const snap = await getDocs(collection(db, "usuarios"));
-      usuariosBody.innerHTML = "";
-      snap.forEach((docSnap) => {
-        const item = docSnap.data();
-        const id = docSnap.id;
-
-        const tr = document.createElement("tr");
-        const tdNome = document.createElement("td");
-        tdNome.textContent = item.nome || "";
-
-        const tdEmail = document.createElement("td");
-        tdEmail.textContent = item.email || "";
-
-        const tdPerfil = document.createElement("td");
-        const selPerfil = document.createElement("select");
-        ["repositor", "gerente", "gestor_categoria", "assistente_comercial", "admin", "pendente"].forEach(
-          (optVal) => {
-            const opt = document.createElement("option");
-            opt.value = optVal;
-            opt.textContent = optVal;
-            if ((item.tipo || "repositor") === optVal) opt.selected = true;
-            selPerfil.appendChild(opt);
-          }
-        );
-        tdPerfil.appendChild(selPerfil);
-
-        const tdLoja = document.createElement("td");
-        const selLoja = document.createElement("select");
-        [
-          { v: "", t: "Nenhuma" },
-          { v: "Ponta Verde", t: "Ponta Verde" },
-          { v: "Parque", t: "Parque" },
-          { v: "Farol", t: "Farol" },
-          { v: "Praia", t: "Praia" },
-          { v: "Aldebaran", t: "Aldebaran" },
-          { v: "Parque Shopping", t: "Parque Shopping" }
-        ].forEach((o) => {
-          const opt = document.createElement("option");
-          opt.value = o.v;
-          opt.textContent = o.t;
-          if ((item.loja || "") === o.v) opt.selected = true;
-          selLoja.appendChild(opt);
-        });
-        tdLoja.appendChild(selLoja);
-
-        const tdAcoes = document.createElement("td");
-        const btnSalvar = document.createElement("button");
-        btnSalvar.textContent = "Salvar";
-        btnSalvar.style.color = "#22c55e";
-        btnSalvar.style.background = "transparent";
-        btnSalvar.style.border = "none";
-        btnSalvar.style.cursor = "pointer";
-        btnSalvar.style.marginRight = "8px";
-
-        const btnExcluir = document.createElement("button");
-        btnExcluir.textContent = "Excluir";
-        btnExcluir.style.color = "#fb7185";
-        btnExcluir.style.background = "transparent";
-        btnExcluir.style.border = "none";
-        btnExcluir.style.cursor = "pointer";
-
-        btnSalvar.addEventListener("click", async () => {
-          try {
-            await updateDoc(doc(db, "usuarios", id), {
-              tipo: selPerfil.value,
-              loja: selLoja.value
-            });
-            showAlert("Usuário atualizado.");
-          } catch (err) {
-            console.error(err);
-            showAlert("Erro ao salvar usuário.");
-          }
-        });
-
-        btnExcluir.addEventListener("click", async () => {
-          if (!confirm("Excluir usuário do controle (não apaga do Auth)?")) return;
-          try {
-            await deleteDoc(doc(db, "usuarios", id));
-            await carregarUsuarios();
-          } catch (err) {
-            console.error(err);
-            showAlert("Erro ao excluir usuário.");
-          }
-        });
-
-        tdAcoes.appendChild(btnSalvar);
-        tdAcoes.appendChild(btnExcluir);
-
-        [tdNome, tdEmail, tdPerfil, tdLoja, tdAcoes].forEach((td) => tr.appendChild(td));
-        usuariosBody.appendChild(tr);
-      });
-    }
+    async function carregarUsuarios() {
+      if (perfilAtual !== "admin") return;
+      try {
+        const snap = await getDocs(collection(db, "usuarios"));
+        usuariosBody.innerHTML = "";
+        snap.forEach((docSnap) => {
+          const item = docSnap.data();
+          const id = docSnap.id;
+
+          const tr = document.createElement("tr");
+          const tdNome = document.createElement("td");
+          tdNome.textContent = item.nome || "";
+
+          const tdEmail = document.createElement("td");
+          tdEmail.textContent = item.email || "";
+
+          const tdPerfil = document.createElement("td");
+          const selPerfil = document.createElement("select");
+          ["repositor", "gerente", "gestor_categoria", "assistente_comercial", "admin", "pendente"].forEach(
+            (optVal) => {
+              const opt = document.createElement("option");
+              opt.value = optVal;
+              opt.textContent = optVal;
+              if ((item.tipo || "repositor") === optVal) opt.selected = true;
+              selPerfil.appendChild(opt);
+            }
+          );
+          tdPerfil.appendChild(selPerfil);
+
+          const tdLoja = document.createElement("td");
+          const selLoja = document.createElement("select");
+          [
+            { v: "", t: "Nenhuma" },
+            { v: "Ponta Verde", t: "Ponta Verde" },
+            { v: "Parque", t: "Parque" },
+            { v: "Farol", t: "Farol" },
+            { v: "Praia", t: "Praia" },
+            { v: "Aldebaran", t: "Aldebaran" },
+            { v: "Parque Shopping", t: "Parque Shopping" }
+          ].forEach((o) => {
+            const opt = document.createElement("option");
+            opt.value = o.v;
+            opt.textContent = o.t;
+            if ((item.loja || "") === o.v) opt.selected = true;
+            selLoja.appendChild(opt);
+          });
+          tdLoja.appendChild(selLoja);
+
+          const tdAcoes = document.createElement("td");
+          const btnSalvar = document.createElement("button");
+          btnSalvar.textContent = "Salvar";
+          btnSalvar.style.color = "#22c55e";
+          btnSalvar.style.background = "transparent";
+          btnSalvar.style.border = "none";
+          btnSalvar.style.cursor = "pointer";
+          btnSalvar.style.marginRight = "8px";
+
+          const btnExcluir = document.createElement("button");
+          btnExcluir.textContent = "Excluir";
+          btnExcluir.style.color = "#fb7185";
+          btnExcluir.style.background = "transparent";
+          btnExcluir.style.border = "none";
+          btnExcluir.style.cursor = "pointer";
+
+          btnSalvar.addEventListener("click", async () => {
+            try {
+              await updateDoc(doc(db, "usuarios", id), {
+                tipo: selPerfil.value,
+                loja: selLoja.value
+              });
+              showAlert("Usuário atualizado.");
+            } catch (err) {
+              console.error(err);
+              showAlert("Erro ao salvar usuário.");
+            }
+          });
+
+          btnExcluir.addEventListener("click", async () => {
+            if (!confirm("Excluir usuário do controle (não apaga do Auth)?")) return;
+            try {
+              await deleteDoc(doc(db, "usuarios", id));
+              await carregarUsuarios();
+            } catch (err) {
+              console.error(err);
+              showAlert("Erro ao excluir usuário.");
+            }
+          });
+
+          tdAcoes.appendChild(btnSalvar);
+          tdAcoes.appendChild(btnExcluir);
+
+          [tdNome, tdEmail, tdPerfil, tdLoja, tdAcoes].forEach((td) => tr.appendChild(td));
+          usuariosBody.appendChild(tr);
+        });
+      } catch (err) {
+        console.error(err);
+        showAlert("Erro ao carregar usuários. Tente novamente.");
+      }
+    }
 
     btnReloadUsuarios.addEventListener("click", carregarUsuarios);
 
-    btnSalvarUsuario.addEventListener("click", async () => {
-      const nome = novoUsuarioNome.value.trim();
-      const email = novoUsuarioEmail.value.trim();
-      const tipo = novoUsuarioPerfil.value;
-      const loja = novoUsuarioLoja.value;
-
-      if (!email) {
-        showAlert("Informe o e-mail do usuário.");
-        return;
-      }
-
-      try {
-        await addDoc(collection(db, "usuarios"), {
-          nome,
-          email,
+    btnSalvarUsuario.addEventListener("click", async () => {
+      const nome = novoUsuarioNome.value.trim();
+      const email = novoUsuarioEmail.value.trim();
+      const tipo = novoUsuarioPerfil.value;
+      const loja = novoUsuarioLoja.value;
+
+      if (!email) {
+        showAlert("Informe o e-mail do usuário.");
+        return;
+      }
+
+      const emailValido = /.+@.+\..+/.test(email);
+      if (!emailValido) {
+        showAlert("E-mail inválido.");
+        return;
+      }
+
+      try {
+        const usuarioExistenteQuery = query(
+          collection(db, "usuarios"),
+          where("email", "==", email),
+          limit(1)
+        );
+        const usuarioExistenteSnap = await getDocs(usuarioExistenteQuery);
+        if (!usuarioExistenteSnap.empty) {
+          showAlert("Já existe um cadastro para este e-mail.");
+          return;
+        }
+
+        await addDoc(collection(db, "usuarios"), {
+          nome,
+          email,
           tipo,
           loja,
           criadoEm: serverTimestamp()
         });
         showAlert("Usuário salvo. Lembre de vincular o mesmo e-mail na conta de login.");
         novoUsuarioNome.value = "";
         novoUsuarioEmail.value = "";
         novoUsuarioLoja.value = "";
         novoUsuarioPerfil.value = "repositor";
         await carregarUsuarios();
       } catch (err) {
         console.error(err);
         showAlert("Erro ao salvar usuário.");
       }
     });
 
     /* ===== SCANNER (SIMPLIFICADO) ===== */
     async function abrirScanner() {
       scannerModal.classList.add("show");
 
       if (html5QrCode) return;
 
       try {
         html5QrCode = new Html5Qrcode("qr-reader");
         scannerAtivo = true;
 
EOF
)
