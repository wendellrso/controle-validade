// ===== SCANNER (usando script global + c칙mera traseira) =====
async function abrirScanner() {
  // Mostra o modal primeiro
  scannerModal.classList.add("show");

  // Verifica se a lib foi carregada
  if (!window.Html5Qrcode) {
    showAlert(
      "Leitor de c칩digo de barras n칚o carregou corretamente.\n\n" +
      "1) Verifique se a internet est치 ok\n" +
      "2) Atualize a p치gina\n" +
      "3) Se continuar, fale comigo que ajusto de novo 游땔"
    );
    fecharScanner();
    return;
  }

  if (html5QrCode) return;

  // Cria inst칙ncia
  html5QrCode = new window.Html5Qrcode("qr-reader");
  scannerAtivo = true;

  try {
    const devices = await window.Html5Qrcode.getCameras();
    if (!devices || devices.length === 0) {
      showAlert("Nenhuma c칙mera encontrada no dispositivo.");
      fecharScanner();
      return;
    }

    // Tenta usar a c칙mera traseira
    let cameraId = devices[0].id;
    const traseira = devices.find((d) => {
      const label = (d.label || "").toLowerCase();
      return (
        label.includes("back") ||
        label.includes("traseira") ||
        label.includes("rear")
      );
    });

    if (traseira) cameraId = traseira.id;
    else if (devices.length > 1) cameraId = devices[devices.length - 1].id;

    // Configura칞칚o b치sica
    const config = {
      fps: 10,
      qrbox: { width: 250, height: 250 }
    };

    // Se o objeto de formatos existir, filtra para EAN-13
    if (
      window.Html5QrcodeSupportedFormats &&
      window.Html5QrcodeSupportedFormats.EAN_13
    ) {
      config.formatsToSupport = [window.Html5QrcodeSupportedFormats.EAN_13];
    }

    await html5QrCode.start(
      cameraId,
      config,
      (decodedText) => {
        // S칩 aceita n칰meros de 8 a 13 d칤gitos
        if (/^[0-9]{8,13}$/.test(decodedText)) {
          codigoBarras.value = decodedText;
          fecharScanner();
        }
      },
      () => {
        // callback de falha de leitura (mant칠m em branco)
      }
    );
  } catch (err) {
    console.error(err);
    showAlert("Erro ao iniciar a c칙mera para leitura do c칩digo de barras.");
    fecharScanner();
  }
}

async function fecharScanner() {
  scannerModal.classList.remove("show");
  if (html5QrCode && scannerAtivo) {
    scannerAtivo = false;
    try {
      await html5QrCode.stop();
    } catch (err) {
      console.error(err);
    }
    try {
      await html5QrCode.clear();
    } catch (err) {
      console.error(err);
    }
    html5QrCode = null;
  }
}

btnScan.addEventListener("click", abrirScanner);
btnCloseScanner.addEventListener("click", fecharScanner);
scannerModal.addEventListener("click", (e) => {
  if (e.target === scannerModal) fecharScanner();
});
