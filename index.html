<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Controle de Validade ‚Äì Mercearia</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #f4f4f5;
      color: #111827;
    }
    header {
      background: #111827;
      color: #f9fafb;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    header h1 {
      margin: 0;
      font-size: 18px;
    }
    .user-info {
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .user-email {
      opacity: 0.8;
    }
    .btn-small {
      border: 1px solid #e5e7eb;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 11px;
      background: #f9fafb;
      cursor: pointer;
    }
    main {
      max-width: 1100px;
      margin: 0 auto;
      padding: 16px;
    }
    .card {
      background: #ffffff;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
      margin-bottom: 16px;
    }
    .card h2 {
      margin-top: 0;
      font-size: 18px;
    }
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      margin-bottom: 12px;
    }
    label {
      font-size: 12px;
      color: #4b5563;
      display: block;
      margin-bottom: 4px;
    }
    input, select, textarea {
      width: 100%;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 14px;
      box-sizing: border-box;
    }
    textarea {
      min-height: 60px;
      resize: vertical;
    }
    button {
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
      transition: transform 0.05s ease, box-shadow 0.1s ease, opacity 0.1s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }
    .btn-primary {
      background: #111827;
      color: #f9fafb;
      box-shadow: 0 10px 20px rgba(15, 23, 42, 0.4);
    }
    .btn-primary:active {
      transform: scale(0.97);
      box-shadow: 0 5px 10px rgba(15, 23, 42, 0.3);
    }
    .btn-outline {
      background: #ffffff;
      color: #111827;
      border: 1px solid #d1d5db;
    }
    .btn-outline.active {
      background: #111827;
      color: #f9fafb;
      border-color: #111827;
    }

    .btn-google {
      background: #ffffff;
      border: 1px solid #d1d5db;
      font-size: 13px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 14px;
    }
    .google-icon {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border: 1px solid #d1d5db;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 13px;
      background: #fff;
    }
    .btn-apple {
      background: #000000;
      color: #ffffff;
      border: none;
      font-size: 13px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 14px;
      border-radius: 999px;
    }
    .apple-icon {
      font-size: 18px;
    }

    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 8px;
      align-items: center;
    }
    .search-box {
      margin-top: 8px;
    }
    .search-box input {
      max-width: 260px;
    }
    .table-wrapper {
      overflow-x: auto;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      background: #ffffff;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    thead {
      background: #f9fafb;
    }
    th, td {
      padding: 8px 10px;
      text-align: left;
      border-bottom: 1px solid #e5e7eb;
    }
    th {
      font-weight: 600;
      font-size: 12px;
      color: #4b5563;
    }
    tbody tr:last-child td {
      border-bottom: none;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      font-size: 11px;
      border-radius: 999px;
      font-weight: 500;
    }
    .badge-ok {
      background: #dcfce7;
      color: #166534;
    }
    .badge-alerta {
      background: #fef9c3;
      color: #854d0e;
    }
    .badge-vencido {
      background: #fee2e2;
      color: #991b1b;
    }
    .tag-loja {
      font-size: 11px;
      background: #e5e7eb;
      border-radius: 999px;
      padding: 2px 8px;
    }
    .empty-state {
      text-align: center;
      padding: 24px;
      color: #6b7280;
      font-size: 14px;
    }
    .small {
      font-size: 12px;
      color: #6b7280;
      margin-top: 4px;
    }
    .hidden {
      display: none !important;
    }

    .login-layout {
      max-width: 420px;
      margin: 0 auto;
    }
    .login-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .login-subtitle {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 16px;
    }
    .login-toggle {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }
    .login-toggle button {
      flex: 1;
      justify-content: center;
      font-size: 13px;
      padding: 6px 10px;
    }
    .login-footer {
      font-size: 12px;
      color: #6b7280;
      margin-top: 12px;
      text-align: center;
    }
    .login-footer button {
      font-size: 12px;
      padding: 0;
      border: none;
      background: none;
      color: #111827;
      text-decoration: underline;
      box-shadow: none;
    }
    .error-msg {
      font-size: 12px;
      color: #b91c1c;
      margin-top: 6px;
      min-height: 16px;
    }

    .admin-table table {
      font-size: 13px;
    }
    .admin-table select {
      font-size: 12px;
      padding: 4px 6px;
    }
    .admin-table button {
      font-size: 12px;
      padding: 4px 10px;
    }

    /* Overlay para o scanner de c√≥digo de barras */
    #scannerOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.55);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }

    @media (max-width: 640px) {
      /* esconder algumas colunas no mobile pra n√£o virar bagun√ßa */
      th:nth-child(4),
      td:nth-child(4),
      th:nth-child(5),
      td:nth-child(5),
      th:nth-child(6),
      td:nth-child(6),
      th:nth-child(10),
      td:nth-child(10),
      th:nth-child(12),
      td:nth-child(12),
      th:nth-child(13),
      td:nth-child(13) {
        display: none;
      }
      header {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>

  <!-- jsPDF para PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- jsPDF AutoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
  <!-- SheetJS para Excel .xlsx -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- html5-qrcode para leitura de c√≥digo de barras com a c√¢mera -->
  <script src="https://unpkg.com/html5-qrcode@2.3.10/html5-qrcode.min.js"></script>
</head>
<body>
  <header>
    <h1>Controle de Validade ‚Äì Mercearia</h1>
    <div class="user-info" id="userInfo">
      <span class="user-email" id="userEmail"></span>
      <button class="btn-small hidden" id="btnLogout">Sair</button>
    </div>
  </header>

  <!-- Overlay do scanner -->
  <div id="scannerOverlay" class="hidden">
    <div class="card" style="max-width: 400px; width: 90%; max-height: 80vh; overflow: hidden;">
      <h2>Escanear c√≥digo de barras</h2>
      <p class="small">Aponte a c√¢mera para o c√≥digo de barras do produto.</p>
      <div id="reader" style="width: 100%; max-width: 360px; margin: 0 auto;"></div>
      <div style="margin-top: 12px; display: flex; justify-content: flex-end; gap: 8px;">
        <button class="btn-outline" id="btnFecharScanner">Cancelar</button>
      </div>
    </div>
  </div>

  <main>
    <!-- TELA DE LOGIN -->
    <section class="card login-layout" id="loginCard">
      <div class="login-title">Entrar no sistema</div>
      <div class="login-subtitle">
        Fa√ßa login para lan√ßar e consultar produtos por validade.
      </div>

      <div class="login-toggle">
        <button class="btn-outline active" id="btnModoLogin">Entrar</button>
        <button class="btn-outline" id="btnModoCadastro">Criar conta</button>
      </div>

      <div class="form-grid">
        <div style="grid-column: 1 / -1;">
          <label for="emailAuth">E-mail</label>
          <input type="email" id="emailAuth" placeholder="seu.email@exemplo.com" />
        </div>
        <div style="grid-column: 1 / -1;">
          <label for="senhaAuth">Senha</label>
          <input type="password" id="senhaAuth" placeholder="m√≠nimo 6 caracteres" />
        </div>
      </div>

      <button class="btn-primary" id="btnAuthMain">Entrar</button>

      <div style="margin-top: 12px; text-align:center; display:flex; flex-direction:column; gap:8px; align-items:center;">
        <button class="btn-google" id="btnGoogle">
          <span class="google-icon">G</span>
          <span>Entrar com Google</span>
        </button>

        <button class="btn-apple" id="btnApple">
          <span class="apple-icon">Ô£ø</span>
          <span>Entrar com Apple</span>
        </button>
      </div>

      <div class="error-msg" id="authError"></div>

      <div class="login-footer">
        Qualquer pessoa pode criar uma conta e usar o sistema.<br/>
        <button id="btnEsqueceuSenha">Esqueci minha senha</button>
      </div>
    </section>

    <!-- APP (S√ì APARECE LOGADO) -->
    <section id="appContent" class="hidden">
      <!-- NOVO LAN√áAMENTO / EDI√á√ÉO -->
      <section class="card">
        <h2 id="tituloFormulario">Novo lan√ßamento</h2>
        <div class="form-grid">
          <!-- Loja -->
          <div>
            <label for="loja">Loja</label>
            <select id="loja">
              <option value="">Selecione...</option>
              <option value="PV">Ponta Verde</option>
              <option value="Farol">Farol</option>
              <option value="Praia">Praia</option>
              <option value="Riomar">Riomar</option>
            </select>
            <div class="small" id="ajudaCampoLoja"></div>
          </div>

          <!-- Data de lan√ßamento (hoje, travada) -->
          <div>
            <label for="dataLancamento">Data de lan√ßamento</label>
            <input type="date" id="dataLancamento" disabled />
            <div class="small">Sempre a data de hoje, registrada automaticamente.</div>
          </div>

          <!-- Departamento -->
          <div>
            <label for="departamento">Departamento</label>
            <select id="departamento">
              <option value="">Selecione...</option>
              <option value="A√ßougue">A√ßougue</option>
              <option value="Adega">Adega</option>
              <option value="Bebidas">Bebidas</option>
              <option value="Mercearia Alimentos">Mercearia Alimentos</option>
              <option value="Mercearia N√£o Alimentos">Mercearia N√£o Alimentos</option>
              <option value="Perec√≠veis Processados">Perec√≠veis Processados</option>
            </select>
          </div>

          <!-- C√≥digo de barras + bot√£o c√¢mera -->
          <div>
            <label for="codigoBarras">C√≥d. barras (n√∫meros, m√°x. 13)</label>
            <div style="display: flex; gap: 8px; align-items: center;">
              <input
                type="text"
                id="codigoBarras"
                maxlength="13"
                inputmode="numeric"
                pattern="\\d*"
                placeholder="7891234567890"
              />
              <button type="button" class="btn-outline" id="btnScanCodigo" title="Escanear c√≥digo de barras">
                üì∑
              </button>
            </div>
            <div class="small">Voc√™ pode digitar ou usar a c√¢mera para escanear.</div>
          </div>

          <!-- Descri√ß√£o -->
          <div>
            <label for="descricao">Descri√ß√£o</label>
            <input type="text" id="descricao" />
          </div>

          <!-- Lote -->
          <div>
            <label for="lote">Lote</label>
            <input type="text" id="lote" />
          </div>

          <!-- Quantidade -->
          <div>
            <label for="quantidade">Quantidade</label>
            <input type="number" id="quantidade" min="1" />
          </div>

          <!-- Validade -->
          <div>
            <label for="validade">Data de validade</label>
            <input type="date" id="validade" />
          </div>

          <!-- Observa√ß√£o -->
          <div style="grid-column: 1 / -1;">
            <label for="observacao">Observa√ß√£o</label>
            <textarea id="observacao" placeholder="Ex.: ponta de g√¥ndola, oferta, avaria..."></textarea>
          </div>
        </div>
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
          <button class="btn-primary" id="btnSalvar">Salvar lan√ßamento</button>
          <button class="btn-outline hidden" id="btnCancelarEdicao">Cancelar edi√ß√£o</button>
        </div>
        <div class="small">
          * Status √© calculado automaticamente:<br />
          <strong>OK</strong> (&gt; 30 dias) ¬∑
          <strong>Vence em 30 dias</strong> (16‚Äì30 dias) ¬∑
          <strong>Vence em 15 dias</strong> (8‚Äì15 dias) ¬∑
          <strong>Vence em 7 dias</strong> (0‚Äì7 dias) ¬∑
          <strong>Vencido</strong> (&lt; 0 dias)
        </div>
      </section>

      <!-- LISTAGEM DE ITENS -->
      <section class="card">
        <h2>Itens cadastrados</h2>

        <!-- Filtros de status -->
        <div class="filters">
          <button class="btn-outline active" data-filter="todos">Todos</button>
          <button class="btn-outline" data-filter="vence7">Vence em 7 dias</button>
          <button class="btn-outline" data-filter="vence15">Vence em 15 dias</button>
          <button class="btn-outline" data-filter="vence30">Vence em 30 dias</button>
          <button class="btn-outline" data-filter="vencido">Vencidos</button>
        </div>

        <!-- Filtro de departamento + exporta√ß√µes -->
        <div class="filters">
          <div>
            <label for="filtroDepartamento">Departamento</label>
            <select id="filtroDepartamento">
              <option value="todos">Todos os departamentos</option>
              <option value="A√ßougue">A√ßougue</option>
              <option value="Adega">Adega</option>
              <option value="Bebidas">Bebidas</option>
              <option value="Mercearia Alimentos">Mercearia Alimentos</option>
              <option value="Mercearia N√£o Alimentos">Mercearia N√£o Alimentos</option>
              <option value="Perec√≠veis Processados">Perec√≠veis Processados</option>
            </select>
          </div>

          <div style="flex:1"></div>

          <button class="btn-outline" id="btnExportExcel">Exportar Excel (.xlsx)</button>
          <button class="btn-outline" id="btnExportPDF">Exportar PDF</button>
        </div>

        <div class="search-box">
          <label for="busca">Buscar por descri√ß√£o ou c√≥digo de barras:</label>
          <input type="text" id="busca" placeholder="Digite para filtrar..." />
        </div>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Loja</th>
                <th>Departamento</th>
                <th>Produto</th>
                <th>C√≥d. barras</th>
                <th>Lote</th>
                <th>Data lan√ßamento</th>
                <th>Validade</th>
                <th>Status</th>
                <th>Qtd</th>
                <th>Dias p/ vencer</th>
                <th>Usu√°rio</th>
                <th>Cadastro</th>
                <th>Obs.</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody id="tabelaCorpo">
              <!-- Linhas via JS -->
            </tbody>
          </table>
        </div>
        <div class="small">
          Base √∫nica para todas as lojas (Firestore). Depois d√° pra criar vis√µes s√≥ por loja.
        </div>
      </section>

      <!-- ADMIN ‚Äì GERENCIAMENTO DE USU√ÅRIOS (S√ì ADMIN V√ä) -->
      <section class="card hidden" id="adminCard">
        <h2>Administra√ß√£o de usu√°rios</h2>
        <p class="small">
          Somente administradores veem esta se√ß√£o. Aqui voc√™ ajusta o tipo e a loja de cada usu√°rio.
        </p>
        <div class="table-wrapper admin-table">
          <table>
            <thead>
              <tr>
                <th>E-mail</th>
                <th>Tipo</th>
                <th>Loja</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody id="adminTabelaCorpo">
              <!-- Linhas geradas via JS -->
            </tbody>
          </table>
        </div>
      </section>
    </section>
  </main>

  <!-- SCRIPT PRINCIPAL -->
  <script type="module">
    // IMPORTS DO FIREBASE (CDN)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      getDocs,
      query,
      orderBy,
      doc,
      getDoc,
      setDoc,
      updateDoc,
      deleteDoc
    } from "https://www.gstatic.com/firebasejs/11.0.0/firebase
