<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Controle de Validade • Palato</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Versão consolidada para cópia manual -->

  <!-- Ícone -->
  <link rel="icon" href="palato-logo.png" />

  <!-- SheetJS para Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- jsPDF para PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
  <!-- html5-qrcode (scanner) -->
  <script src="html5-qrcode.min.js"></script>

  <style>
    :root {
      --bg-main: #050509;
      --bg-card: #11141b;
      --bg-card-alt: #181b23;
      --accent-red: #e30613;
      --accent-red-soft: #ff4b5c;
      --border-soft: #262a33;
      --text-main: #ffffff;
      --text-soft: #9ca3af;
      --badge-bg: #1f2933;
      --badge-red-bg: #3b0710;
      --badge-red-border: #ff4b5c;
      --badge-green-bg: #073b1f;
      --badge-green-border: #4ade80;
      --input-bg: #050509;
      --input-border: #272a33;
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      background: radial-gradient(circle at top, #111827 0, #050509 45%, #000 100%);
      color: var(--text-main);
    }

    /* ===== LOGIN ===== */

    #loginView {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }

    .login-card {
      width: 100%;
      max-width: 420px;
      background: rgba(8, 10, 20, 0.98);
      border-radius: 24px;
      padding: 32px 28px 28px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.7);
      border: 1px solid rgba(255, 255, 255, 0.04);
    }

    .login-logo {
      display: flex;
      justify-content: center;
      margin-bottom: 16px;
    }

    .login-logo img {
      height: 32px;
    }

    .login-title {
      text-align: center;
      margin-bottom: 4px;
      font-size: 20px;
      letter-spacing: 0.12em;
    }

    .login-subtitle {
      text-align: center;
      margin-bottom: 24px;
      font-size: 13px;
      color: var(--text-soft);
    }

    .form-group {
      margin-bottom: 14px;
    }

    label {
      display: block;
      font-size: 13px;
      margin-bottom: 4px;
      color: var(--text-soft);
    }

    input[type="email"],
    input[type="password"] {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--input-border);
      background: var(--input-bg);
      color: var(--text-main);
      font-size: 14px;
    }

    input::placeholder {
      color: #4b5563;
    }

    .btn {
      border-radius: 999px;
      border: none;
      padding: 10px 16px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.08s ease;
    }

    .btn-primary {
      background: var(--accent-red);
      color: #fff;
      box-shadow: 0 10px 30px rgba(227, 6, 19, 0.5);
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 34px rgba(227, 6, 19, 0.7);
    }

    .btn-google {
      width: 100%;
      margin-top: 10px;
      background: #111827;
      color: #e5e7eb;
      border: 1px solid #374151;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-google img {
      height: 16px;
    }

    .btn-full {
      width: 100%;
      margin-top: 6px;
    }

    .btn-ghost {
      background: #020617;
      color: #e5e7eb;
      border: 1px solid #374151;
      font-size: 13px;
      padding: 6px 12px;
      border-radius: 999px;
      cursor: pointer;
    }

    .login-footer {
      margin-top: 14px;
      font-size: 12px;
      color: #6b7280;
      text-align: center;
    }

    /* ===== ONBOARDING ===== */

    #onboardingView {
      min-height: 100vh;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }

    .onboarding-card {
      max-width: 460px;
    }

    .onboarding-step-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--text-soft);
      margin-bottom: 6px;
    }

    .onboarding-title {
      margin: 0 0 8px;
      font-size: 22px;
    }

    .onboarding-subtitle {
      margin: 0 0 18px;
      font-size: 14px;
      color: var(--text-soft);
      line-height: 1.5;
    }

    .onboarding-actions {
      display: flex;
      gap: 10px;
      margin-top: 12px;
      align-items: center;
    }

    .onboarding-btn-primary {
      background: var(--accent-red);
      color: #fff;
      border: none;
      padding: 10px 16px;
      border-radius: 12px;
      cursor: pointer;
    }

    .onboarding-btn-secondary {
      background: transparent;
      color: #e5e7eb;
      border: 1px solid #30343c;
      padding: 10px 16px;
      border-radius: 12px;
      cursor: pointer;
    }

    /* ===== LAYOUT ===== */

    .app-container {
      display: none;
      min-height: 100vh;
      background: radial-gradient(circle at 10% 10%, #0e1320 0%, #050509 45%, #000 100%);
    }

    .app-header {
      position: sticky;
      top: 0;
      z-index: 30;
      backdrop-filter: blur(12px);
      background: rgba(5, 5, 9, 0.92);
      border-bottom: 1px solid rgba(255, 255, 255, 0.04);
      padding: 12px 16px;
    }

    .app-header-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .logo-brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-brand img {
      height: 32px;
    }

    .logo-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .logo-text strong {
      letter-spacing: 0.08em;
      font-size: 13px;
    }

    .logo-text span {
      font-size: 11px;
      color: var(--text-soft);
      letter-spacing: 0.06em;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: var(--badge-bg);
      color: #fff;
      font-size: 12px;
      border: 1px solid rgba(255, 255, 255, 0.04);
    }

    .badge.dot::before {
      content: "";
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--accent-red);
      display: inline-block;
    }

    .btn-logout {
      background: #0b0f17;
      color: #f3f4f6;
      border: 1px solid #1f2937;
      padding: 8px 12px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 13px;
    }

    .main-content {
      display: grid;
      grid-template-columns: 240px 1fr;
      gap: 18px;
      padding: 18px;
    }

    @media (max-width: 960px) {
      .main-content {
        grid-template-columns: 1fr;
      }

      .side-menu {
        position: fixed;
        inset: 0 40%;
        max-width: 280px;
        z-index: 50;
        transform: translateX(-100%);
        transition: transform 0.2s ease;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.6);
      }

      .side-menu.open {
        transform: translateX(0);
      }

      .menu-overlay {
        display: block;
      }

      .btn-toggle-menu {
        display: inline-flex;
      }
    }

    .menu-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(3px);
      z-index: 40;
      opacity: 0;
      transition: opacity 0.15s ease;
      pointer-events: none;
    }

    .menu-overlay.show {
      opacity: 1;
      pointer-events: all;
    }

    .side-menu {
      background: var(--bg-card);
      border: 1px solid rgba(255, 255, 255, 0.04);
      border-radius: 20px;
      padding: 12px;
      height: fit-content;
      position: sticky;
      top: 90px;
    }

    .user-box {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 10px;
      padding: 12px;
      background: var(--bg-card-alt);
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.04);
      align-items: center;
    }

    .user-avatar {
      width: 38px;
      height: 38px;
      border-radius: 12px;
      background: linear-gradient(145deg, #121826, #0a0f1a);
      border: 1px solid #1f2937;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: #f9fafb;
    }

    .user-info strong {
      display: block;
      font-size: 14px;
    }

    .user-info small {
      color: var(--text-soft);
      font-size: 12px;
    }

    .user-actions {
      margin-top: 12px;
      display: grid;
      gap: 8px;
    }

    .btn-menu {
      width: 100%;
      text-align: left;
      padding: 10px 12px;
      background: #0a0d14;
      color: #e5e7eb;
      border: 1px solid #1f2937;
      border-radius: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 13px;
      transition: background 0.12s ease;
    }

    .btn-menu.active {
      background: #111827;
      border-color: #2b3344;
    }

    .btn-toggle-menu {
      display: none;
      background: #0b0f17;
      color: #f3f4f6;
      border: 1px solid #1f2937;
      padding: 8px 12px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 13px;
    }

    .view {
      display: none;
    }

    .view.app-view-active {
      display: block;
    }

    .cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 12px;
      margin-bottom: 16px;
    }

    .card {
      background: var(--bg-card);
      border-radius: 20px;
      padding: 16px;
      border: 1px solid rgba(255, 255, 255, 0.04);
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
    }

    .card h3 {
      margin: 0 0 6px;
      font-size: 16px;
      letter-spacing: 0.02em;
    }

    .card small {
      color: var(--text-soft);
      font-size: 12px;
    }

    .section-title {
      margin: 0 0 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }

    .section-title h2 {
      margin: 0;
      font-size: 16px;
      letter-spacing: 0.02em;
    }

    .section-title .actions {
      display: flex;
      gap: 8px;
    }

    .input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--input-border);
      background: var(--input-bg);
      color: var(--text-main);
      font-size: 14px;
    }

    .input::placeholder {
      color: #4b5563;
    }

    .filters-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 10px;
      margin-bottom: 10px;
    }

    .table-card {
      overflow: hidden;
      padding: 0;
    }

    .table-header {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      padding: 12px 12px 4px;
    }

    .table-wrapper {
      overflow: auto;
      max-height: 60vh;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    th,
    td {
      text-align: left;
      padding: 10px;
      border-bottom: 1px solid #1f2530;
    }

    th {
      position: sticky;
      top: 0;
      background: var(--bg-card);
      z-index: 2;
    }

    tr:nth-child(odd) {
      background: rgba(255, 255, 255, 0.01);
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
    }

    .status-badge.red {
      background: var(--badge-red-bg);
      color: #ffb4c2;
      border: 1px solid var(--badge-red-border);
    }

    .status-badge.green {
      background: var(--badge-green-bg);
      color: #b7fbb7;
      border: 1px solid var(--badge-green-border);
    }

    .tag {
      display: inline-flex;
      align-items: center;
      padding: 4px 8px;
      border-radius: 8px;
      font-size: 12px;
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .chart-placeholder {
      margin-top: 16px;
      height: 180px;
      border-radius: 16px;
      border: 1px dashed #2d3340;
      display: grid;
      place-items: center;
      color: #4b5563;
      font-size: 13px;
    }

    .toast-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      display: grid;
      gap: 6px;
      z-index: 100;
    }

    .toast {
      background: #111827;
      color: #f9fafb;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid #1f2937;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      min-width: 240px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      font-size: 13px;
    }

    .toast button {
      background: none;
      border: none;
      color: #9ca3af;
      cursor: pointer;
    }

    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 90;
      padding: 16px;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: #0c1018;
      color: #f3f4f6;
      padding: 16px;
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.06);
      max-width: 420px;
      width: 100%;
    }

    .modal-content h3 {
      margin: 0 0 10px;
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 14px;
    }

    .qr-reader {
      width: 100%;
      min-height: 280px;
      background: #0b0f17;
      border-radius: 14px;
      border: 1px solid #1f2937;
      overflow: hidden;
    }

    .pagination {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .pagination button {
      padding: 6px 12px;
      border-radius: 10px;
      border: 1px solid #1f2937;
      background: #0b0f17;
      color: #e5e7eb;
      cursor: pointer;
      font-size: 12px;
    }

    .pagination .page-info {
      font-size: 12px;
      color: #9ca3af;
    }

    .badge-offer {
      background: rgba(234, 179, 8, 0.1);
      color: #fcd34d;
      border: 1px solid rgba(234, 179, 8, 0.4);
    }

    .badge-departamento {
      background: rgba(59, 130, 246, 0.1);
      color: #bfdbfe;
      border: 1px solid rgba(59, 130, 246, 0.4);
    }

    .input-inline {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }

    .input-inline input,
    .input-inline select {
      flex: 1;
      min-width: 160px;
    }

    .table-actions {
      display: flex;
      gap: 8px;
    }

    .btn-icon {
      background: #111827;
      color: #e5e7eb;
      border: 1px solid #1f2937;
      padding: 8px 10px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn-icon.danger {
      color: #fecdd3;
      border-color: #7f1d1d;
      background: #450a0a;
    }

    .btn-icon.success {
      color: #bbf7d0;
      border-color: #065f46;
      background: #064e3b;
    }

    .form-grid {
      display: grid;
      gap: 10px;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }

    .badge-warning {
      background: rgba(234, 179, 8, 0.1);
      color: #fef3c7;
      border: 1px solid rgba(234, 179, 8, 0.3);
    }

    .badge-info {
      background: rgba(59, 130, 246, 0.1);
      color: #bfdbfe;
      border: 1px solid rgba(59, 130, 246, 0.3);
    }

    .small-muted {
      color: #9ca3af;
      font-size: 12px;
      margin-top: 4px;
      display: block;
    }

    .table-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px 14px;
      font-size: 13px;
      color: #9ca3af;
      border-top: 1px solid #1f2937;
    }

    /* Exemplo de estado de linha: oferta ativa */
    tr.oferta-ativa {
      background: rgba(234, 179, 8, 0.06);
    }

    /* ===== PERFIL BODY ===== */
    body.perfil-admin .badge-perfil {
      background: linear-gradient(135deg, #dc2626, #ef4444);
      color: #fff;
    }

    body.perfil-admin .btn-primary {
      box-shadow: 0 10px 30px rgba(220, 38, 38, 0.35);
    }

    body.perfil-nao-admin .badge-perfil {
      background: linear-gradient(135deg, #4b5563, #1f2937);
      color: #fff;
    }

    /* ===== MOBILE AJUSTES ===== */
    @media (max-width: 720px) {
      .table-header {
        display: none;
      }

      table,
      thead,
      tbody,
      th,
      td,
      tr {
        display: block;
      }

      tr {
        margin-bottom: 10px;
        background: #0c1018;
        border-radius: 14px;
        border: 1px solid #1f2937;
        padding: 10px;
      }

      td {
        border: none;
        padding: 6px 0;
      }

      td::before {
        content: attr(data-label);
        display: block;
        font-size: 12px;
        color: #9ca3af;
        margin-bottom: 4px;
      }
    }
  </style>
</head>

<body>
  <div id="loginView">
    <div class="login-card">
      <div class="login-logo">
        <img src="palato-logo.png" alt="Logo Palato" />
      </div>
      <div class="login-title">Controle de Validade</div>
      <div class="login-subtitle">Acesse com sua conta corporativa</div>

      <div class="form-group">
        <label for="loginEmail">E-mail</label>
        <input type="email" id="loginEmail" placeholder="seu.email@palato.com" />
      </div>
      <div class="form-group">
        <label for="loginSenha">Senha</label>
        <input type="password" id="loginSenha" placeholder="••••••••" />
      </div>

      <button class="btn btn-primary btn-full" id="btnLoginEmail">Entrar</button>
      <button class="btn btn-google" id="btnLoginGoogle">
        <img src="https://www.svgrepo.com/show/475656/google-color.svg" alt="Google" />
        Entrar com Google
      </button>

      <div class="login-footer">Acesso restrito aos colaboradores Palato.</div>
    </div>
  </div>

  <div id="onboardingView">
    <div class="card onboarding-card">
      <div class="onboarding-step-label">Primeiro acesso</div>
      <h2 class="onboarding-title">Complete seu cadastro</h2>
      <p class="onboarding-subtitle">
        Precisamos saber seu perfil de acesso e loja de atuação para liberar o sistema.
      </p>

      <div class="form-group">
        <label>Perfil</label>
        <select class="input" id="onboardingPerfil">
          <option value="">Selecione...</option>
          <option value="repositor">Repositor</option>
          <option value="fiscal">Fiscal</option>
          <option value="adm">ADM</option>
          <option value="admin">Administrador</option>
        </select>
      </div>
      <div class="form-group">
        <label>Loja</label>
        <select class="input" id="onboardingLoja">
          <option value="">Selecione...</option>
          <option value="gracas">Graças</option>
          <option value="ponta_verde">Ponta Verde</option>
          <option value="farol">Farol</option>
          <option value="nerilandia">Nerilandia</option>
        </select>
      </div>

      <div class="onboarding-actions">
        <button class="onboarding-btn-primary" id="btnOnboardingSalvar">Salvar e continuar</button>
        <button class="onboarding-btn-secondary" id="btnOnboardingVoltarLogin">Sair</button>
      </div>

      <small class="small-muted">O administrador validará seu acesso antes de liberar.</small>
    </div>
  </div>

  <div class="app-container" id="appView">
    <div class="app-header">
      <div class="app-header-content">
        <div class="logo-brand">
          <button class="btn-toggle-menu" id="btnToggleMenu">Menu</button>
          <img src="palato-logo.png" alt="Palato" />
          <div class="logo-text">
            <strong>Controle de Validade</strong>
            <span>Frescor e segurança em primeiro lugar</span>
          </div>
        </div>

        <div class="header-right">
          <span class="badge badge-perfil" id="badgePerfil">Perfil: -</span>
          <span class="badge">Loja: <strong id="badgeLoja">-</strong></span>
          <button class="btn-logout" id="btnSair">Sair</button>
        </div>
      </div>
    </div>

    <div class="menu-overlay" id="menuOverlay"></div>
    <aside class="side-menu" id="sideMenu">
      <div class="user-box">
        <div class="user-avatar" id="userAvatar"></div>
        <div class="user-info">
          <strong id="userName"></strong>
          <small id="userEmail"></small>
          <small id="userPerfilLoja"></small>
        </div>
      </div>

      <div class="user-actions">
        <button class="btn-menu active" data-view="dashboard">Dashboard</button>
        <button class="btn-menu" data-view="cadastrar">Cadastrar lançamento</button>
        <button class="btn-menu" data-view="consulta">Consultar lançamentos</button>
        <button class="btn-menu" data-view="usuarios" id="menuUsuarios" style="display: none">
          Usuários
        </button>
      </div>
    </aside>

    <main class="main-content">
      <section class="view app-view-active" id="viewDashboard">
        <div class="section-title">
          <h2>Visão geral</h2>
          <div class="actions">
            <button class="btn-icon" id="btnExportarExcel">Exportar Excel</button>
            <button class="btn-icon" id="btnExportarPdf">Exportar PDF</button>
          </div>
        </div>

        <div class="cards-grid">
          <div class="card">
            <h3>Itens cadastrados</h3>
            <strong id="cardTotal">0</strong>
            <small>Itens registrados no período atual</small>
          </div>
          <div class="card">
            <h3>Itens com validade próxima</h3>
            <strong id="cardProximos">0</strong>
            <small>Vencem nos próximos 7 dias</small>
          </div>
          <div class="card">
            <h3>Itens vencidos</h3>
            <strong id="cardVencidos">0</strong>
            <small>Necessitam remoção imediata</small>
          </div>
          <div class="card">
            <h3>Em oferta</h3>
            <strong id="cardOferta">0</strong>
            <small>Itens marcados como oferta</small>
          </div>
        </div>

        <div class="card">
          <div class="section-title">
            <h2>Filtrar lançamentos</h2>
            <div class="actions">
              <button class="btn-icon" id="btnReload">Atualizar</button>
            </div>
          </div>

          <div class="filters-grid">
            <input class="input" type="text" id="filtroBusca" placeholder="Buscar por descrição ou código" />
            <select class="input" id="filtroDepartamento">
              <option value="">Departamento</option>
              <option value="mercearia">Mercearia</option>
              <option value="alimentos_bebidas">Alimentos e Bebidas</option>
              <option value="higiene_limpeza">Higiene e Limpeza</option>
              <option value="padaria">Padaria</option>
              <option value="frigorifico">Frigorífico</option>
              <option value="congelados">Congelados</option>
              <option value="hortifruti">Hortifruti</option>
              <option value="bazar_utilidades">Bazar e Utilidades</option>
              <option value="bebidas">Bebidas</option>
            </select>
            <select class="input" id="filtroOferta">
              <option value="">Oferta?</option>
              <option value="sim">Sim</option>
              <option value="nao">Não</option>
            </select>
            <select class="input" id="filtroStatus">
              <option value="">Status</option>
              <option value="vencido">Vencido</option>
              <option value="proximo">Próximo</option>
              <option value="ok">OK</option>
            </select>
            <input class="input" type="date" id="filtroDataInicio" />
            <input class="input" type="date" id="filtroDataFim" />
          </div>

          <div class="table-card">
            <div class="table-header">
              <strong>Descrição</strong>
              <strong>Cód. barras</strong>
              <strong>Validade</strong>
              <strong>Quantidade</strong>
              <strong>Oferta</strong>
              <strong>Departamento</strong>
              <strong>Ações</strong>
            </div>
            <div class="table-wrapper">
              <table id="tabelaLancamentos">
                <thead>
                  <tr>
                    <th>Descrição</th>
                    <th>Cód. barras</th>
                    <th>Validade</th>
                    <th>Quantidade</th>
                    <th>Oferta</th>
                    <th>Departamento</th>
                    <th>Loja</th>
                    <th>Status</th>
                    <th>Ações</th>
                  </tr>
                </thead>
                <tbody id="tabelaBody"></tbody>
              </table>
            </div>
            <div class="table-footer">
              <div id="infoTotal"></div>
              <div class="pagination">
                <button id="btnPrevPage">Anterior</button>
                <button id="btnNextPage">Próxima</button>
                <span class="page-info" id="pageInfo">Página 1</span>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section class="view" id="viewCadastrar">
        <div class="section-title">
          <h2>Novo lançamento</h2>
          <div class="actions">
            <button class="btn-icon" id="btnScan">Ler código de barras</button>
          </div>
        </div>

        <div class="card">
          <div class="form-grid">
            <div class="form-group">
              <label for="descricao">Descrição do produto</label>
              <input class="input" type="text" id="descricao" placeholder="Ex: Queijo parmesão" />
            </div>
            <div class="form-group">
              <label for="codigoBarras">Código de barras</label>
              <input class="input" type="text" id="codigoBarras" placeholder="EAN" />
            </div>
            <div class="form-group">
              <label for="validade">Validade</label>
              <input class="input" type="date" id="validade" />
            </div>
            <div class="form-group">
              <label for="quantidade">Quantidade</label>
              <input class="input" type="number" id="quantidade" min="0" step="1" placeholder="Qtd" />
            </div>
            <div class="form-group">
              <label for="departamento">Departamento</label>
              <select class="input" id="departamento">
                <option value="">Selecione...</option>
                <option value="mercearia">Mercearia</option>
                <option value="alimentos_bebidas">Alimentos e Bebidas</option>
                <option value="higiene_limpeza">Higiene e Limpeza</option>
                <option value="padaria">Padaria</option>
                <option value="frigorifico">Frigorífico</option>
                <option value="congelados">Congelados</option>
                <option value="hortifruti">Hortifruti</option>
                <option value="bazar_utilidades">Bazar e Utilidades</option>
                <option value="bebidas">Bebidas</option>
              </select>
            </div>
            <div class="form-group">
              <label for="oferta">Oferta?</label>
              <select class="input" id="oferta">
                <option value="nao">Não</option>
                <option value="sim">Sim</option>
              </select>
            </div>
            <div class="form-group">
              <label for="observacao">Observação</label>
              <input class="input" type="text" id="observacao" placeholder="Ex: Unidade danificada" />
            </div>
          </div>

          <div class="input-inline">
            <button class="btn btn-primary" id="btnSalvar">Salvar lançamento</button>
            <small class="small-muted">Preencha todos os campos obrigatórios.</small>
          </div>
        </div>
      </section>

      <section class="view" id="viewConsulta">
        <div class="section-title">
          <h2>Consulta</h2>
          <div class="actions">
            <button class="btn-icon" id="btnReloadConsulta">Atualizar</button>
          </div>
        </div>

        <div class="card">
          <div class="filters-grid">
            <input class="input" type="text" id="consultaBusca" placeholder="Buscar por descrição ou código" />
            <select class="input" id="consultaDepartamento">
              <option value="">Departamento</option>
              <option value="mercearia">Mercearia</option>
              <option value="alimentos_bebidas">Alimentos e Bebidas</option>
              <option value="higiene_limpeza">Higiene e Limpeza</option>
              <option value="padaria">Padaria</option>
              <option value="frigorifico">Frigorífico</option>
              <option value="congelados">Congelados</option>
              <option value="hortifruti">Hortifruti</option>
              <option value="bazar_utilidades">Bazar e Utilidades</option>
              <option value="bebidas">Bebidas</option>
            </select>
            <select class="input" id="consultaOferta">
              <option value="">Oferta?</option>
              <option value="sim">Sim</option>
              <option value="nao">Não</option>
            </select>
            <select class="input" id="consultaStatus">
              <option value="">Status</option>
              <option value="vencido">Vencido</option>
              <option value="proximo">Próximo</option>
              <option value="ok">OK</option>
            </select>
            <input class="input" type="date" id="consultaDataInicio" />
            <input class="input" type="date" id="consultaDataFim" />
          </div>

          <div class="table-card">
            <div class="table-wrapper">
              <table id="consultaTabela">
                <thead>
                  <tr>
                    <th>Descrição</th>
                    <th>Cód. barras</th>
                    <th>Validade</th>
                    <th>Quantidade</th>
                    <th>Oferta</th>
                    <th>Departamento</th>
                    <th>Loja</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody id="consultaBody"></tbody>
              </table>
            </div>
            <div class="table-footer">
              <div id="consultaInfoTotal"></div>
              <div class="pagination">
                <button id="btnConsultaPrev">Anterior</button>
                <button id="btnConsultaNext">Próxima</button>
                <span class="page-info" id="consultaPageInfo">Página 1</span>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section class="view" id="viewUsuarios">
        <div class="section-title">
          <h2>Usuários</h2>
          <div class="actions">
            <button class="btn-icon" id="btnReloadUsuarios">Atualizar</button>
          </div>
        </div>

        <div class="card">
          <div class="form-grid">
            <div class="form-group">
              <label for="novoUsuarioNome">Nome</label>
              <input class="input" type="text" id="novoUsuarioNome" placeholder="Nome completo" />
            </div>
            <div class="form-group">
              <label for="novoUsuarioEmail">E-mail</label>
              <input class="input" type="email" id="novoUsuarioEmail" placeholder="email@palato.com" />
            </div>
            <div class="form-group">
              <label for="novoUsuarioPerfil">Perfil</label>
              <select class="input" id="novoUsuarioPerfil">
                <option value="repositor">Repositor</option>
                <option value="fiscal">Fiscal</option>
                <option value="adm">ADM</option>
                <option value="admin">Administrador</option>
              </select>
            </div>
            <div class="form-group">
              <label for="novoUsuarioLoja">Loja</label>
              <select class="input" id="novoUsuarioLoja">
                <option value="">Selecione...</option>
                <option value="gracas">Graças</option>
                <option value="ponta_verde">Ponta Verde</option>
                <option value="farol">Farol</option>
                <option value="nerilandia">Nerilandia</option>
              </select>
            </div>
          </div>

          <div class="input-inline">
            <button class="btn btn-primary" id="btnSalvarUsuario">Salvar usuário</button>
            <small class="small-muted">O mesmo e-mail deve ser usado no login.</small>
          </div>
        </div>

        <div class="card table-card">
          <div class="table-wrapper">
            <table id="usuariosTabela">
              <thead>
                <tr>
                  <th>Nome</th>
                  <th>E-mail</th>
                  <th>Perfil</th>
                  <th>Loja</th>
                  <th>Ações</th>
                </tr>
              </thead>
              <tbody id="usuariosBody"></tbody>
            </table>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- MODAL SCANNER -->
  <div class="modal" id="scannerModal">
    <div class="modal-content">
      <h3>Ler código de barras</h3>
      <div id="qr-reader" class="qr-reader"></div>
      <div class="modal-actions">
        <button class="btn-icon" id="btnCloseScanner">Fechar</button>
      </div>
    </div>
  </div>

  <!-- ALERT / TOAST -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-app.js";
    import {
      getAuth,
      GoogleAuthProvider,
      signInWithEmailAndPassword,
      signInWithPopup,
      signOut,
      onAuthStateChanged,
      setPersistence,
      browserLocalPersistence
    } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-auth.js";
    import {
      getFirestore,
      collection,
      addDoc,
      getDocs,
      getDoc,
      doc,
      query,
      where,
      orderBy,
      limit,
      startAfter,
      updateDoc,
      deleteDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAqUvRZRiXXLyTVNgJcuhkmK3UUhTz8uv8",
      authDomain: "controles-de-validade.firebaseapp.com",
      projectId: "controles-de-validade",
      storageBucket: "controles-de-validade.appspot.com",
      messagingSenderId: "204089546239",
      appId: "1:204089546239:web:d9f78f0539f2743bed125c"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const googleProvider = new GoogleAuthProvider();
    setPersistence(auth, browserLocalPersistence);

    /* ======= DOM ======= */
    const loginView = document.getElementById("loginView");
    const onboardingView = document.getElementById("onboardingView");
    const appView = document.getElementById("appView");
    const btnLoginEmail = document.getElementById("btnLoginEmail");
    const btnLoginGoogle = document.getElementById("btnLoginGoogle");
    const loginEmail = document.getElementById("loginEmail");
    const loginSenha = document.getElementById("loginSenha");
    const btnOnboardingSalvar = document.getElementById("btnOnboardingSalvar");
    const btnOnboardingVoltarLogin = document.getElementById("btnOnboardingVoltarLogin");
    const onboardingPerfil = document.getElementById("onboardingPerfil");
    const onboardingLoja = document.getElementById("onboardingLoja");
    const badgePerfil = document.getElementById("badgePerfil");
    const badgeLoja = document.getElementById("badgeLoja");
    const btnSair = document.getElementById("btnSair");
    const btnToggleMenu = document.getElementById("btnToggleMenu");
    const sideMenu = document.getElementById("sideMenu");
    const menuOverlay = document.getElementById("menuOverlay");
    const viewDashboard = document.getElementById("viewDashboard");
    const viewCadastrar = document.getElementById("viewCadastrar");
    const viewConsulta = document.getElementById("viewConsulta");
    const viewUsuarios = document.getElementById("viewUsuarios");
    const menuUsuarios = document.getElementById("menuUsuarios");
    const navButtons = Array.from(document.querySelectorAll(".btn-menu"));
    const tabelaBody = document.getElementById("tabelaBody");
    const infoTotal = document.getElementById("infoTotal");
    const consultaBody = document.getElementById("consultaBody");
    const consultaInfoTotal = document.getElementById("consultaInfoTotal");
    const btnReload = document.getElementById("btnReload");
    const btnReloadConsulta = document.getElementById("btnReloadConsulta");
    const filtroBusca = document.getElementById("filtroBusca");
    const filtroDepartamento = document.getElementById("filtroDepartamento");
    const filtroOferta = document.getElementById("filtroOferta");
    const filtroStatus = document.getElementById("filtroStatus");
    const filtroDataInicio = document.getElementById("filtroDataInicio");
    const filtroDataFim = document.getElementById("filtroDataFim");
    const consultaBusca = document.getElementById("consultaBusca");
    const consultaDepartamento = document.getElementById("consultaDepartamento");
    const consultaOferta = document.getElementById("consultaOferta");
    const consultaStatus = document.getElementById("consultaStatus");
    const consultaDataInicio = document.getElementById("consultaDataInicio");
    const consultaDataFim = document.getElementById("consultaDataFim");
    const btnSalvar = document.getElementById("btnSalvar");
    const descricao = document.getElementById("descricao");
    const codigoBarras = document.getElementById("codigoBarras");
    const validade = document.getElementById("validade");
    const quantidade = document.getElementById("quantidade");
    const departamento = document.getElementById("departamento");
    const oferta = document.getElementById("oferta");
    const observacao = document.getElementById("observacao");
    const cardTotal = document.getElementById("cardTotal");
    const cardProximos = document.getElementById("cardProximos");
    const cardVencidos = document.getElementById("cardVencidos");
    const cardOferta = document.getElementById("cardOferta");
    const btnExportarExcel = document.getElementById("btnExportarExcel");
    const btnExportarPdf = document.getElementById("btnExportarPdf");
    const pageInfo = document.getElementById("pageInfo");
    const btnPrevPage = document.getElementById("btnPrevPage");
    const btnNextPage = document.getElementById("btnNextPage");
    const consultaPageInfo = document.getElementById("consultaPageInfo");
    const btnConsultaPrev = document.getElementById("btnConsultaPrev");
    const btnConsultaNext = document.getElementById("btnConsultaNext");
    const toastContainer = document.getElementById("toastContainer");
    const btnScan = document.getElementById("btnScan");
    const scannerModal = document.getElementById("scannerModal");
    const btnCloseScanner = document.getElementById("btnCloseScanner");
    const userAvatar = document.getElementById("userAvatar");
    const userName = document.getElementById("userName");
    const userEmail = document.getElementById("userEmail");
    const userPerfilLoja = document.getElementById("userPerfilLoja");
    const btnExportarExcelConsulta = document.getElementById("btnExportarExcelConsulta");
    const btnExportarPdfConsulta = document.getElementById("btnExportarPdfConsulta");
    const btnReloadUsuarios = document.getElementById("btnReloadUsuarios");
    const btnSalvarUsuario = document.getElementById("btnSalvarUsuario");
    const novoUsuarioNome = document.getElementById("novoUsuarioNome");
    const novoUsuarioEmail = document.getElementById("novoUsuarioEmail");
    const novoUsuarioPerfil = document.getElementById("novoUsuarioPerfil");
    const novoUsuarioLoja = document.getElementById("novoUsuarioLoja");
    const usuariosBody = document.getElementById("usuariosBody");

    /* ======= VARS ======= */
    let usuarioAtual = null;
    let perfilAtual = null;
    let perfilLojaAtual = null;
    let html5QrCode = null;
    let scannerAtivo = false;
    let onboardingDocRef = null;
    let onboardingUser = null;

    // paginação
    const pageSize = 25;
    let lastDocSnapshot = null;
    let firstDocSnapshot = null;
    let paginaAtual = 1;
    let cachePaginas = [];
    let isLoading = false;

    const pageSizeConsulta = 25;
    let lastDocSnapshotConsulta = null;
    let firstDocSnapshotConsulta = null;
    let paginaAtualConsulta = 1;
    let cachePaginasConsulta = [];
    let isLoadingConsulta = false;

    const lojasPermitidas = ["gracas", "ponta_verde", "farol", "nerilandia"];
    const tiposPermitidos = ["repositor", "fiscal", "adm", "admin", "pendente"];

    /* ======= HELPERS ======= */
    function showToast(message) {
      const toast = document.createElement("div");
      toast.className = "toast";
      toast.innerHTML = `
        <span>${message}</span>
        <button aria-label="Fechar">&times;</button>
      `;
      toastContainer.appendChild(toast);

      const remove = () => {
        if (toast.parentNode) toastContainer.removeChild(toast);
      };

      toast.querySelector("button").addEventListener("click", remove);
      setTimeout(remove, 4500);
    }

    function showAlert(msg) {
      showToast(msg);
    }

    function formatarDataHora(date) {
      const pad = (n) => (n < 10 ? "0" + n : n);
      return `${pad(date.getFullYear())}-${pad(date.getMonth() + 1)}-${pad(date.getDate())}T${pad(
        date.getHours()
      )}:${pad(date.getMinutes())}`;
    }

    function formatarData(dateStr) {
      const d = new Date(dateStr);
      if (Number.isNaN(d.getTime())) return "-";
      return new Intl.DateTimeFormat("pt-BR").format(d);
    }

    function calcularStatus(validadeStr) {
      const hoje = new Date();
      const val = new Date(validadeStr);
      const diffDias = Math.floor((val - hoje) / (1000 * 60 * 60 * 24));
      if (diffDias < 0) return "vencido";
      if (diffDias <= 7) return "proximo";
      return "ok";
    }

    function statusLabel(status) {
      if (status === "vencido") return '<span class="status-badge red">Vencido</span>';
      if (status === "proximo") return '<span class="status-badge warning">Próximo</span>';
      return '<span class="status-badge green">OK</span>';
    }

    function validarPerfil(tipo) {
      return tiposPermitidos.includes(tipo);
    }

    function validarLoja(loja) {
      return lojasPermitidas.includes(loja);
    }

    function validarQuantidade(valor) {
      const num = Number(valor);
      return Number.isFinite(num) && num >= 0 && num <= 999999 && Number.isInteger(num);
    }

    function validarDescricao(desc) {
      return desc && desc.trim().length >= 2 && desc.trim().length <= 120;
    }

    function validarCodigoBarras(cod) {
      return /^[0-9]{8,13}$/.test(cod.trim());
    }

    function validarDepartamento(dep) {
      return (
        dep === "" ||
        [
          "mercearia",
          "alimentos_bebidas",
          "higiene_limpeza",
          "padaria",
          "frigorifico",
          "congelados",
          "hortifruti",
          "bazar_utilidades",
          "bebidas"
        ].includes(dep)
      );
    }

    function atualizarClassePerfilBody() {
      document.body.classList.toggle("perfil-admin", perfilAtual === "admin");
      document.body.classList.toggle("perfil-nao-admin", perfilAtual !== "admin");
    }

    function atualizarUserBox(userData) {
      const name = userData?.displayName || userData?.nome || "";
      const email = userData?.email || "";
      userAvatar.textContent = (name || email || "?").substring(0, 2).toUpperCase();
      userName.textContent = name || "Usuário";
      userEmail.textContent = email;
      userPerfilLoja.textContent = perfilAtual && perfilLojaAtual ? `${perfilAtual} • ${perfilLojaAtual}` : "";
    }

    function setView(view) {
      [viewDashboard, viewCadastrar, viewConsulta, viewUsuarios].forEach((el) =>
        el.classList.remove("app-view-active")
      );
      document.getElementById(`view${view.charAt(0).toUpperCase() + view.slice(1)}`).classList.add("app-view-active");
      navButtons.forEach((btn) => btn.classList.toggle("active", btn.dataset.view === view));
    }

    function calcularCards(lancamentos) {
      cardTotal.textContent = lancamentos.length;
      const proximos = lancamentos.filter((l) => calcularStatus(l.validade) === "proximo").length;
      const vencidos = lancamentos.filter((l) => calcularStatus(l.validade) === "vencido").length;
      const oferta = lancamentos.filter((l) => l.oferta === "sim").length;
      cardProximos.textContent = proximos;
      cardVencidos.textContent = vencidos;
      cardOferta.textContent = oferta;
    }

    function aplicarFiltros(lista, filtros) {
      return lista.filter((item) => {
        const busca = filtros.busca ? filtros.busca.toLowerCase() : "";
        if (
          busca &&
          !item.descricao.toLowerCase().includes(busca) &&
          !(item.codigoBarras || "").toLowerCase().includes(busca)
        )
          return false;

        if (filtros.departamento && item.departamento !== filtros.departamento) return false;
        if (filtros.oferta && item.oferta !== filtros.oferta) return false;

        const statusItem = calcularStatus(item.validade);
        if (filtros.status && statusItem !== filtros.status) return false;

        if (filtros.dataInicio) {
          const inicio = new Date(filtros.dataInicio);
          const val = new Date(item.validade);
          if (val < inicio) return false;
        }

        if (filtros.dataFim) {
          const fim = new Date(filtros.dataFim);
          const val = new Date(item.validade);
          if (val > fim) return false;
        }

        return true;
      });
    }

    function atualizarTabela(lancamentos, container) {
      container.innerHTML = "";
      lancamentos.forEach((lancamento) => {
        const tr = document.createElement("tr");

        const status = calcularStatus(lancamento.validade);
        tr.classList.toggle("oferta-ativa", lancamento.oferta === "sim");

        const tdDescricao = document.createElement("td");
        tdDescricao.textContent = lancamento.descricao || "-";

        const tdCodigo = document.createElement("td");
        tdCodigo.textContent = lancamento.codigoBarras || "-";

        const tdValidade = document.createElement("td");
        tdValidade.textContent = formatarData(lancamento.validade);

        const tdQuantidade = document.createElement("td");
        tdQuantidade.textContent = lancamento.quantidade || "-";

        const tdOferta = document.createElement("td");
        tdOferta.innerHTML =
          lancamento.oferta === "sim"
            ? '<span class="tag badge-offer">Oferta</span>'
            : '<span class="tag">Normal</span>';

        const tdDep = document.createElement("td");
        tdDep.innerHTML = `<span class="tag badge-departamento">${lancamento.departamento || "-"}</span>`;

        const tdLoja = document.createElement("td");
        tdLoja.textContent = lancamento.loja || "-";

        const tdStatus = document.createElement("td");
        tdStatus.innerHTML = statusLabel(status);

        const tdAcoes = document.createElement("td");
        tdAcoes.className = "table-actions";
        if (perfilAtual === "admin" || perfilAtual === "adm" || perfilAtual === "fiscal") {
          const btnRemover = document.createElement("button");
          btnRemover.className = "btn-icon danger";
          btnRemover.textContent = "Excluir";
          btnRemover.addEventListener("click", async () => {
            if (!confirm("Deseja excluir este lançamento?")) return;
            await deleteDoc(doc(db, "lancamentos", lancamento.id));
            showAlert("Lançamento excluído.");
            await carregarPagina();
          });
          tdAcoes.appendChild(btnRemover);
        } else {
          tdAcoes.textContent = "-";
        }

        [tdDescricao, tdCodigo, tdValidade, tdQuantidade, tdOferta, tdDep, tdLoja, tdStatus, tdAcoes].forEach((td) =>
          tr.appendChild(td)
        );
        container.appendChild(tr);
      });
    }

    function atualizarTabelaUsuarios(lista) {
      usuariosBody.innerHTML = "";
      lista.forEach((u) => {
        const tr = document.createElement("tr");

        const tdNome = document.createElement("td");
        tdNome.textContent = u.nome || "-";

        const tdEmail = document.createElement("td");
        tdEmail.textContent = u.email || "-";

        const tdPerfil = document.createElement("td");
        tdPerfil.textContent = u.tipo || "-";

        const tdLoja = document.createElement("td");
        tdLoja.textContent = u.loja || "-";

        const tdAcoes = document.createElement("td");
        const btnSalvar = document.createElement("button");
        btnSalvar.className = "btn-icon success";
        btnSalvar.textContent = "Salvar";
        btnSalvar.addEventListener("click", async () => {
          try {
            await updateDoc(doc(db, "usuarios", u.id), {
              nome: tdNome.textContent.trim(),
              email: tdEmail.textContent.trim(),
              tipo: tdPerfil.textContent.trim(),
              loja: tdLoja.textContent.trim()
            });
            showAlert("Usuário atualizado.");
          } catch (err) {
            console.error(err);
            showAlert("Erro ao atualizar usuário.");
          }
        });

        const btnExcluir = document.createElement("button");
        btnExcluir.className = "btn-icon danger";
        btnExcluir.textContent = "Excluir";
        btnExcluir.addEventListener("click", async () => {
          if (!confirm("Excluir usuário?")) return;
          try {
            await deleteDoc(doc(db, "usuarios", u.id));
            showAlert("Usuário excluído.");
            await carregarUsuarios();
          } catch (err) {
            console.error(err);
            showAlert("Erro ao excluir usuário.");
          }
        });

        tdAcoes.appendChild(btnSalvar);
        tdAcoes.appendChild(btnExcluir);

        [tdNome, tdEmail, tdPerfil, tdLoja, tdAcoes].forEach((td) => tr.appendChild(td));
        usuariosBody.appendChild(tr);
      });
    }

    function atualizarClasseOferta(lancamento, tr) {
      tr.classList.toggle("oferta-ativa", lancamento.oferta === "sim");
    }

    function renderizarCards(lista) {
      calcularCards(lista);
    }

    /* ======= PAGINAÇÃO ======= */
    function montarQueryBase() {
      const base = [collection(db, "lancamentos"), orderBy("criadoEm", "desc")];
      if (perfilAtual && perfilAtual !== "admin") {
        base.push(where("loja", "==", perfilLojaAtual || ""));
      }
      return base;
    }

    async function carregarPagina(reset = false) {
      if (isLoading) return;
      isLoading = true;
      try {
        if (reset) {
          lastDocSnapshot = null;
          firstDocSnapshot = null;
          paginaAtual = 1;
          cachePaginas = [];
        }

        const base = montarQueryBase();
        let q;
        if (!reset && lastDocSnapshot) {
          q = query(...base, startAfter(lastDocSnapshot), limit(pageSize));
        } else {
          q = query(...base, limit(pageSize));
        }

        const snap = await getDocs(q);
        const docs = snap.docs.map((d) => ({ id: d.id, ...d.data() }));

        if (docs.length) {
          lastDocSnapshot = snap.docs[snap.docs.length - 1];
          firstDocSnapshot = snap.docs[0];
          cachePaginas[paginaAtual - 1] = docs;
        }

        aplicarEAtualizar(docs);
        pageInfo.textContent = `Página ${paginaAtual}`;
        await prefetchProximaPagina(base, lastDocSnapshot);
      } catch (err) {
        console.error(err);
        showAlert("Erro ao carregar lançamentos.");
      } finally {
        isLoading = false;
      }
    }

    async function prefetchProximaPagina(base, lastDoc) {
      if (!lastDoc) return;
      try {
        const nextQuery = query(...base, startAfter(lastDoc), limit(pageSize));
        const nextSnap = await getDocs(nextQuery);
        cachePaginas[paginaAtual] = nextSnap.docs.map((d) => ({ id: d.id, ...d.data() }));
      } catch (e) {
        console.error("Prefetch falhou", e);
      }
    }

    function aplicarEAtualizar(lista) {
      const filtrados = aplicarFiltros(lista, {
        busca: filtroBusca.value,
        departamento: filtroDepartamento.value,
        oferta: filtroOferta.value,
        status: filtroStatus.value,
        dataInicio: filtroDataInicio.value,
        dataFim: filtroDataFim.value
      });
      infoTotal.textContent = `${lista.length} registros nesta página | ${filtrados.length} após filtros`;
      atualizarTabela(filtrados, tabelaBody);
      renderizarCards(lista);
    }

    btnPrevPage.addEventListener("click", () => {
      if (paginaAtual <= 1 || isLoading) return;
      paginaAtual--;
      const dados = cachePaginas[paginaAtual - 1];
      if (dados) {
        aplicarEAtualizar(dados);
        pageInfo.textContent = `Página ${paginaAtual}`;
      }
    });

    btnNextPage.addEventListener("click", async () => {
      if (isLoading) return;
      const dados = cachePaginas[paginaAtual];
      if (dados && dados.length) {
        paginaAtual++;
        aplicarEAtualizar(dados);
        pageInfo.textContent = `Página ${paginaAtual}`;
      } else {
        paginaAtual++;
        await carregarPagina();
      }
    });

    [filtroBusca, filtroDepartamento, filtroOferta, filtroStatus, filtroDataInicio, filtroDataFim].forEach((el) => {
      el.addEventListener("input", () => {
        const dados = cachePaginas[paginaAtual - 1] || [];
        aplicarEAtualizar(dados);
      });
    });

    /* ======= PAGINAÇÃO CONSULTA ======= */
    function montarQueryConsulta() {
      const base = [collection(db, "lancamentos"), orderBy("criadoEm", "desc")];
      if (perfilAtual && perfilAtual !== "admin") {
        base.push(where("loja", "==", perfilLojaAtual || ""));
      }
      return base;
    }

    async function carregarPaginaConsulta(reset = false) {
      if (isLoadingConsulta) return;
      isLoadingConsulta = true;
      try {
        if (reset) {
          lastDocSnapshotConsulta = null;
          firstDocSnapshotConsulta = null;
          paginaAtualConsulta = 1;
          cachePaginasConsulta = [];
        }

        const base = montarQueryConsulta();
        let q;
        if (!reset && lastDocSnapshotConsulta) {
          q = query(...base, startAfter(lastDocSnapshotConsulta), limit(pageSizeConsulta));
        } else {
          q = query(...base, limit(pageSizeConsulta));
        }

        const snap = await getDocs(q);
        const docs = snap.docs.map((d) => ({ id: d.id, ...d.data() }));

        if (docs.length) {
          lastDocSnapshotConsulta = snap.docs[snap.docs.length - 1];
          firstDocSnapshotConsulta = snap.docs[0];
          cachePaginasConsulta[paginaAtualConsulta - 1] = docs;
        }

        aplicarEAtualizarConsulta(docs);
        consultaPageInfo.textContent = `Página ${paginaAtualConsulta}`;
        await prefetchProximaConsulta(base, lastDocSnapshotConsulta);
      } catch (err) {
        console.error(err);
        showAlert("Erro ao carregar consulta.");
      } finally {
        isLoadingConsulta = false;
      }
    }

    async function prefetchProximaConsulta(base, lastDoc) {
      if (!lastDoc) return;
      try {
        const nextQuery = query(...base, startAfter(lastDoc), limit(pageSizeConsulta));
        const nextSnap = await getDocs(nextQuery);
        cachePaginasConsulta[paginaAtualConsulta] = nextSnap.docs.map((d) => ({ id: d.id, ...d.data() }));
      } catch (e) {
        console.error("Prefetch consulta falhou", e);
      }
    }

    function aplicarEAtualizarConsulta(lista) {
      const filtrados = aplicarFiltros(lista, {
        busca: consultaBusca.value,
        departamento: consultaDepartamento.value,
        oferta: consultaOferta.value,
        status: consultaStatus.value,
        dataInicio: consultaDataInicio.value,
        dataFim: consultaDataFim.value
      });
      consultaInfoTotal.textContent = `${lista.length} registros nesta página | ${filtrados.length} após filtros`;
      atualizarTabela(filtrados, consultaBody);
    }

    btnConsultaPrev.addEventListener("click", () => {
      if (paginaAtualConsulta <= 1 || isLoadingConsulta) return;
      paginaAtualConsulta--;
      const dados = cachePaginasConsulta[paginaAtualConsulta - 1];
      if (dados) {
        aplicarEAtualizar
