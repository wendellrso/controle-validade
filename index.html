<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Controle de Validade - Mercearia</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- QuaggaJS para leitura de c√≥digo de barras -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>

  <style>
    :root {
      --bg: #0f172a;
      --card: #111827;
      --accent: #22c55e;
      --accent-soft: rgba(34, 197, 94, 0.12);
      --text: #e5e7eb;
      --text-soft: #9ca3af;
      --danger: #ef4444;
      --border: #1f2937;
      --radius-lg: 18px;
      --radius-xl: 22px;
    }

    * {
      box-sizing: border-box;
      -webkit-font-smoothing: antialiased;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: radial-gradient(circle at top, #1f2933 0, #020617 55%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      justify-content: center;
    }

    .app {
      width: 100%;
      max-width: 480px;
      padding: 16px;
      padding-bottom: 40px;
    }

    header {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 14px;
    }

    header .title {
      font-size: 1.15rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    header .badge {
      font-size: 0.7rem;
      padding: 2px 8px;
      border-radius: 999px;
      background: var(--accent-soft);
      color: var(--accent);
      border: 1px solid rgba(34,197,94,0.4);
    }

    header .subtitle {
      font-size: 0.78rem;
      color: var(--text-soft);
    }

    .card {
      background: linear-gradient(135deg, #020617 0, #020617 60%, #0b1120 100%);
      border-radius: var(--radius-xl);
      padding: 14px 14px 16px;
      border: 1px solid rgba(148,163,184,0.18);
      box-shadow: 0 18px 40px rgba(0,0,0,0.55);
    }

    form {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .field label {
      font-size: 0.78rem;
      color: var(--text-soft);
    }

    .field-row {
      display: flex;
      gap: 8px;
    }

    .field-row > .field {
      flex: 1;
    }

    input, select, textarea {
      background: #020617;
      border-radius: 12px;
      border: 1px solid var(--border);
      padding: 9px 10px;
      color: var(--text);
      font-size: 0.9rem;
      outline: none;
      transition: border 0.15s, box-shadow 0.15s, background 0.15s;
    }

    input:focus, select:focus, textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(34,197,94,0.4);
    }

    textarea {
      min-height: 60px;
      resize: vertical;
    }

    .barcode-row {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .barcode-row input {
      flex: 1;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      border-radius: 999px;
      padding: 10px 14px;
      border: 0;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
      transition: transform 0.1s, box-shadow 0.1s, opacity 0.1s,
        background 0.1s;
      white-space: nowrap;
    }

    .btn-primary {
      background: linear-gradient(135deg,#22c55e,#16a34a);
      color: #022c22;
      box-shadow: 0 9px 22px rgba(34,197,94,0.35);
      width: 100%;
    }

    .btn-secondary {
      background: rgba(15,23,42,0.9);
      color: var(--text-soft);
      border: 1px solid var(--border);
      width: 100%;
    }

    .btn-icon {
      background: #020617;
      border-radius: 14px;
      border: 1px solid var(--border);
      height: 40px;
      width: 44px;
      flex-shrink: 0;
      font-size: 1.1rem;
      color: var(--accent);
    }

    .btn:active {
      transform: translateY(1px);
      box-shadow: none;
      opacity: 0.95;
    }

    .actions {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 6px;
    }

    .helper-text {
      font-size: 0.72rem;
      color: var(--text-soft);
      margin-top: -2px;
    }

    .list-section {
      margin-top: 16px;
    }

    .list-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .list-header span {
      font-size: 0.8rem;
      color: var(--text-soft);
    }

    .tag {
      font-size: 0.7rem;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(15,118,110,0.2);
      color: #5eead4;
      border: 1px solid rgba(45,212,191,0.5);
    }

    .empty {
      font-size: 0.78rem;
      color: var(--text-soft);
      padding: 8px 0;
    }

    .entry-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 260px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .entry {
      border-radius: 14px;
      border: 1px solid var(--border);
      background: radial-gradient(circle at top left,#020617 0,#020617 60%,#020617 100%);
      padding: 8px 10px;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .entry-main {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      font-size: 0.84rem;
    }

    .entry-main strong {
      font-weight: 500;
    }

    .entry-sub {
      font-size: 0.74rem;
      color: var(--text-soft);
      display: flex;
      justify-content: space-between;
      gap: 10px;
    }

    .entry-note {
      font-size: 0.72rem;
      color: #e5e7eb;
      margin-top: 4px;
    }

    /* Modal do scanner */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.82);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    .modal.hidden {
      display: none;
    }

    .modal-content {
      width: 100%;
      max-width: 480px;
      margin: 12px;
      border-radius: var(--radius-xl);
      background: #020617;
      border: 1px solid rgba(148,163,184,0.25);
      padding: 10px 10px 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.9rem;
    }

    .modal-header span {
      font-size: 0.82rem;
      color: var(--text-soft);
    }

    #scanner-area {
      position: relative;
      width: 100%;
      border-radius: 14px;
      overflow: hidden;
      background: #020617;
      border: 1px solid var(--border);
      min-height: 240px;
    }

    .scanner-status {
      font-size: 0.75rem;
      color: var(--text-soft);
    }

    .scanner-error {
      font-size: 0.75rem;
      color: var(--danger);
    }

    @media (min-width: 600px) {
      body {
        padding-top: 20px;
      }
      .app {
        max-width: 520px;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="title">
        Controle de Validade
        <span class="badge">Mercearia</span>
      </div>
      <div class="subtitle">
        Lan√ßamento r√°pido de produtos pr√≥ximos ao vencimento, pronto para uso em loja.
      </div>
    </header>

    <div class="card">
      <form id="lancamento-form">
        <div class="field">
          <label for="loja">Loja</label>
          <select id="loja" required>
            <option value="">Selecione...</option>
            <option value="Ponta Verde">Ponta Verde</option>
            <option value="Farol">Farol</option>
            <option value="Praia">Praia</option>
            <option value="Riomar">Riomar</option>
          </select>
        </div>

        <div class="field-row">
          <div class="field">
            <label for="data">Data do lan√ßamento</label>
            <input type="date" id="data" required />
          </div>
          <div class="field">
            <label for="validade">Validade</label>
            <input type="date" id="validade" required />
          </div>
        </div>

        <div class="field">
          <label for="observacao">Observa√ß√£o</label>
          <textarea id="observacao" placeholder="Lote, exposi√ß√£o, motivo do apontamento, etc."></textarea>
        </div>

        <div class="field">
          <label for="codigo">C√≥digo de barras</label>
          <div class="barcode-row">
            <input
              type="text"
              id="codigo"
              inputmode="numeric"
              placeholder="Toque no bot√£o de scanner ou digite manualmente"
              required
            />
            <button type="button" class="btn btn-icon" id="btn-open-scanner" title="Abrir scanner">
              üì∑
            </button>
          </div>
          <div class="helper-text">Use o scanner da c√¢mera para agilizar o cadastro.</div>
        </div>

        <div class="field">
          <label for="descricao">Descri√ß√£o do produto</label>
          <input type="text" id="descricao" placeholder="Ex.: Leite UHT Integral 1L" required />
        </div>

        <div class="field-row">
          <div class="field">
            <label for="quantidade">Quantidade</label>
            <input
              type="number"
              id="quantidade"
              min="1"
              step="1"
              value="1"
              required
            />
          </div>
        </div>

        <div class="actions">
          <button type="submit" class="btn btn-primary">Salvar lan√ßamento</button>
          <button type="button" class="btn btn-secondary" id="btn-limpar">
            Limpar formul√°rio
          </button>
        </div>
      </form>

      <div class="list-section">
        <div class="list-header">
          <span>√öltimos lan√ßamentos</span>
          <span class="tag" id="contador-lancamentos">0 itens</span>
        </div>
        <div id="lista-vazia" class="empty">
          Nenhum lan√ßamento ainda. Salve o primeiro produto para visualizar aqui.
        </div>
        <div class="entry-list" id="lista-lancamentos"></div>
      </div>
    </div>
  </div>

  <!-- Modal do Scanner -->
  <div class="modal hidden" id="scanner-modal">
    <div class="modal-content">
      <div class="modal-header">
        <div>
          Scanner de c√≥digo de barras
          <div class="scanner-status" id="scanner-status">
            Iniciando c√¢mera...
          </div>
        </div>
        <button type="button" class="btn btn-icon" id="btn-close-scanner" title="Fechar scanner">
          ‚úï
        </button>
      </div>

      <div id="scanner-area"></div>

      <div class="scanner-error" id="scanner-error"></div>
      <div class="helper-text">
        Aponte a c√¢mera para o c√≥digo de barras. Assim que ele for reconhecido, o campo ser√° preenchido automaticamente.
      </div>
    </div>
  </div>

  <script>
    // ---------- Formul√°rio e lista ----------
    const form = document.getElementById("lancamento-form");
    const lojaInput = document.getElementById("loja");
    const dataInput = document.getElementById("data");
    const validadeInput = document.getElementById("validade");
    const observacaoInput = document.getElementById("observacao");
    const codigoInput = document.getElementById("codigo");
    const descricaoInput = document.getElementById("descricao");
    const quantidadeInput = document.getElementById("quantidade");

    const listaLancamentos = document.getElementById("lista-lancamentos");
    const listaVazia = document.getElementById("lista-vazia");
    const contadorLancamentos = document.getElementById("contador-lancamentos");

    const btnLimpar = document.getElementById("btn-limpar");

    // Preenche data de hoje por padr√£o
    function setHoje() {
      const hoje = new Date();
      const yyyy = hoje.getFullYear();
      const mm = String(hoje.getMonth() + 1).padStart(2, "0");
      const dd = String(hoje.getDate()).padStart(2, "0");
      const hojeStr = `${yyyy}-${mm}-${dd}`;
      dataInput.value = hojeStr;
    }
    setHoje();

    // LocalStorage helpers
    const STORAGE_KEY = "app_validade_lancamentos";

    function carregarLancamentos() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return [];
        return JSON.parse(raw);
      } catch (e) {
        console.error("Erro ao carregar lan√ßamentos:", e);
        return [];
      }
    }

    function salvarLancamentos(lista) {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(lista));
      } catch (e) {
        console.error("Erro ao salvar lan√ßamentos:", e);
      }
    }

    function atualizarLista() {
      const itens = carregarLancamentos();
      listaLancamentos.innerHTML = "";

      if (itens.length === 0) {
        listaVazia.style.display = "block";
      } else {
        listaVazia.style.display = "none";
      }

      contadorLancamentos.textContent =
        itens.length === 1 ? "1 item" : `${itens.length} itens`;

      itens
        .slice()
        .reverse()
        .forEach((item) => {
          const div = document.createElement("div");
          div.className = "entry";

          const main = document.createElement("div");
          main.className = "entry-main";
          main.innerHTML = `
            <strong>${item.descricao}</strong>
            <span>Qtd: ${item.quantidade}</span>
          `;

          const sub = document.createElement("div");
          sub.className = "entry-sub";
          sub.innerHTML = `
            <span>${item.loja} ‚Ä¢ Cod: ${item.codigo}</span>
            <span>Val.: ${item.validadeBR}</span>
          `;

          div.appendChild(main);
          div.appendChild(sub);

          if (item.observacao) {
            const note = document.createElement("div");
            note.className = "entry-note";
            note.textContent = item.observacao;
            div.appendChild(note);
          }

          listaLancamentos.appendChild(div);
        });
    }

    atualizarLista();

    form.addEventListener("submit", (e) => {
      e.preventDefault();

      const dados = {
        loja: lojaInput.value,
        data: dataInput.value,
        validade: validadeInput.value,
        observacao: observacaoInput.value.trim(),
        codigo: codigoInput.value.trim(),
        descricao: descricaoInput.value.trim(),
        quantidade: Number(quantidadeInput.value || "0"),
      };

      if (!dados.loja || !dados.data || !dados.validade || !dados.codigo || !dados.descricao) {
        alert("Preencha todos os campos obrigat√≥rios.");
        return;
      }

      const [y, m, d] = dados.validade.split("-");
      const validadeBR = `${d}/${m}/${y}`;

      const itens = carregarLancamentos();
      itens.push({ ...dados, validadeBR });
      salvarLancamentos(itens);
      atualizarLista();

      form.reset();
      setHoje();
      quantidadeInput.value = 1;

      alert("Lan√ßamento salvo com sucesso!");
    });

    btnLimpar.addEventListener("click", () => {
      form.reset();
      setHoje();
      quantidadeInput.value = 1;
      codigoInput.focus();
    });

    // ---------- Scanner com Quagga ----------
    const scannerModal = document.getElementById("scanner-modal");
    const scannerArea = document.getElementById("scanner-area");
    const btnOpenScanner = document.getElementById("btn-open-scanner");
    const btnCloseScanner = document.getElementById("btn-close-scanner");
    const scannerStatus = document.getElementById("scanner-status");
    const scannerError = document.getElementById("scanner-error");

    let scannerAtivo = false;
    let quaggaIniciado = false;

    function abrirScanner() {
      scannerModal.classList.remove("hidden");
      scannerStatus.textContent = "Iniciando c√¢mera...";
      scannerError.textContent = "";
      iniciarQuagga();
    }

    function fecharScanner() {
      pararQuagga();
      scannerModal.classList.add("hidden");
    }

    function iniciarQuagga() {
      if (scannerAtivo) return;

      const constraints = {
        width: { ideal: 640 },
        height: { ideal: 480 },
        facingMode: "environment",
      };

      Quagga.init(
        {
          inputStream: {
            type: "LiveStream",
            constraints,
            target: scannerArea,
          },
          decoder: {
            readers: ["ean_reader", "ean_8_reader", "code128_reader"],
          },
          locate: true,
        },
        (err) => {
          if (err) {
            console.error(err);
            scannerError.textContent =
              "N√£o foi poss√≠vel acessar a c√¢mera. Verifique as permiss√µes.";
            scannerStatus.textContent = "";
            return;
          }
          Quagga.start();
          scannerAtivo = true;
          quaggaIniciado = true;
          scannerStatus.textContent = "C√¢mera ativa. Aponte para o c√≥digo de barras.";
        }
      );

      Quagga.onDetected(onBarcodeDetected);
    }

    function pararQuagga() {
      if (quaggaIniciado) {
        Quagga.offDetected(onBarcodeDetected);
        Quagga.stop();
      }
      scannerAtivo = false;
      quaggaIniciado = false;
      scannerStatus.textContent = "";
    }

    function onBarcodeDetected(data) {
      if (!data || !data.codeResult || !data.codeResult.code) return;

      const code = data.codeResult.code;
      // evita disparos m√∫ltiplos
      pararQuagga();
      codigoInput.value = code;
      scannerStatus.textContent = "C√≥digo lido: " + code;
      setTimeout(() => {
        fecharScanner();
        descricaoInput.focus();
      }, 400);
    }

    btnOpenScanner.addEventListener("click", abrirScanner);
    btnCloseScanner.addEventListener("click", fecharScanner);

    // Fecha o modal clicando fora
    scannerModal.addEventListener("click", (e) => {
      if (e.target === scannerModal) {
        fecharScanner();
      }
    });

    // Seguran√ßa extra: parar scanner ao sair da p√°gina
    window.addEventListener("pagehide", pararQuagga);
    window.addEventListener("beforeunload", pararQuagga);
  </script>
</body>
</html>
