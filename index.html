<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Controle de Validade ‚Äì Mercearia</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #f4f4f5;
      color: #111827;
    }
    header {
      background: #111827;
      color: #f9fafb;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    header h1 {
      margin: 0;
      font-size: 18px;
    }
    .user-info {
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .user-email {
      opacity: 0.8;
    }
    .btn-small {
      border: 1px solid #e5e7eb;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 11px;
      background: #f9fafb;
      cursor: pointer;
    }
    main {
      max-width: 1100px;
      margin: 0 auto;
      padding: 16px;
    }
    .card {
      background: #ffffff;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
      margin-bottom: 16px;
    }
    .card h2 {
      margin-top: 0;
      font-size: 18px;
    }
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      margin-bottom: 12px;
    }
    label {
      font-size: 12px;
      color: #4b5563;
      display: block;
      margin-bottom: 4px;
    }
    input, select, textarea {
      width: 100%;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 14px;
      box-sizing: border-box;
    }
    textarea {
      min-height: 60px;
      resize: vertical;
    }
    button {
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
      transition: transform 0.05s ease, box-shadow 0.1s ease, opacity 0.1s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }
    .btn-primary {
      background: #111827;
      color: #f9fafb;
      box-shadow: 0 10px 20px rgba(15, 23, 42, 0.4);
    }
    .btn-primary:active {
      transform: scale(0.97);
      box-shadow: 0 5px 10px rgba(15, 23, 42, 0.3);
    }
    .btn-outline {
      background: #ffffff;
      color: #111827;
      border: 1px solid #d1d5db;
    }
    .btn-outline.active {
      background: #111827;
      color: #f9fafb;
      border-color: #111827;
    }

    .btn-google {
      background: #ffffff;
      border: 1px solid #d1d5db;
      font-size: 13px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 14px;
    }
    .google-icon {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border: 1px solid #d1d5db;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 13px;
      background: #fff;
    }
    .btn-apple {
      background: #000000;
      color: #ffffff;
      border: none;
      font-size: 13px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 14px;
      border-radius: 999px;
    }
    .apple-icon {
      font-size: 18px;
    }

    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 8px;
      align-items: center;
    }
    .search-box {
      margin-top: 8px;
    }
    .search-box input {
      max-width: 260px;
    }
    .table-wrapper {
      overflow-x: auto;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      background: #ffffff;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    thead {
      background: #f9fafb;
    }
    th, td {
      padding: 8px 10px;
      text-align: left;
      border-bottom: 1px solid #e5e7eb;
    }
    th {
      font-weight: 600;
      font-size: 12px;
      color: #4b5563;
    }
    tbody tr:last-child td {
      border-bottom: none;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      font-size: 11px;
      border-radius: 999px;
      font-weight: 500;
    }
    .badge-ok {
      background: #dcfce7;
      color: #166534;
    }
    .badge-alerta {
      background: #fef9c3;
      color: #854d0e;
    }
    .badge-vencido {
      background: #fee2e2;
      color: #991b1b;
    }
    .tag-loja {
      font-size: 11px;
      background: #e5e7eb;
      border-radius: 999px;
      padding: 2px 8px;
    }
    .empty-state {
      text-align: center;
      padding: 24px;
      color: #6b7280;
      font-size: 14px;
    }
    .small {
      font-size: 12px;
      color: #6b7280;
      margin-top: 4px;
    }
    .hidden {
      display: none !important;
    }

    .login-layout {
      max-width: 420px;
      margin: 0 auto;
    }
    .login-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .login-subtitle {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 16px;
    }
    .login-toggle {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }
    .login-toggle button {
      flex: 1;
      justify-content: center;
      font-size: 13px;
      padding: 6px 10px;
    }
    .login-footer {
      font-size: 12px;
      color: #6b7280;
      margin-top: 12px;
      text-align: center;
    }
    .login-footer button {
      font-size: 12px;
      padding: 0;
      border: none;
      background: none;
      color: #111827;
      text-decoration: underline;
      box-shadow: none;
    }
    .error-msg {
      font-size: 12px;
      color: #b91c1c;
      margin-top: 6px;
      min-height: 16px;
    }

    .admin-table table {
      font-size: 13px;
    }
    .admin-table select {
      font-size: 12px;
      padding: 4px 6px;
    }
    .admin-table button {
      font-size: 12px;
      padding: 4px 10px;
    }

    @media (max-width: 640px) {
      /* esconder algumas colunas no mobile pra n√£o virar bagun√ßa */
      th:nth-child(4),
      td:nth-child(4),
      th:nth-child(5),
      td:nth-child(5),
      th:nth-child(6),
      td:nth-child(6),
      th:nth-child(10),
      td:nth-child(10),
      th:nth-child(12),
      td:nth-child(12),
      th:nth-child(13),
      td:nth-child(13) {
        display: none;
      }
      header {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>

  <!-- jsPDF para PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- jsPDF AutoTable para tabela bonita no PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
  <!-- SheetJS para Excel .xlsx -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
  <header>
    <h1>Controle de Validade ‚Äì Mercearia</h1>
    <div class="user-info" id="userInfo">
      <span class="user-email" id="userEmail"></span>
      <button class="btn-small hidden" id="btnLogout">Sair</button>
    </div>
  </header>

  <main>
    <!-- TELA DE LOGIN -->
    <section class="card login-layout" id="loginCard">
      <div class="login-title">Entrar no sistema</div>
      <div class="login-subtitle">
        Fa√ßa login para lan√ßar e consultar produtos por validade.
      </div>

      <div class="login-toggle">
        <button class="btn-outline active" id="btnModoLogin">Entrar</button>
        <button class="btn-outline" id="btnModoCadastro">Criar conta</button>
      </div>

      <div class="form-grid">
        <div style="grid-column: 1 / -1;">
          <label for="emailAuth">E-mail</label>
          <input type="email" id="emailAuth" placeholder="seu.email@exemplo.com" />
        </div>
        <div style="grid-column: 1 / -1;">
          <label for="senhaAuth">Senha</label>
          <input type="password" id="senhaAuth" placeholder="m√≠nimo 6 caracteres" />
        </div>
      </div>

      <button class="btn-primary" id="btnAuthMain">Entrar</button>

      <div style="margin-top: 12px; text-align:center; display:flex; flex-direction:column; gap:8px; align-items:center;">
        <button class="btn-google" id="btnGoogle">
          <span class="google-icon">G</span>
          <span>Entrar com Google</span>
        </button>

        <button class="btn-apple" id="btnApple">
          <span class="apple-icon">Ô£ø</span>
          <span>Entrar com Apple</span>
        </button>
      </div>

      <div class="error-msg" id="authError"></div>

      <div class="login-footer">
        Qualquer pessoa pode criar uma conta e usar o sistema.<br/>
        <button id="btnEsqueceuSenha">Esqueci minha senha</button>
      </div>
    </section>

    <!-- APP (S√ì APARECE LOGADO) -->
    <section id="appContent" class="hidden">
      <!-- NOVO LAN√áAMENTO / EDI√á√ÉO -->
      <section class="card">
        <h2 id="tituloFormulario">Novo lan√ßamento</h2>
        <div class="form-grid">
          <!-- Loja -->
          <div>
            <label for="loja">Loja</label>
            <select id="loja">
              <option value="">Selecione...</option>
              <option value="PV">Ponta Verde</option>
              <option value="Farol">Farol</option>
              <option value="Praia">Praia</option>
              <option value="Riomar">Riomar</option>
            </select>
            <div class="small" id="ajudaCampoLoja"></div>
          </div>

          <!-- Data de lan√ßamento (hoje, travada) -->
          <div>
            <label for="dataLancamento">Data de lan√ßamento</label>
            <input type="date" id="dataLancamento" disabled />
            <div class="small">Sempre a data de hoje, registrada automaticamente.</div>
          </div>

          <!-- Departamento -->
          <div>
            <label for="departamento">Departamento</label>
            <select id="departamento">
              <option value="">Selecione...</option>
              <option value="A√ßougue">A√ßougue</option>
              <option value="Adega">Adega</option>
              <option value="Bebidas">Bebidas</option>
              <option value="Mercearia Alimentos">Mercearia Alimentos</option>
              <option value="Mercearia N√£o Alimentos">Mercearia N√£o Alimentos</option>
              <option value="Perec√≠veis Processados">Perec√≠veis Processados</option>
            </select>
          </div>

          <!-- C√≥digo de barras -->
          <div>
            <label for="codigoBarras">C√≥d. barras (n√∫meros, m√°x. 13)</label>
            <input
              type="text"
              id="codigoBarras"
              maxlength="13"
              inputmode="numeric"
              pattern="\\d*"
              placeholder="7891234567890"
            />
          </div>

          <!-- Descri√ß√£o -->
          <div>
            <label for="descricao">Descri√ß√£o</label>
            <input type="text" id="descricao" />
          </div>

          <!-- Lote -->
          <div>
            <label for="lote">Lote</label>
            <input type="text" id="lote" />
          </div>

          <!-- Quantidade -->
          <div>
            <label for="quantidade">Quantidade</label>
            <input type="number" id="quantidade" min="1" />
          </div>

          <!-- Validade -->
          <div>
            <label for="validade">Data de validade</label>
            <input type="date" id="validade" />
          </div>

          <!-- Observa√ß√£o -->
          <div style="grid-column: 1 / -1;">
            <label for="observacao">Observa√ß√£o</label>
            <textarea id="observacao" placeholder="Ex.: ponta de g√¥ndola, oferta, avaria..."></textarea>
          </div>
        </div>
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
          <button class="btn-primary" id="btnSalvar">Salvar lan√ßamento</button>
          <button class="btn-outline hidden" id="btnCancelarEdicao">Cancelar edi√ß√£o</button>
        </div>
        <div class="small">
          * Status √© calculado automaticamente:<br />
          <strong>OK</strong> (&gt; 30 dias) ¬∑ <strong>Vence em 30 dias</strong> ¬∑ <strong>Vencido</strong>
        </div>
      </section>

      <!-- LISTAGEM DE ITENS -->
      <section class="card">
        <h2>Itens cadastrados</h2>

        <!-- Filtros de status -->
        <div class="filters">
          <button class="btn-outline active" data-filter="todos">Todos</button>
          <button class="btn-outline" data-filter="vence15">Vence em 15 dias</button>
          <button class="btn-outline" data-filter="vence30">Vence em 30 dias</button>
          <button class="btn-outline" data-filter="vencido">Vencidos</button>
        </div>

        <!-- Filtro de departamento + exporta√ß√µes -->
        <div class="filters">
          <div>
            <label for="filtroDepartamento">Departamento</label>
            <select id="filtroDepartamento">
              <option value="todos">Todos os departamentos</option>
              <option value="A√ßougue">A√ßougue</option>
              <option value="Adega">Adega</option>
              <option value="Bebidas">Bebidas</option>
              <option value="Mercearia Alimentos">Mercearia Alimentos</option>
              <option value="Mercearia N√£o Alimentos">Mercearia N√£o Alimentos</option>
              <option value="Perec√≠veis Processados">Perec√≠veis Processados</option>
            </select>
          </div>

          <div style="flex:1"></div>

          <button class="btn-outline" id="btnExportExcel">Exportar Excel (.xlsx)</button>
          <button class="btn-outline" id="btnExportPDF">Exportar PDF</button>
        </div>

        <div class="search-box">
          <label for="busca">Buscar por descri√ß√£o ou c√≥digo de barras:</label>
          <input type="text" id="busca" placeholder="Digite para filtrar..." />
        </div>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Loja</th>
                <th>Departamento</th>
                <th>Produto</th>
                <th>C√≥d. barras</th>
                <th>Lote</th>
                <th>Data lan√ßamento</th>
                <th>Validade</th>
                <th>Status</th>
                <th>Qtd</th>
                <th>Dias p/ vencer</th>
                <th>Usu√°rio</th>
                <th>Cadastro</th>
                <th>Obs.</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody id="tabelaCorpo">
              <!-- Linhas via JS -->
            </tbody>
          </table>
        </div>
        <div class="small">
          Base √∫nica para todas as lojas (Firestore). Depois d√° pra criar vis√µes s√≥ por loja.
        </div>
      </section>

      <!-- ADMIN ‚Äì GERENCIAMENTO DE USU√ÅRIOS (S√ì ADMIN V√ä) -->
      <section class="card hidden" id="adminCard">
        <h2>Administra√ß√£o de usu√°rios</h2>
        <p class="small">
          Somente administradores veem esta se√ß√£o. Aqui voc√™ ajusta o tipo e a loja de cada usu√°rio.
        </p>
        <div class="table-wrapper admin-table">
          <table>
            <thead>
              <tr>
                <th>E-mail</th>
                <th>Tipo</th>
                <th>Loja</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody id="adminTabelaCorpo">
              <!-- Linhas geradas via JS -->
            </tbody>
          </table>
        </div>
      </section>
    </section>
  </main>

  <!-- SCRIPT PRINCIPAL -->
  <script type="module">
    // IMPORTS DO FIREBASE (CDN)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      getDocs,
      query,
      orderBy,
      doc,
      getDoc,
      setDoc,
      updateDoc,
      deleteDoc
    } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";
    import {
      getAuth,
      onAuthStateChanged,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      signOut,
      sendPasswordResetEmail,
      GoogleAuthProvider,
      signInWithPopup
    } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";

    // CONFIG DO SEU FIREBASE
    const firebaseConfig = {
      apiKey: "AIzaSyDa1z9LwlSHxwSTC974ci9RMEYdEiA_wEg",
      authDomain: "controle-validade-fc108.firebaseapp.com",
      projectId: "controle-validade-fc108",
      storageBucket: "controle-validade-fc108.firebasestorage.app",
      messagingSenderId: "737065688686",
      appId: "1:737065688686:web:ed3e602baf64c1fb4f907f",
      measurementId: "G-VJ8DMM47EN"
    };

    // INICIALIZA√á√ÉO
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const itensRef = collection(db, "itens_validade");
    const usuariosRef = collection(db, "usuarios");

    // PERFIL DO USU√ÅRIO (admin/gerente/repositor)
    let perfilUsuario = null;

    // CONTROLE DE EDI√á√ÉO
    let itemEmEdicaoId = null;

    // ELEMENTOS DOM
    const loginCard = document.getElementById("loginCard");
    const appContent = document.getElementById("appContent");
    const btnLogout = document.getElementById("btnLogout");
    const userEmailSpan = document.getElementById("userEmail");
    const authError = document.getElementById("authError");
    const emailAuth = document.getElementById("emailAuth");
    const senhaAuth = document.getElementById("senhaAuth");
    const btnAuthMain = document.getElementById("btnAuthMain");
    const btnEsqueceuSenha = document.getElementById("btnEsqueceuSenha");
    const btnGoogle = document.getElementById("btnGoogle");
    const btnModoLogin = document.getElementById("btnModoLogin");
    const btnModoCadastro = document.getElementById("btnModoCadastro");
    const btnApple = document.getElementById("btnApple");

    const adminCard = document.getElementById("adminCard");
    const adminTabelaCorpo = document.getElementById("adminTabelaCorpo");

    const filtroDepartamentoSelect = document.getElementById("filtroDepartamento");
    const btnExportExcel = document.getElementById("btnExportExcel");
    const btnExportPDF = document.getElementById("btnExportPDF");

    const btnCancelarEdicao = document.getElementById("btnCancelarEdicao");
    const tituloFormulario = document.getElementById("tituloFormulario");

    let modoCadastro = false; // false = login, true = criar conta

    function setModoAuth(cadastro) {
      modoCadastro = cadastro;
      if (cadastro) {
        btnModoCadastro.classList.add("active");
        btnModoLogin.classList.remove("active");
        btnAuthMain.textContent = "Criar conta";
      } else {
        btnModoLogin.classList.add("active");
        btnModoCadastro.classList.remove("active");
        btnAuthMain.textContent = "Entrar";
      }
      authError.textContent = "";
    }

    btnModoLogin.addEventListener("click", () => setModoAuth(false));
    btnModoCadastro.addEventListener("click", () => setModoAuth(true));

    function mapearErroAuth(code) {
      if (!code) return "Erro ao autenticar. Tente novamente.";
      if (code.includes("auth/invalid-email")) return "E-mail inv√°lido.";
      if (code.includes("auth/user-not-found")) return "Usu√°rio n√£o encontrado.";
      if (code.includes("auth/wrong-password")) return "Senha incorreta.";
      if (code.includes("auth/email-already-in-use")) return "Este e-mail j√° est√° em uso.";
      if (code.includes("auth/weak-password")) return "Senha muito fraca (m√≠n. 6 caracteres).";
      if (code.includes("operation-not-allowed")) return "Esse tipo de login n√£o est√° habilitado no Firebase.";
      return "Erro: " + code.replace("auth/", "");
    }

    // Fun√ß√µes de data
    function getDataHojeISO() {
      const hoje = new Date();
      hoje.setHours(0, 0, 0, 0);
      const ano = hoje.getFullYear();
      const mes = String(hoje.getMonth() + 1).padStart(2, "0");
      const dia = String(hoje.getDate()).padStart(2, "0");
      return `${ano}-${mes}-${dia}`;
    }

    function formatarDataBr(dataStr) {
      if (!dataStr) return "";
      const [ano, mes, dia] = dataStr.split("-");
      return `${dia}/${mes}/${ano}`;
    }

    function formatarDataHoraBr(isoString) {
      if (!isoString) return "";
      const d = new Date(isoString);
      if (isNaN(d.getTime())) return "";
      const dia = String(d.getDate()).padStart(2, "0");
      const mes = String(d.getMonth() + 1).padStart(2, "0");
      const ano = d.getFullYear();
      const horas = String(d.getHours()).padStart(2, "0");
      const mins = String(d.getMinutes()).padStart(2, "0");
      return `${dia}/${mes}/${ano} ${horas}:${mins}`;
    }

    function atualizarDataLancamento() {
      const input = document.getElementById("dataLancamento");
      if (input) {
        input.value = getDataHojeISO();
      }
    }

    // LOGIN / CADASTRO
    btnAuthMain.addEventListener("click", async () => {
      authError.textContent = "";
      const email = emailAuth.value.trim();
      const senha = senhaAuth.value.trim();

      if (!email || !senha) {
        authError.textContent = "Preencha e-mail e senha.";
        return;
      }

      try {
        if (modoCadastro) {
          await createUserWithEmailAndPassword(auth, email, senha);
        } else {
          await signInWithEmailAndPassword(auth, email, senha);
        }
      } catch (e) {
        console.error(e);
        authError.textContent = mapearErroAuth(e.code || e.message);
      }
    });

    // LOGIN COM GOOGLE
    btnGoogle.addEventListener("click", async () => {
      authError.textContent = "";
      try {
        const provider = new GoogleAuthProvider();
        await signInWithPopup(auth, provider);
      } catch (e) {
        console.error(e);
        authError.textContent = "Erro ao entrar com Google.";
      }
    });

    // BOT√ÉO APPLE (VISUAL)
    btnApple.addEventListener("click", () => {
      alert("Login com Apple ainda n√£o est√° configurado.\nPor enquanto use e-mail/senha ou Google üôÇ");
    });

    // ESQUECEU SENHA
    btnEsqueceuSenha.addEventListener("click", async () => {
      authError.textContent = "";
      const email = emailAuth.value.trim();
      if (!email) {
        authError.textContent = "Digite o e-mail para recuperar a senha.";
        return;
      }
      try {
        await sendPasswordResetEmail(auth, email);
        authError.textContent = "E-mail de recupera√ß√£o enviado.";
      } catch (e) {
        console.error(e);
        authError.textContent = mapearErroAuth(e.code || e.message);
      }
    });

    // LOGOUT
    btnLogout.addEventListener("click", async () => {
      await signOut(auth);
    });

    // üîê TRAVA E AJUSTA O CAMPO LOJA CONFORME O PERFIL
    function aplicarRestricoesPorPerfil() {
      const selectLoja = document.getElementById("loja");
      const ajudaCampoLoja = document.getElementById("ajudaCampoLoja");
      if (!selectLoja || !perfilUsuario) return;

      selectLoja.disabled = false;
      if (ajudaCampoLoja) ajudaCampoLoja.textContent = "";

      if (perfilUsuario.tipo === "admin") {
        return;
      }

      if (
        (perfilUsuario.tipo === "gerente" ||
          perfilUsuario.tipo === "repositor") &&
        perfilUsuario.loja
      ) {
        selectLoja.value = perfilUsuario.loja;
        selectLoja.disabled = true;
        if (ajudaCampoLoja) {
          ajudaCampoLoja.textContent =
            "Sua conta est√° vinculada √† loja " +
            perfilUsuario.loja +
            ". Voc√™ s√≥ lan√ßa produtos nesta loja.";
        }
      } else if (
        perfilUsuario.tipo === "gerente" ||
        perfilUsuario.tipo === "repositor"
      ) {
        if (ajudaCampoLoja) {
          ajudaCampoLoja.textContent =
            "Sua conta n√£o tem loja vinculada. Pe√ßa a um ADMIN para definir sua loja na tela de Administra√ß√£o.";
        }
      }
    }

    // üîê Carrega ou cria o perfil do usu√°rio (admin/gerente/repositor)
    async function carregarPerfilUsuario(user) {
      const usuariosDocRef = doc(db, "usuarios", user.uid);
      const snap = await getDoc(usuariosDocRef);

      if (snap.exists()) {
        perfilUsuario = snap.data();
      } else {
        perfilUsuario = {
          tipo: "repositor",
          loja: "",
          email: user.email || "",
          criadoEm: new Date().toISOString()
        };
        await setDoc(usuariosDocRef, perfilUsuario);
      }

      const existingBadge = document.getElementById("roleBadge");
      if (existingBadge) existingBadge.remove();
      const userInfoDiv = document.getElementById("userInfo");
      if (userInfoDiv && perfilUsuario) {
        const span = document.createElement("span");
        span.id = "roleBadge";
        span.className = "tag-loja";
        const lojaTxt = perfilUsuario.loja ? ` ‚Ä¢ ${perfilUsuario.loja}` : "";
        span.textContent = perfilUsuario.tipo.toUpperCase() + lojaTxt;
        userInfoDiv.insertBefore(span, btnLogout);
      }

      aplicarRestricoesPorPerfil();
      atualizarDataLancamento();
      await renderizarTabela();
      await renderizarUsuariosAdmin();
    }

    // CONTROLE DE LOGIN
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        loginCard.classList.add("hidden");
        appContent.classList.remove("hidden");
        btnLogout.classList.remove("hidden");
        userEmailSpan.textContent = user.email || "";
        emailAuth.value = "";
        senhaAuth.value = "";
        authError.textContent = "";
        atualizarDataLancamento();
        await carregarPerfilUsuario(user);
      } else {
        loginCard.classList.remove("hidden");
        appContent.classList.add("hidden");
        btnLogout.classList.add("hidden");
        userEmailSpan.textContent = "";
        perfilUsuario = null;
        if (adminCard) adminCard.classList.add("hidden");
        cancelarEdicao();
      }
    });

    // ---- PARTE DO APP (ITENS) ----
    function calcularStatus(dataValidadeStr) {
      if (!dataValidadeStr) {
        return { status: "ok", dias: null };
      }
      const hoje = new Date();
      hoje.setHours(0, 0, 0, 0);
      const dataValidade = new Date(dataValidadeStr + "T00:00:00");
      const diffMs = dataValidade - hoje;
      const diffDias = Math.round(diffMs / (1000 * 60 * 60 * 24));

      if (diffDias < 0) {
        return { status: "vencido", dias: diffDias };
      } else if (diffDias <= 30) {
        return { status: "alerta", dias: diffDias };
      } else {
        return { status: "ok", dias: diffDias };
      }
    }

    async function carregarItensDoBanco() {
      const q = query(itensRef, orderBy("validade", "asc"));
      const snapshot = await getDocs(q);
      const itens = [];
      snapshot.forEach((docSnap) => {
        itens.push({ id: docSnap.id, ...docSnap.data() });
      });
      return itens;
    }

    // Filtra por status, busca, departamento e permiss√£o
    async function obterItensFiltrados() {
      const filtroStatus =
        document.querySelector(".filters .btn-outline[data-filter].active")?.dataset.filter ||
        "todos";
      const textoBusca = (document.getElementById("busca")?.value || "")
        .trim()
        .toLowerCase();
      const filtroDepartamento = filtroDepartamentoSelect
        ? filtroDepartamentoSelect.value
        : "todos";

      const itens = await carregarItensDoBanco();
      const uidAtual = auth.currentUser ? auth.currentUser.uid : null;

      return itens.filter((item) => {
        const { status, dias } = calcularStatus(item.validade);

        // Filtro por dias
        if (filtroStatus === "vence15") {
          if (!(dias !== null && dias >= 0 && dias <= 15)) return false;
        } else if (filtroStatus === "vence30") {
          if (!(dias !== null && dias > 15 && dias <= 30)) return false;
        } else if (filtroStatus === "vencido") {
          if (status !== "vencido") return false;
        }

        // Departamento
        if (filtroDepartamento && filtroDepartamento !== "todos") {
          if ((item.departamento || "") !== filtroDepartamento) return false;
        }

        // Busca
        if (textoBusca) {
          const alvo = (
            (item.descricao || "") +
            " " +
            (item.codigoBarras || "")
          ).toLowerCase();
          if (!alvo.includes(textoBusca)) return false;
        }

        // Permiss√µes
        if (!perfilUsuario) return false;

        if (perfilUsuario.tipo === "admin") {
          return true;
        } else if (perfilUsuario.tipo === "gerente") {
          return item.loja === perfilUsuario.loja;
        } else {
          return item.criadoPorUid === uidAtual;
        }
      });
    }

    function podeEditarItem(item) {
      if (!perfilUsuario || !auth.currentUser) return false;
      if (perfilUsuario.tipo === "admin") return true;

      if (perfilUsuario.tipo !== "repositor") return false;
      if (item.criadoPorUid !== auth.currentUser.uid) return false;

      // pode editar at√© 1 dia ap√≥s a data de lan√ßamento
      const dataLanc = item.dataLancamento || (item.criadoEm ? item.criadoEm.slice(0, 10) : null);
      if (!dataLanc) return false;
      const lanc = new Date(dataLanc + "T00:00:00");
      const agora = new Date();
      const diffMs = agora - lanc;
      const diffDias = diffMs / (1000 * 60 * 60 * 24);
      return diffDias <= 1;
    }

    async function renderizarTabela() {
      const tbody = document.getElementById("tabelaCorpo");
      if (!tbody) return;
      tbody.innerHTML = "";

      if (!perfilUsuario) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 14;
        td.innerHTML = '<div class="empty-state">Carregando perfil do usu√°rio...</div>';
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }

      const filtrados = await obterItensFiltrados();

      if (filtrados.length === 0) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 14;
        td.innerHTML = '<div class="empty-state">Nenhum item encontrado.</div>';
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }

      filtrados.forEach((item) => {
        const { status, dias } = calcularStatus(item.validade);
        const tr = document.createElement("tr");

        const tdLoja = document.createElement("td");
        tdLoja.innerHTML = `<span class="tag-loja">${item.loja || "-"}</span>`;
        tr.appendChild(tdLoja);

        const tdDepto = document.createElement("td");
        tdDepto.textContent = item.departamento || "-";
        tr.appendChild(tdDepto);

        const tdDesc = document.createElement("td");
        tdDesc.textContent = item.descricao || "-";
        tr.appendChild(tdDesc);

        const tdCod = document.createElement("td");
        tdCod.textContent = item.codigoBarras || "-";
        tr.appendChild(tdCod);

        const tdLote = document.createElement("td");
        tdLote.textContent = item.lote || "-";
        tr.appendChild(tdLote);

        const tdDataLanc = document.createElement("td");
        tdDataLanc.textContent = item.dataLancamento
          ? formatarDataBr(item.dataLancamento)
          : "-";
        tr.appendChild(tdDataLanc);

        const tdVal = document.createElement("td");
        tdVal.textContent = item.validade
          ? formatarDataBr(item.validade)
          : "-";
        tr.appendChild(tdVal);

        const tdStatus = document.createElement("td");
        const span = document.createElement("span");
        span.classList.add("badge");
        if (status === "ok") {
          span.classList.add("badge-ok");
          span.textContent = "OK";
        } else if (status === "alerta") {
          span.classList.add("badge-alerta");
          span.textContent = "Vence em 30 dias";
        } else {
          span.classList.add("badge-vencido");
          span.textContent = "Vencido";
        }
        tdStatus.appendChild(span);
        tr.appendChild(tdStatus);

        const tdQtd = document.createElement("td");
        tdQtd.textContent = item.quantidade || "-";
        tr.appendChild(tdQtd);

        const tdDias = document.createElement("td");
        tdDias.textContent = dias !== null ? dias : "-";
        tr.appendChild(tdDias);

        const tdUsuario = document.createElement("td");
        tdUsuario.textContent = item.criadoPorEmail || "-";
        tr.appendChild(tdUsuario);

        const tdCadastro = document.createElement("td");
        tdCadastro.textContent = item.criadoEm
          ? formatarDataHoraBr(item.criadoEm)
          : "-";
        tr.appendChild(tdCadastro);

        const tdObs = document.createElement("td");
        tdObs.textContent = item.observacao || "-";
        tr.appendChild(tdObs);

        const tdAcoes = document.createElement("td");
        tdAcoes.style.whiteSpace = "nowrap";

        if (podeEditarItem(item)) {
          const btnEdit = document.createElement("button");
          btnEdit.textContent = "Editar";
          btnEdit.className = "btn-outline";
          btnEdit.style.fontSize = "11px";
          btnEdit.addEventListener("click", () => iniciarEdicao(item));
          tdAcoes.appendChild(btnEdit);
        }

        if (perfilUsuario && perfilUsuario.tipo === "admin") {
          const btnDel = document.createElement("button");
          btnDel.textContent = "Excluir";
          btnDel.className = "btn-outline";
          btnDel.style.fontSize = "11px";
          btnDel.style.marginLeft = "4px";
          btnDel.addEventListener("click", () => excluirItem(item));
          tdAcoes.appendChild(btnDel);
        }

        tr.appendChild(tdAcoes);

        tbody.appendChild(tr);
      });
    }

    function limparFormulario() {
      const loja = document.getElementById("loja");
      const codigoBarras = document.getElementById("codigoBarras");
      const descricao = document.getElementById("descricao");
      const quantidade = document.getElementById("quantidade");
      const validade = document.getElementById("validade");
      const observacao = document.getElementById("observacao");
      const departamento = document.getElementById("departamento");
      const lote = document.getElementById("lote");

      if (!loja) return;

      loja.value = "";
      codigoBarras.value = "";
      descricao.value = "";
      quantidade.value = "";
      validade.value = "";
      observacao.value = "";
      if (departamento) departamento.value = "";
      if (lote) lote.value = "";
      atualizarDataLancamento();
      aplicarRestricoesPorPerfil();
    }

    function iniciarEdicao(item) {
      itemEmEdicaoId = item.id;
      tituloFormulario.textContent = "Editar lan√ßamento";
      const btnSalvar = document.getElementById("btnSalvar");
      btnSalvar.textContent = "Salvar altera√ß√µes";
      btnCancelarEdicao.classList.remove("hidden");

      document.getElementById("loja").value = item.loja || "";
      document.getElementById("dataLancamento").value =
        item.dataLancamento || getDataHojeISO();
      document.getElementById("departamento").value = item.departamento || "";
      document.getElementById("codigoBarras").value = item.codigoBarras || "";
      document.getElementById("descricao").value = item.descricao || "";
      document.getElementById("lote").value = item.lote || "";
      document.getElementById("quantidade").value =
        item.quantidade != null ? item.quantidade : "";
      document.getElementById("validade").value = item.validade || "";
      document.getElementById("observacao").value = item.observacao || "";

      aplicarRestricoesPorPerfil();
    }

    function cancelarEdicao() {
      itemEmEdicaoId = null;
      tituloFormulario.textContent = "Novo lan√ßamento";
      const btnSalvar = document.getElementById("btnSalvar");
      if (btnSalvar) btnSalvar.textContent = "Salvar lan√ßamento";
      if (btnCancelarEdicao) btnCancelarEdicao.classList.add("hidden");
      limparFormulario();
    }

    if (btnCancelarEdicao) {
      btnCancelarEdicao.addEventListener("click", () => {
        cancelarEdicao();
      });
    }

    // Enforce numeric-only and max 13 on c√≥digo de barras
    const inputCodigo = document.getElementById("codigoBarras");
    if (inputCodigo) {
      inputCodigo.addEventListener("input", () => {
        inputCodigo.value = inputCodigo.value.replace(/\D/g, "").slice(0, 13);
      });
    }

    // SALVAR / ATUALIZAR ITEM
    const btnSalvar = document.getElementById("btnSalvar");
    if (btnSalvar) {
      btnSalvar.addEventListener("click", async () => {
        let lojaSelecionada = document.getElementById("loja").value.trim();
        const dataLancamento = document.getElementById("dataLancamento").value;
        const departamento = document.getElementById("departamento").value.trim();
        const codigoBarras = document
          .getElementById("codigoBarras")
          .value.trim();
        const descricao = document.getElementById("descricao").value.trim();
        const lote = document.getElementById("lote").value.trim();
        const quantidade = document.getElementById("quantidade").value;
        const validade = document.getElementById("validade").value;
        const observacao = document
          .getElementById("observacao")
          .value.trim();

        // For√ßa a loja pelo perfil para gerente e repositor
        if (
          perfilUsuario &&
          (perfilUsuario.tipo === "gerente" ||
            perfilUsuario.tipo === "repositor")
        ) {
          lojaSelecionada = perfilUsuario.loja || "";
        }

        if (
          perfilUsuario &&
          (perfilUsuario.tipo === "gerente" ||
            perfilUsuario.tipo === "repositor") &&
          !lojaSelecionada
        ) {
          alert(
            "Sua conta n√£o est√° vinculada a nenhuma loja. Pe√ßa para um ADMIN definir sua loja na tela de Administra√ß√£o."
          );
          return;
        }

        if (!lojaSelecionada || !departamento || !codigoBarras || !descricao || !validade) {
          alert(
            "Preencha pelo menos: Loja, Departamento, C√≥digo de barras, Descri√ß√£o e Validade."
          );
          return;
        }

        if (!/^\d{1,13}$/.test(codigoBarras)) {
          alert("O c√≥digo de barras deve conter apenas n√∫meros, com no m√°ximo 13 d√≠gitos.");
          return;
        }

        try {
          const user = auth.currentUser;

          const campos = {
            loja: lojaSelecionada,
            dataLancamento: dataLancamento || getDataHojeISO(),
            departamento,
            codigoBarras,
            descricao,
            lote: lote || null,
            quantidade: quantidade ? Number(quantidade) : null,
            validade,
            observacao
          };

          if (itemEmEdicaoId) {
            // atualiza√ß√£o
            const docRef = doc(db, "itens_validade", itemEmEdicaoId);
            await updateDoc(docRef, campos);
          } else {
            // novo
            await addDoc(itensRef, {
              ...campos,
              criadoEm: new Date().toISOString(),
              criadoPorUid: user ? user.uid : null,
              criadoPorEmail: user ? user.email : null
            });
          }

          cancelarEdicao();
          await renderizarTabela();
        } catch (e) {
          console.error("Erro ao salvar:", e);
          alert("Erro ao salvar. Verifique o console do navegador.");
        }
      });
    }

    async function excluirItem(item) {
      if (!perfilUsuario || perfilUsuario.tipo !== "admin") return;
      const ok = confirm(
        `Tem certeza que deseja excluir o item:\n${item.descricao || ""} (${item.codigoBarras || ""})`
      );
      if (!ok) return;
      try {
        await deleteDoc(doc(db, "itens_validade", item.id));
        if (itemEmEdicaoId === item.id) cancelarEdicao();
        await renderizarTabela();
      } catch (e) {
        console.error(e);
        alert("Erro ao excluir item.");
      }
    }

    // FILTROS E BUSCA
    document
      .querySelectorAll(".filters .btn-outline[data-filter]")
      .forEach((btn) => {
        btn.addEventListener("click", async () => {
          document
            .querySelectorAll(".filters .btn-outline[data-filter]")
            .forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
          await renderizarTabela();
        });
      });

    const inputBusca = document.getElementById("busca");
    if (inputBusca) {
      inputBusca.addEventListener("input", async () => {
        await renderizarTabela();
      });
    }

    if (filtroDepartamentoSelect) {
      filtroDepartamentoSelect.addEventListener("change", async () => {
        await renderizarTabela();
      });
    }

    // ---- EXPORTA√á√ïES ----

    // Excel (.xlsx) usando SheetJS
    function exportarExcel(itens) {
      const headers = [
        "Loja",
        "Departamento",
        "Descricao",
        "CodigoBarras",
        "Lote",
        "DataLancamento",
        "Validade",
        "Status",
        "Quantidade",
        "DiasParaVencer",
        "Usuario",
        "CriadoEm",
        "Observacao"
      ];

      const data = [headers];

      itens.forEach((item) => {
        const { status, dias } = calcularStatus(item.validade);
        let statusTxt =
          status === "ok" ? "OK" : status === "alerta" ? "Vence em 30 dias" : "Vencido";

        data.push([
          item.loja || "",
          item.departamento || "",
          item.descricao || "",
          item.codigoBarras || "",
          item.lote || "",
          item.dataLancamento ? formatarDataBr(item.dataLancamento) : "",
          item.validade ? formatarDataBr(item.validade) : "",
          statusTxt,
          item.quantidade != null ? item.quantidade : "",
          dias != null ? dias : "",
          item.criadoPorEmail || "",
          item.criadoEm ? formatarDataHoraBr(item.criadoEm) : "",
          item.observacao || ""
        ]);
      });

      const ws = XLSX.utils.aoa_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Validades");

      XLSX.writeFile(wb, "controle-validade.xlsx");
    }

    if (btnExportExcel) {
      btnExportExcel.addEventListener("click", async () => {
        if (!perfilUsuario) {
          alert("Fa√ßa login para exportar os dados.");
          return;
        }
        const itens = await obterItensFiltrados();
        if (!itens.length) {
          alert("N√£o h√° itens para exportar com os filtros atuais.");
          return;
        }
        try {
          exportarExcel(itens);
        } catch (e) {
          console.error(e);
          alert("Erro ao gerar Excel. Verifique o console do navegador.");
        }
      });
    }

    // PDF com tabela (jsPDF + AutoTable)
    if (btnExportPDF) {
      btnExportPDF.addEventListener("click", async () => {
        if (!perfilUsuario) {
          alert("Fa√ßa login para exportar os dados.");
          return;
        }
        const itens = await obterItensFiltrados();
        if (!itens.length) {
          alert("N√£o h√° itens para exportar com os filtros atuais.");
          return;
        }

        const { jsPDF } = window.jspdf || {};
        if (!jsPDF || !window.jspdf || !window.jspdf.jsPDF) {
          alert("Biblioteca jsPDF n√£o foi carregada.");
          return;
        }

        const docPDF = new jsPDF("l", "mm", "a4");

        docPDF.setFontSize(14);
        docPDF.text("Relat√≥rio - Controle de Validade", 14, 14);
        docPDF.setFontSize(10);

        const head = [
          [
            "Loja",
            "Depto",
            "Produto",
            "C√≥d. barras",
            "Lote",
            "Data lanc.",
            "Validade",
            "Status",
            "Qtd",
            "Dias",
            "Usu√°rio",
            "Cadastro",
            "Obs."
          ]
        ];

        const body = itens.map((item) => {
          const { status, dias } = calcularStatus(item.validade);
          let statusTxt =
            status === "ok" ? "OK" : status === "alerta" ? "Vence em 30 dias" : "Vencido";

          return [
            item.loja || "",
            item.departamento || "",
            item.descricao || "",
            item.codigoBarras || "",
            item.lote || "",
            item.dataLancamento ? formatarDataBr(item.dataLancamento) : "",
            item.validade ? formatarDataBr(item.validade) : "",
            statusTxt,
            item.quantidade != null ? item.quantidade : "",
            dias != null ? dias : "",
            item.criadoPorEmail || "",
            item.criadoEm ? formatarDataHoraBr(item.criadoEm) : "",
            item.observacao || ""
          ];
        });

        docPDF.autoTable({
          head,
          body,
          startY: 20,
          styles: { fontSize: 8, cellPadding: 2 },
          headStyles: { fillColor: [17, 24, 39], textColor: 255 }
        });

        docPDF.save("controle-validade.pdf");
      });
    }

    // ---- ADMIN ‚Äì USU√ÅRIOS ----
    async function carregarUsuarios() {
      const snapshot = await getDocs(usuariosRef);
      const lista = [];
      snapshot.forEach((d) => {
        lista.push({ id: d.id, ...d.data() });
      });
      return lista;
    }

    async function renderizarUsuariosAdmin() {
      if (!adminTabelaCorpo || !adminCard) return;

      if (!perfilUsuario || perfilUsuario.tipo !== "admin") {
        adminCard.classList.add("hidden");
        adminTabelaCorpo.innerHTML = "";
        return;
      }

      adminCard.classList.remove("hidden");
      adminTabelaCorpo.innerHTML = "";

      const usuarios = await carregarUsuarios();

      if (usuarios.length === 0) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 4;
        td.innerHTML = '<div class="empty-state">Nenhum usu√°rio encontrado.</div>';
        tr.appendChild(td);
        adminTabelaCorpo.appendChild(tr);
        return;
      }

      usuarios.forEach((u) => {
        const tr = document.createElement("tr");

        const tdEmail = document.createElement("td");
        tdEmail.textContent = u.email || "-";
        tr.appendChild(tdEmail);

        const tdTipo = document.createElement("td");
        const selTipo = document.createElement("select");
        selTipo.innerHTML = `
          <option value="admin">Admin</option>
          <option value="gerente">Gerente</option>
          <option value="repositor">Repositor</option>
        `;
        selTipo.value = u.tipo || "repositor";
        tdTipo.appendChild(selTipo);
        tr.appendChild(tdTipo);

        const tdLoja = document.createElement("td");
        const selLoja = document.createElement("select");
        selLoja.innerHTML = `
          <option value="">(todas/nenhuma)</option>
          <option value="PV">Ponta Verde</option>
          <option value="Farol">Farol</option>
          <option value="Praia">Praia</option>
          <option value="Riomar">Riomar</option>
        `;
        selLoja.value = u.loja || "";
        tdLoja.appendChild(selLoja);
        tr.appendChild(tdLoja);

        const tdAcoes = document.createElement("td");
        const btnSalvar = document.createElement("button");
        btnSalvar.textContent = "Salvar";
        btnSalvar.className = "btn-outline";
        btnSalvar.addEventListener("click", async () => {
          const novoTipo = selTipo.value;
          const novaLoja = selLoja.value;
          try {
            await updateDoc(doc(db, "usuarios", u.id), {
              tipo: novoTipo,
              loja: novaLoja
            });
            alert("Perfil atualizado com sucesso.");
            if (auth.currentUser && auth.currentUser.uid === u.id) {
              perfilUsuario.tipo = novoTipo;
              perfilUsuario.loja = novaLoja;
              aplicarRestricoesPorPerfil();
              await renderizarTabela();
              await renderizarUsuariosAdmin();
            }
          } catch (e) {
            console.error(e);
            alert("Erro ao atualizar usu√°rio.");
          }
        });
        tdAcoes.appendChild(btnSalvar);
        tr.appendChild(tdAcoes);

        adminTabelaCorpo.appendChild(tr);
      });
    }

    // Ao carregar a p√°gina sem estar logado, j√° deixa a data de lan√ßamento em hoje (para quando logar)
    atualizarDataLancamento();
  </script>
</body>
</html>
