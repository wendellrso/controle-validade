<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Controle de Validade • Palato</title>
  <!-- Essencial para scanner funcionar em celular -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <link rel="icon" href="palato-logo.png" />
  
  <!-- SheetJS para Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- jsPDF para PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
  <!-- Html5Qrcode -->
  <script src="https://unpkg.com/html5-qrcode@2.3.10/minified/html5-qrcode.min.js"></script>

  <style>
    :root {
      --bg-main: #050509;
      --bg-card: #11141b;
      --bg-card-alt: #181b23;
      --accent-red: #e30613;
      --accent-red-soft: #ff4b5c;
      --border-soft: #262a33;
      --text-main: #ffffff;
      --text-soft: #9ca3af;
      --input-bg: #050509;
      --input-border: #272a33;
    }
    * { box-sizing: border-box; font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
    body { margin: 0; background: radial-gradient(circle at top, #111827 0, #050509 45%, #000 100%); color: var(--text-main); }
    
    /* ===== LOGIN ===== */
    #loginView { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 24px; }
    .login-card { width: 100%; max-width: 420px; background: rgba(8,10,20,0.98); border-radius: 24px; padding: 32px 28px 28px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.7); border: 1px solid rgba(255,255,255,0.04); }
    .login-logo img { height: 32px; }
    .login-title { text-align: center; margin-bottom: 4px; font-size: 20px; letter-spacing: 0.12em; }
    .login-subtitle { text-align: center; margin-bottom: 24px; font-size: 13px; color: var(--text-soft); }
    .form-group { margin-bottom: 14px; }
    label { font-size: 13px; margin-bottom: 4px; color: var(--text-soft); display: block; }
    input[type="email"], input[type="password"] { width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid var(--input-border);
      background: var(--input-bg); color: var(--text-main); font-size: 14px; }
    .btn { border-radius: 999px; border: none; padding: 10px 16px; font-size: 14px; font-weight: 500; cursor: pointer;
      transition: all 0.08s ease; }
    .btn-primary { width: 100%; background: var(--accent-red); color: #fff; margin-top: 6px;
      box-shadow: 0 10px 30px rgba(227,6,19,0.5); }
    .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 14px 34px rgba(227,6,19,0.7); }

    /* ===== APP ===== */
    #appView { display: none; min-height: 100vh; flex-direction: column; background: linear-gradient(135deg, #000 0%, #050509 40%, #020617 100%); }
    .app-header { display: flex; align-items: center; justify-content: space-between; padding: 10px 24px; background: #000;
      border-bottom: 1px solid #111827; }
    .header-menu-toggle { display: none; width: 32px; height: 32px; border-radius: 999px; border: 1px solid #374151;
      background: #020617; color: #e5e7eb; font-size: 18px; cursor: pointer; }
    .user-box { text-align: right; font-size: 13px; }
    .user-box strong { display: block; font-size: 14px; }
    .user-profile-label { color: var(--accent-red-soft); font-size: 11px; text-transform: uppercase; letter-spacing: 0.1em; }

    /* ===== SCANNER MODAL ===== */
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; align-items: center;
      justify-content: center; z-index: 1000; }
    .modal-backdrop.show { display: flex; }
    .modal { background: #050509; border-radius: 18px; border: 1px solid #374151; padding: 16px; width: 95%; max-width: 380px; }
    #qr-reader { width: 100%; height: 300px; border-radius: 12px; overflow: hidden; background: #000; }
    .scanner-instrucoes { margin-top: 12px; font-size: 12px; color: #9ca3af; text-align: center; }
    .scanner-status { margin-top: 8px; font-size: 13px; color: #4ade80; text-align: center; font-weight: 500; }

    /* Responsivo */
    @media (max-width: 960px) {
      .header-menu-toggle { display: flex; }
    }
  </style>
</head>
<body>

  <!-- LOGIN -->
  <div id="loginView">
    <div class="login-card">
      <div class="login-logo"><img src="palato-logo.png" alt="Palato" /></div>
      <div class="login-title">Controle de Validade</div>
      <div class="login-subtitle">Acesso restrito a colaboradores autorizados.</div>
      <div class="form-group">
        <label for="loginEmail">E-mail *</label>
        <input id="loginEmail" type="email" placeholder="seu.email@palato.com.br" />
      </div>
      <div class="form-group">
        <label for="loginSenha">Senha *</label>
        <input id="loginSenha" type="password" placeholder="Digite sua senha" />
      </div>
      <button id="btnLoginEmail" class="btn btn-primary">Entrar</button>
      <button id="btnLoginGoogle" class="btn btn-google">
        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google" /> Entrar com Google
      </button>
    </div>
  </div>

  <!-- APP -->
  <div id="appView">
    <header class="app-header">
      <div style="display:flex; align-items:center; gap:12px;">
        <button id="btnToggleMenu" class="header-menu-toggle">Menu</button>
        <img src="palato-logo.png" alt="Palato" style="height:28px;" />
        <div><h1 style="margin:0; font-size:16px; letter-spacing:0.15em; text-transform:uppercase;">CONTROLE DE VALIDADE</h1></div>
      </div>
      <div class="user-box" id="userBox"></div>
    </header>

    <main style="flex:1; padding:20px;">
      <div style="max-width:800px; margin:0 auto;">
        <div style="background:#11141b; padding:20px; border-radius:16px; border:1px solid #262a33;">
          <h2 style="margin-top:0; color:#fff;">Novo Lançamento</h2>
          <div style="display:grid; gap:12px;">
            <input id="codigoBarras" type="text" placeholder="Código de barras (leia com a câmera)" style="padding:12px; border-radius:10px; border:1px solid #374151; background:#000; color:#fff; font-size:16px;" maxlength="13" inputmode="numeric" />
            <button id="btnScan" style="padding:14px; background:#e30613; color:#fff; border:none; border-radius:12px; font-size:16px; font-weight:600; cursor:pointer;">
              Ler Código de Barras
            </button>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- SCANNER MODAL -->
  <div id="scannerModal" class="modal-backdrop">
    <div class="modal">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
        <h3 style="margin:0; color:#fff;">Leitor de Código de Barras</h3>
        <button id="btnCloseScanner" style="background:none; border:none; color:#ccc; font-size:24px; cursor:pointer;">x</button>
      </div>
      <div id="qr-reader"></div>
      <div class="scanner-status" id="scannerStatus">Aponte para o código de barras...</div>
      <div class="scanner-instrucoes">
        Use a câmera traseira • Funciona apenas em HTTPS
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDa1z9LwlSHxwSTC974ci9RMEYdEiA_wEg",
      authDomain: "controle-validade-fc108.firebaseapp.com",
      projectId: "controle-validade-fc108",
      storageBucket: "controle-validade-fc108.firebasestorage.app",
      messagingSenderId: "737065688686",
      appId: "1:737065688686:web:ed3e602baf64c1fb4f907f"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    const loginView = document.getElementById("loginView");
    const appView = document.getElementById("appView");
    const userBox = document.getElementById("userBox");
    const codigoBarras = document.getElementById("codigoBarras");
    const btnScan = document.getElementById("btnScan");
    const scannerModal = document.getElementById("scannerModal");
    const btnCloseScanner = document.getElementById("btnCloseScanner");
    const scannerStatus = document.getElementById("scannerStatus");

    let html5QrCode = null;
    let scannerAtivo = false;

    // ===== SCANNER MELHORADO =====
    async function abrirScanner() {
      if (!window.Html5Qrcode) {
        alert("Erro: biblioteca do scanner não carregou.");
        return;
      }

      // Verifica se está em HTTPS
      if (location.protocol !== "https:" && location.hostname !== "localhost" && location.hostname !== "127.0.0.1") {
        alert("O scanner só funciona em sites seguros (HTTPS).\n\nSuba este arquivo no Firebase Hosting ou Netlify para funcionar no celular.");
        return;
      }

      scannerModal.classList.add("show");
      scannerStatus.textContent = "Iniciando câmera...";

      if (html5QrCode) {
        scannerStatus.textContent = "Aponte para o código de barras";
        return;
      }

      html5QrCode = new Html5Qrcode("qr-reader");
      scannerAtivo = true;

      try {
        const cameras = await Html5Qrcode.getCameras();
        if (!cameras || cameras.length === 0) {
          scannerStatus.textContent = "Nenhuma câmera detectada";
          alert("Nenhuma câmera encontrada no dispositivo.");
          return;
        }

        // Preferência: câmera traseira
        let cameraId = cameras[0].id;
        const backCamera = cameras.find(c => 
          c.label.toLowerCase().includes("back") || 
          c.label.toLowerCase().includes("traseira") || 
          c.label.toLowerCase().includes("rear")
        );
        if (backCamera) cameraId = backCamera.id;

        const config = {
          fps: 10,
          qrbox: { width: 250, height: 150 },
          formatsToSupport: [ Html5QrcodeSupportedFormats.EAN_13, Html5QrcodeSupportedFormats.EAN_8, Html5QrcodeSupportedFormats.UPC_A ]
        };

        await html5QrCode.start(
          cameraId,
          config,
          (decodedText) => {
            if (/^\d{8,13}$/.test(decodedText.trim())) {
              codigoBarras.value = decodedText.trim();
              scannerStatus.textContent = "Código lido com sucesso!";
              // Som de sucesso
              const audio = new Audio("data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQAAAAA=");
              audio.play().catch(() => {});
              setTimeout(fecharScanner, 800);
            }
          },
          (error) => {
            // Erro silencioso (movimento, etc.)
          }
        );

        scannerStatus.textContent = "Aponte para o código de barras";

      } catch (err) {
        console.error(err);
        scannerStatus.textContent = "Erro ao acessar câmera";
        alert("Erro ao acessar a câmera.\nVerifique as permissões e se o site está em HTTPS.");
        fecharScanner();
      }
    }

    function fecharScanner() {
      scannerModal.classList.remove("show");
      if (html5QrCode && scannerAtivo) {
        scannerAtivo = false;
        html5QrCode.stop().then(() => {
          html5QrCode.clear();
          html5QrCode = null;
        }).catch(() => {});
      }
    }

    btnScan.addEventListener("click", abrirScanner);
    btnCloseScanner.addEventListener("click", fecharScanner);
    scannerModal.addEventListener("click", (e) => {
      if (e.target === scannerModal) fecharScanner();
    });

    // ===== LOGIN BÁSICO (só para demonstração) =====
    onAuthStateChanged(auth, (user) => {
      if (user) {
        loginView.style.display = "none";
        appView.style.display = "flex";
        userBox.innerHTML = `<strong>${user.displayName || user.email}</strong><br><a href="#" id="logout" style="color:#ff6b6b; font-size:12px;">Sair</a>`;
        document.getElementById("logout")?.addEventListener("click", (e) => {
          e.preventDefault();
          signOut(auth);
        });
      } else {
        loginView.style.display = "flex";
        appView.style.display = "none";
      }
    });

    document.getElementById("btnLoginEmail")?.addEventListener("click", () => {
      const email = document.getElementById("loginEmail").value;
      const pass = document.getElementById("loginSenha").value;
      if (email && pass) signInWithEmailAndPassword(auth, email, pass).catch(() => alert("Erro no login"));
    });

    document.getElementById("btnLoginGoogle")?.addEventListener("click", () => {
      signInWithPopup(auth, provider);
    });

  </script>
</body>
</html>
