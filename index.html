<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Controle de Validade ‚Ä¢ Palato</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Fonte -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- SheetJS para Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- jsPDF + autotable para PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>

  <!-- html5-qrcode para scanner -->
  <script src="https://unpkg.com/html5-qrcode@2.3.10/html5-qrcode.min.js"></script>

  <style>
    :root {
      --bg-main: #050608;
      --bg-card: #10121a;
      --bg-soft: #171924;
      --border-soft: #22263a;
      --accent: #e30613;
      --accent-soft: rgba(227, 6, 19, 0.18);
      --accent-alt: #1fbf5a;
      --text-main: #f5f5f5;
      --text-muted: #a0a4b8;
      --badge-bg: #262a3d;
      --input-bg: #141726;
      --danger: #ff4b5c;
      --warning: #ffb020;
      --success: #1fbf5a;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      background: radial-gradient(circle at top left, #151824, #050608);
      color: var(--text-main);
      min-height: 100vh;
    }

    .app-max {
      max-width: 1320px;
      margin: 0 auto;
      padding: 20px 12px 40px;
    }

    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 18px;
    }

    .topbar-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .topbar-logo {
      display: flex;
      align-items: center;
      gap: 10px;
      background: #000;
      border-radius: 999px;
      padding: 6px 12px 6px 6px;
      border: 1px solid #2a2e42;
    }

    .topbar-logo img {
      height: 26px;
    }

    .topbar-logo span {
      font-size: 13px;
      letter-spacing: 0.14em;
      color: #ffffff;
    }

    .topbar-title-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .topbar-title {
      font-size: 18px;
      font-weight: 600;
    }

    .topbar-subtitle {
      font-size: 13px;
      color: var(--text-muted);
    }

    .topbar-user {
      text-align: right;
      font-size: 13px;
    }

    .topbar-user-name {
      font-weight: 600;
    }

    .topbar-user-role {
      color: var(--text-muted);
    }

    .link-sair {
      margin-top: 2px;
      font-size: 12px;
      color: var(--danger);
      cursor: pointer;
      text-decoration: none;
    }

    .link-sair:hover {
      text-decoration: underline;
    }

    /* Layout principal */
    .main-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.05fr) minmax(0, 1.45fr);
      gap: 18px;
      align-items: flex-start;
    }

    .card {
      background: linear-gradient(145deg, var(--bg-card), #070810);
      border-radius: 16px;
      border: 1px solid var(--border-soft);
      box-shadow: 0 26px 45px rgba(0, 0, 0, 0.45);
      padding: 18px 18px 14px;
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .card-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 15px;
      font-weight: 600;
    }

    .card-title-icon {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--accent-soft);
      color: var(--accent);
      font-size: 16px;
    }

    .card-subtitle {
      font-size: 12px;
      color: var(--text-muted);
    }

    /* Campos / inputs */
    .form-grid-2 {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
      margin-bottom: 8px;
    }

    .form-row {
      display: flex;
      flex-direction: column;
      gap: 2px;
      margin-bottom: 8px;
    }

    label {
      font-size: 12px;
      color: var(--text-muted);
    }

    .required::after {
      content: " *";
      color: var(--accent);
    }

    input,
    select,
    textarea {
      background: var(--input-bg);
      border-radius: 9px;
      border: 1px solid #272a3b;
      color: var(--text-main);
      font-size: 13px;
      padding: 7px 10px;
      outline: none;
      width: 100%;
      transition: border 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
    }

    input:focus,
    select:focus,
    textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(227, 6, 19, 0.35);
      background: #151728;
    }

    select {
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      background-image: linear-gradient(45deg, transparent 50%, #ffffff 50%),
        linear-gradient(135deg, #ffffff 50%, transparent 50%);
      background-position: calc(100% - 18px) 12px, calc(100% - 12px) 12px;
      background-size: 6px 6px, 6px 6px;
      background-repeat: no-repeat;
      padding-right: 30px;
    }

    select option {
      background: #131520;
      color: #ffffff;
    }

    textarea {
      min-height: 70px;
      resize: vertical;
    }

    .input-inline {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .scan-btn {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      border: 1px solid #333852;
      background: #151726;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--text-muted);
      transition: background 0.15s ease, border 0.15s ease, transform 0.08s;
      flex-shrink: 0;
    }

    .scan-btn:hover {
      background: #1b1f32;
      border-color: var(--accent);
      color: var(--accent);
      transform: translateY(-1px);
    }

    .scan-btn span {
      font-size: 14px;
    }

    .primary-btn {
      background: var(--accent-alt);
      color: #0b120f;
      border-radius: 999px;
      border: none;
      padding: 9px 16px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: transform 0.08s ease, box-shadow 0.1s ease;
    }

    .primary-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 20px rgba(12, 180, 87, 0.35);
    }

    .primary-btn span.icon {
      font-size: 16px;
    }

    .btn-small {
      padding: 6px 10px;
      font-size: 12px;
      border-radius: 999px;
    }

    .btn-danger {
      background: rgba(255, 84, 84, 0.14);
      color: #ff9494;
    }

    .btn-danger:hover {
      background: rgba(255, 84, 84, 0.24);
    }

    .btn-ghost {
      background: #151822;
      color: var(--text-main);
      border-radius: 999px;
      border: 1px solid #2c3042;
      padding: 6px 12px;
      font-size: 12px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn-ghost:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .tag-pill {
      display: inline-flex;
      align-items: center;
      padding: 3px 8px;
      border-radius: 999px;
      background: #181b2a;
      color: var(--text-muted);
      font-size: 11px;
      gap: 6px;
    }

    .tag-pill-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--accent-alt);
    }

    /* Tabela de itens */
    .items-header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 4px;
      margin-bottom: 10px;
      gap: 10px;
    }

    .items-filters {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      font-size: 12px;
    }

    .items-filters label {
      font-size: 12px;
      color: var(--text-muted);
    }

    .items-filters select {
      min-width: 150px;
    }

    .items-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .table-wrapper {
      margin-top: 6px;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid #24283a;
      background: #090a11;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    thead {
      background: #141826;
    }

    th, td {
      padding: 7px 8px;
      text-align: left;
      border-bottom: 1px solid #202337;
    }

    th {
      font-weight: 500;
      color: var(--text-muted);
      font-size: 11px;
      white-space: nowrap;
    }

    tbody tr:nth-child(even) {
      background: #090b15;
    }

    tbody tr:hover {
      background: #15192a;
    }

    .col-status,
    .col-oferta {
      white-space: nowrap;
    }

    .col-status {
      padding-right: 4px;
    }

    .col-oferta {
      padding-left: 4px;
    }

    .badge-status {
      display: inline-flex;
      padding: 3px 9px;
      border-radius: 999px;
      font-size: 11px;
      align-items: center;
      justify-content: center;
      background: #2a1c24;
      color: #ffb7c6;
      border: 1px solid rgba(255, 143, 163, 0.6);
    }

    .badge-status.badge-vencido {
      background: rgba(255, 17, 64, 0.18);
      color: #ff9aa7;
      border-color: rgba(255, 105, 130, 0.9);
    }

    .badge-status.badge-longo {
      background: rgba(71, 187, 122, 0.18);
      color: #a4ffcc;
      border-color: rgba(75, 214, 142, 0.9);
    }

    .badge-oferta {
      display: inline-flex;
      padding: 3px 9px;
      border-radius: 999px;
      font-size: 11px;
      background: #1b1e2d;
      color: var(--text-main);
      border: 1px solid #32364b;
    }

    .badge-oferta.badge-oferta-on {
      background: rgba(31, 191, 90, 0.18);
      border-color: var(--accent-alt);
      color: #a9ffd1;
    }

    .checkbox-flag {
      width: 16px;
      height: 16px;
    }

    .actions-cell {
      display: flex;
      gap: 5px;
      flex-wrap: wrap;
    }

    .link-action {
      font-size: 11px;
      cursor: pointer;
      color: #5ab9ff;
    }

    .link-action:hover {
      text-decoration: underline;
    }

    .link-delete {
      color: #ff7b7b;
    }

    .total-itens {
      margin-top: 5px;
      font-size: 11px;
      color: var(--text-muted);
      text-align: right;
    }

    /* Login */
    #login-screen {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .login-card {
      background: radial-gradient(circle at top, #171a28, #050609);
      border-radius: 18px;
      border: 1px solid #25293b;
      padding: 22px 24px 18px;
      width: 350px;
      box-shadow: 0 26px 50px rgba(0, 0, 0, 0.55);
    }

    .login-logo {
      display: flex;
      justify-content: center;
      margin-bottom: 14px;
    }

    .login-logo img {
      height: 40px;
    }

    .login-title {
      font-size: 17px;
      font-weight: 600;
      text-align: center;
      margin-bottom: 4px;
    }

    .login-subtitle {
      font-size: 12px;
      text-align: center;
      color: var(--text-muted);
      margin-bottom: 12px;
    }

    .login-divider {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: var(--text-muted);
      margin: 8px 0;
    }

    .login-divider span.line {
      flex: 1;
      height: 1px;
      background: #24273a;
    }

    .social-btn {
      width: 100%;
      border-radius: 999px;
      border: 1px solid #2a2e42;
      background: #101321;
      color: var(--text-main);
      font-size: 13px;
      padding: 7px 12px;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      cursor: pointer;
    }

    .social-btn:hover {
      border-color: var(--accent);
    }

    .social-icon {
      width: 16px;
      height: 16px;
      border-radius: 4px;
      background: #fff;
    }

    .login-footer {
      margin-top: 10px;
      font-size: 11px;
      text-align: center;
      color: var(--text-muted);
    }

    .login-footer span {
      color: #ffffff;
    }

    /* Scanner modal */
    #scanner-modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 40;
    }

    #scanner-box {
      background: #02030a;
      border-radius: 14px;
      border: 1px solid #383e59;
      padding: 16px 16px 10px;
      width: 320px;
      max-width: 94vw;
    }

    #scanner-box h3 {
      font-size: 14px;
      margin-bottom: 6px;
    }

    #scanner-container {
      width: 100%;
      height: 260px;
    }

    #scanner-actions {
      display: flex;
      justify-content: flex-end;
      margin-top: 6px;
      gap: 8px;
    }

    /* Administra√ß√£o de usu√°rios */
    .admin-card {
      margin-top: 18px;
    }

    .users-table-wrapper {
      margin-top: 8px;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid #252a3d;
      background: #090b15;
    }

    .users-table th,
    .users-table td {
      padding: 7px 8px;
      border-bottom: 1px solid #1f2233;
      font-size: 12px;
    }

    .users-table th {
      background: #151827;
      color: var(--text-muted);
      font-weight: 500;
      font-size: 11px;
      white-space: nowrap;
    }

    .users-actions-cell {
      white-space: nowrap;
    }

    .pill-role {
      display: inline-flex;
      align-items: center;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: #171a26;
      color: var(--text-muted);
    }

    /* Utilidades */
    .hidden {
      display: none;
    }

    @media (max-width: 1050px) {
      .main-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    @media (max-width: 600px) {
      .login-card {
        width: 92vw;
      }

      .topbar {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }

      .topbar-user {
        text-align: left;
      }
    }
  </style>
</head>
<body>

<div id="login-screen">
  <div class="login-card">
    <div class="login-logo">
      <!-- Coloque palato-logo.png na raiz do projeto -->
      <img src="palato-logo.png" alt="Palato">
    </div>
    <div class="login-title">Controle de Validade</div>
    <div class="login-subtitle">Acesso restrito a colaboradores autorizados.</div>

    <div class="form-row">
      <label class="required">E-mail</label>
      <input id="login-email" type="email" placeholder="voce@palato.com.br" />
    </div>
    <div class="form-row">
      <label class="required">Senha</label>
      <input id="login-password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
    </div>
    <button id="btn-login-email" class="primary-btn" style="width:100%; margin-top:4px;">
      <span class="icon">‚èµ</span> Entrar
    </button>

    <div class="login-divider">
      <span class="line"></span>
      <span>ou</span>
      <span class="line"></span>
    </div>

    <button id="btn-login-google" class="social-btn">
      <div class="social-icon"></div>
      Entrar com Google
    </button>

    <div class="login-footer">
      <span>Palato</span> ‚Ä¢ Uso interno para gest√£o de validades.
    </div>
  </div>
</div>

<div id="app-screen" class="hidden">
  <div class="app-max">
    <header class="topbar">
      <div class="topbar-left">
        <div class="topbar-logo">
          <img src="palato-logo.png" alt="Palato">
          <span>QUALIDADE</span>
        </div>
        <div class="topbar-title-block">
          <div class="topbar-title">Controle de Validade</div>
          <div class="topbar-subtitle">Multi-loja ‚Ä¢ Acesso por perfil</div>
        </div>
      </div>
      <div class="topbar-user">
        <div class="topbar-user-name" id="user-nome">Usu√°rio</div>
        <div class="topbar-user-role" id="user-perfil">Perfil</div>
        <a id="btn-logout" class="link-sair">Sair</a>
      </div>
    </header>

    <main class="main-grid">
      <!-- NOVO LAN√áAMENTO -->
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title">
              <div class="card-title-icon">Ôºã</div>
              <span>Novo lan√ßamento</span>
            </div>
            <div class="card-subtitle">Registrar validade por loja, departamento e lote.</div>
          </div>
          <div class="tag-pill">
            <span class="tag-pill-dot"></span>
            <span>Cadastro r√°pido</span>
          </div>
        </div>

        <div class="form-row">
          <label class="required">Loja</label>
          <select id="field-loja">
            <option value="">Selecione</option>
            <option value="Ponta Verde">Ponta Verde</option>
            <option value="Farol">Farol</option>
            <option value="Praia">Praia</option>
            <option value="Riomar">Riomar</option>
            <option value="CD">CD</option>
          </select>
        </div>

        <div class="form-grid-2">
          <div class="form-row">
            <label class="required">Data lan√ßamento</label>
            <input id="field-dataLancamento" type="text" disabled />
          </div>
          <div class="form-row">
            <label class="required">Departamento</label>
            <select id="field-departamento">
              <option value="">Selecione</option>
              <option value="A√ßougue">A√ßougue</option>
              <option value="Adega">Adega</option>
              <option value="Bebidas">Bebidas</option>
              <option value="Mercearia Alimentos">Mercearia Alimentos</option>
              <option value="Mercearia N√£o Alimentos">Mercearia N√£o Alimentos</option>
              <option value="Perec√≠veis Processados">Perec√≠veis Processados</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <label class="required">C√≥d. barras (n√∫meros, m√°x. 13)</label>
          <div class="input-inline">
            <input id="field-codigoBarras" type="text" maxlength="13" placeholder="789..." />
            <button id="btn-open-scanner" type="button" class="scan-btn" title="Ler c√≥digo de barras">
              <span>üì∑</span>
            </button>
          </div>
        </div>

        <div class="form-row">
          <label class="required">Descri√ß√£o</label>
          <input id="field-descricao" type="text" placeholder="Descri√ß√£o do produto" />
        </div>

        <div class="form-grid-2">
          <div class="form-row">
            <label>Lote</label>
            <input id="field-lote" type="text" placeholder="Lote / fabrica√ß√£o" />
          </div>
          <div class="form-row">
            <label class="required">Quantidade</label>
            <input id="field-quantidade" type="number" min="1" placeholder="Qtd" />
          </div>
        </div>

        <div class="form-row">
          <label class="required">Validade</label>
          <input id="field-validade" type="text" placeholder="dd/mm/aaaa" />
        </div>

        <div class="form-row">
          <label>Observa√ß√£o</label>
          <textarea id="field-observacao" placeholder="Lote em oferta, ponto extra, etc."></textarea>
        </div>

        <div style="margin-top:10px; display:flex; justify-content:flex-end;">
          <button id="btn-salvar-lancamento" class="primary-btn">
            <span class="icon">üíæ</span> Salvar lan√ßamento
          </button>
        </div>
      </section>

      <!-- ITENS CADASTRADOS -->
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title">
              <div class="card-title-icon">üìÑ</div>
              <span>Itens cadastrados</span>
            </div>
            <div class="card-subtitle">Filtros por status de vencimento e controle de oferta.</div>
          </div>
        </div>

        <div class="items-header-row">
          <div class="items-filters">
            <label for="filtro-status">Filtros:</label>
            <select id="filtro-status">
              <option value="todos">Todos</option>
              <option value="7">Vence em 7 dias</option>
              <option value="15">Vence em 15 dias</option>
              <option value="30">Vence em 30 dias</option>
              <option value="vencido">Vencidos</option>
            </select>

            <select id="filtro-departamento">
              <option value="todos">Todos departamentos</option>
              <option value="A√ßougue">A√ßougue</option>
              <option value="Adega">Adega</option>
              <option value="Bebidas">Bebidas</option>
              <option value="Mercearia Alimentos">Mercearia Alimentos</option>
              <option value="Mercearia N√£o Alimentos">Mercearia N√£o Alimentos</option>
              <option value="Perec√≠veis Processados">Perec√≠veis Processados</option>
            </select>
          </div>

          <div class="items-actions">
            <button id="btn-marcar-oferta" class="btn-ghost">
              üì£ Marcar todos como oferta
            </button>
            <button id="btn-export-excel" class="btn-ghost">
              üìä Excel
            </button>
            <button id="btn-export-pdf" class="btn-ghost">
              üìÑ PDF
            </button>
          </div>
        </div>

        <div class="table-wrapper">
          <table id="tabela-itens">
            <thead>
            <tr>
              <th>LOJA</th>
              <th>DATA LAN√áAMENTO</th>
              <th>DEPARTAMENTO</th>
              <th>C√ìD. BARRAS</th>
              <th>DESCRI√á√ÉO</th>
              <th>QTD</th>
              <th>VALIDADE</th>
              <th class="col-status">STATUS</th>
              <th class="col-oferta">OFERTA</th>
              <th>FLAG</th>
              <th>LOTE</th>
              <th>USU√ÅRIO</th>
              <th>LAN√áADO EM</th>
              <th>OBS.</th>
              <th>A√á√ïES</th>
            </tr>
            </thead>
            <tbody>
            <!-- preenchido via JS -->
            </tbody>
          </table>
        </div>
        <div class="total-itens">
          Total de itens: <span id="total-itens">0</span>
        </div>
      </section>
    </main>

    <!-- ADMINISTRA√á√ÉO DE USU√ÅRIOS (s√≥ Admin) -->
    <section id="admin-usuarios-card" class="card admin-card hidden">
      <div class="card-header">
        <div>
          <div class="card-title">
            <div class="card-title-icon">üõ°</div>
            <span>Administra√ß√£o de usu√°rios</span>
          </div>
          <div class="card-subtitle">
            Gerencie perfis (admin, gerente, repositor) e lojas vinculadas.
          </div>
        </div>
        <button id="btn-recarregar-usuarios" class="btn-ghost">‚ü≥ Recarregar</button>
      </div>

      <div class="form-grid-2">
        <div class="form-row">
          <label>Nome</label>
          <input id="admin-nome" type="text" placeholder="Nome do usu√°rio" />
        </div>
        <div class="form-row">
          <label>E-mail</label>
          <input id="admin-email" type="email" placeholder="email@palato.com.br" />
        </div>
      </div>

      <div class="form-grid-2">
        <div class="form-row">
          <label>Perfil</label>
          <select id="admin-perfil">
            <option value="repositor">Repositor</option>
            <option value="gerente">Gerente</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <div class="form-row">
          <label>Loja</label>
          <select id="admin-loja">
            <option value="">Nenhuma</option>
            <option value="Ponta Verde">Ponta Verde</option>
            <option value="Farol">Farol</option>
            <option value="Praia">Praia</option>
            <option value="Riomar">Riomar</option>
            <option value="CD">CD</option>
          </select>
        </div>
      </div>

      <div style="margin-top:8px; margin-bottom:10px;">
        <button id="btn-salvar-usuario" class="primary-btn btn-small">
          <span class="icon">‚ûï</span> Salvar usu√°rio
        </button>
      </div>

      <div class="users-table-wrapper">
        <table class="users-table" id="tabela-usuarios">
          <thead>
          <tr>
            <th>Nome</th>
            <th>E-mail</th>
            <th>Perfil</th>
            <th>Loja</th>
            <th>A√ß√µes</th>
          </tr>
          </thead>
          <tbody>
          <!-- preenchido via JS -->
          </tbody>
        </table>
      </div>
    </section>
  </div>
</div>

<!-- Modal scanner -->
<div id="scanner-modal">
  <div id="scanner-box">
    <h3>Leitor de c√≥digo de barras</h3>
    <div id="scanner-container"></div>
    <div id="scanner-actions">
      <button id="btn-fechar-scanner" class="btn-ghost btn-small">Fechar</button>
    </div>
  </div>
</div>

<script type="module">
  import {
    initializeApp
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import {
    getAuth,
    onAuthStateChanged,
    signInWithEmailAndPassword,
    signInWithPopup,
    GoogleAuthProvider,
    signOut
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import {
    getFirestore,
    collection,
    addDoc,
    getDocs,
    query,
    where,
    orderBy,
    doc,
    updateDoc,
    deleteDoc,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  // === CONFIG FIREBASE (seu projeto) ===
  const firebaseConfig = {
    apiKey: "AIzaSyDa1z9LwlSHxwSTC974ci9RMEYdEiA_wEg",
    authDomain: "controle-validade-fc108.firebaseapp.com",
    projectId: "controle-validade-fc108",
    storageBucket: "controle-validade-fc108.firebasestorage.app",
    messagingSenderId: "737065688686",
    appId: "1:737065688686:web:ed3e602baf64c1fb4f907f",
    measurementId: "G-VJ8DMM47EN"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const googleProvider = new GoogleAuthProvider();

  // === ESTADO GLOBAL ===
  let usuarioAtual = null;   // objeto do Firebase Auth
  let perfilAtual = "repositor"; // admin | gerente | repositor
  let lojaAtual = "";
  let nomeAtual = "";

  let scannerInstance = null;

  const loginScreen = document.getElementById("login-screen");
  const appScreen = document.getElementById("app-screen");

  const userNomeSpan = document.getElementById("user-nome");
  const userPerfilSpan = document.getElementById("user-perfil");

  const tabelaItensBody = document.querySelector("#tabela-itens tbody");
  const totalItensSpan = document.getElementById("total-itens");

  const adminCard = document.getElementById("admin-usuarios-card");
  const tabelaUsuariosBody = document.querySelector("#tabela-usuarios tbody");

  // === UTIL ===
  function formatarDataHora(timestamp) {
    if (!timestamp) return "";
    const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
    const dia = String(date.getDate()).padStart(2, "0");
    const mes = String(date.getMonth() + 1).padStart(2, "0");
    const ano = date.getFullYear();
    const hora = String(date.getHours()).padStart(2, "0");
    const min = String(date.getMinutes()).padStart(2, "0");
    return `${dia}/${mes}/${ano} ${hora}:${min}`;
  }

  function hojeFormatado() {
    const now = new Date();
    const dia = String(now.getDate()).padStart(2, "0");
    const mes = String(now.getMonth() + 1).padStart(2, "0");
    const ano = now.getFullYear();
    const hora = String(now.getHours()).padStart(2, "0");
    const min = String(now.getMinutes()).padStart(2, "0");
    return { dataSimples: `${dia}/${mes}/${ano}`, dataHora: `${dia}/${mes}/${ano} ${hora}:${min}` };
  }

  function parseDataBr(str) {
    if (!str) return null;
    const [d, m, a] = str.split("/");
    const date = new Date(Number(a), Number(m) - 1, Number(d), 0, 0, 0, 0);
    if (isNaN(date.getTime())) return null;
    return date;
  }

  function calcularStatus(validadeStr) {
    const hoje = new Date();
    const val = parseDataBr(validadeStr);
    if (!val) {
      return { label: "Sem data", categoria: "outro", classe: "" };
    }
    const diffMs = val.getTime() - hoje.setHours(0, 0, 0, 0);
    const dias = Math.floor(diffMs / (1000 * 60 * 60 * 24));

    if (dias < 0) {
      return {
        label: "Vencido",
        categoria: "vencido",
        classe: "badge-vencido"
      };
    }
    if (dias <= 7) {
      return {
        label: `Vence em ${dias} dia(s)`,
        categoria: "7",
        classe: ""
      };
    }
    if (dias <= 15) {
      return {
        label: `Vence em ${dias} dia(s)`,
        categoria: "15",
        classe: ""
      };
    }
    if (dias <= 30) {
      return {
        label: `Vence em ${dias} dia(s)`,
        categoria: "30",
        classe: "badge-longo"
      };
    }
    return {
      label: `Vence em ${dias} dia(s)`,
      categoria: "outro",
      classe: "badge-longo"
    };
  }

  function atualizarDataLancamento() {
    const { dataSimples, dataHora } = hojeFormatado();
    document.getElementById("field-dataLancamento").value = dataHora;
    return dataSimples;
  }

  // === USU√ÅRIOS: GARANTIR REGISTRO NO FIRESTORE ===
  async function garantirUsuarioNoFirestore(user) {
    if (!user || !user.email) return null;
    const email = user.email.toLowerCase();

    const usuariosRef = collection(db, "usuarios");
    const q = query(usuariosRef, where("email", "==", email));
    const snap = await getDocs(q);

    if (snap.empty) {
      // cria como repositor padr√£o
      const docRef = await addDoc(usuariosRef, {
        email,
        nome: user.displayName || "",
        tipo: "repositor",
        loja: "",
        criadoEm: serverTimestamp()
      });
      return { id: docRef.id, email, nome: user.displayName || "", tipo: "repositor", loja: "" };
    } else {
      // pega o mais recente
      let chosen = snap.docs[0];
      snap.forEach(d => {
        const atual = chosen.data().criadoEm;
        const cand = d.data().criadoEm;
        if (cand && (!atual || cand.toMillis() > atual.toMillis())) {
          chosen = d;
        }
      });
      return { id: chosen.id, ...chosen.data() };
    }
  }

  // === CARREGAR LAN√áAMENTOS ===
  async function carregarLancamentos() {
    tabelaItensBody.innerHTML = `<tr><td colspan="15">Carregando...</td></tr>`;
    try {
      const lancRef = collection(db, "lancamentos");
      const snap = await getDocs(query(lancRef, orderBy("criadoEm", "desc")));

      const filtroStatus = document.getElementById("filtro-status").value;
      const filtroDep = document.getElementById("filtro-departamento").value;

      const linhas = [];

      snap.forEach(docSnap => {
        const data = docSnap.data();

        // regra de visibilidade
        const emailCriador = (data.criadoPor || "").toLowerCase();
        const lojaItem = data.loja || "";
        if (perfilAtual === "repositor") {
          if (usuarioAtual && emailCriador !== usuarioAtual.email.toLowerCase()) return;
        } else if (perfilAtual === "gerente") {
          if (lojaAtual && lojaItem !== lojaAtual) return;
        }
        // admin v√™ tudo

        const statusInfo = calcularStatus(data.validade);

        // filtro por status
        if (filtroStatus !== "todos" && statusInfo.categoria !== filtroStatus) {
          if (!(filtroStatus === "vencido" && statusInfo.categoria === "vencido")) {
            return;
          }
        }

        // filtro por departamento
        if (filtroDep !== "todos" && data.departamento !== filtroDep) {
          return;
        }

        linhas.push({ id: docSnap.id, ...data, statusInfo });
      });

      renderizarTabelaLancamentos(linhas);
    } catch (err) {
      console.error(err);
      tabelaItensBody.innerHTML = `<tr><td colspan="15">Erro ao carregar itens.</td></tr>`;
    }
  }

  function renderizarTabelaLancamentos(itens) {
    tabelaItensBody.innerHTML = "";
    if (!itens.length) {
      tabelaItensBody.innerHTML = `<tr><td colspan="15">Nenhum item encontrado.</td></tr>`;
      totalItensSpan.textContent = "0";
      return;
    }

    itens.forEach(item => {
      const tr = document.createElement("tr");

      const statusClasse = `badge-status ${item.statusInfo.classe || ""}`;
      const ofertaStatus = item.ofertaStatus || "N√£o Lan√ßado";
      const ofertaOn = ofertaStatus === "Lan√ßado";

      const flagChecked = item.ofertaFlag === true ? "checked" : "";

      tr.innerHTML = `
        <td>${item.loja || ""}</td>
        <td>${item.dataLancamento || ""}</td>
        <td>${item.departamento || ""}</td>
        <td>${item.codigoBarras || ""}</td>
        <td>${item.descricao || ""}</td>
        <td>${item.quantidade || ""}</td>
        <td>${item.validade || ""}</td>
        <td class="col-status">
          <span class="${statusClasse}">
            ${item.statusInfo.label}
          </span>
        </td>
        <td class="col-oferta">
          <span class="badge-oferta ${ofertaOn ? "badge-oferta-on" : ""}">
            ${ofertaStatus}
          </span>
        </td>
        <td style="text-align:center;">
          <input type="checkbox" class="checkbox-flag" data-id="${item.id}" ${flagChecked}>
        </td>
        <td>${item.lote || ""}</td>
        <td>${item.usuarioNome || ""}</td>
        <td>${formatarDataHora(item.criadoEm || null)}</td>
        <td>${item.observacao || ""}</td>
        <td class="actions-cell">
          <span class="link-action" data-acao="editar" data-id="${item.id}">Editar</span>
          ${
            perfilAtual === "admin"
              ? `<span class="link-action link-delete" data-acao="excluir" data-id="${item.id}">Excluir</span>`
              : ""
          }
        </td>
      `;

      tabelaItensBody.appendChild(tr);
    });

    totalItensSpan.textContent = String(itens.length);

    // eventos nas flags
    document.querySelectorAll(".checkbox-flag").forEach(chk => {
      chk.addEventListener("change", async (e) => {
        const id = e.target.getAttribute("data-id");
        const checked = e.target.checked;
        try {
          await updateDoc(doc(db, "lancamentos", id), {
            ofertaFlag: checked,
            ofertaStatus: checked ? "Lan√ßado" : "N√£o Lan√ßado"
          });
          await carregarLancamentos();
        } catch (err) {
          console.error(err);
          alert("Erro ao atualizar oferta.");
        }
      });
    });

    // a√ß√µes editar / excluir
    document.querySelectorAll(".actions-cell .link-action").forEach(elem => {
      elem.addEventListener("click", (e) => {
        const acao = e.target.getAttribute("data-acao");
        const id = e.target.getAttribute("data-id");
        if (acao === "excluir") {
          excluirLancamento(id);
        } else if (acao === "editar") {
          editarLancamento(id);
        }
      });
    });
  }

  async function excluirLancamento(id) {
    if (!confirm("Tem certeza que deseja excluir este lan√ßamento?")) return;
    try {
      await deleteDoc(doc(db, "lancamentos", id));
      await carregarLancamentos();
    } catch (err) {
      console.error(err);
      alert("Erro ao excluir.");
    }
  }

  async function editarLancamento(id) {
    // carrega o doc e joga nos campos
    try {
      const lancRef = collection(db, "lancamentos");
      const snap = await getDocs(query(lancRef, where("__name__", "==", id)));
      if (snap.empty) return;
      const data = snap.docs[0].data();

      document.getElementById("field-loja").value = data.loja || "";
      document.getElementById("field-departamento").value = data.departamento || "";
      document.getElementById("field-codigoBarras").value = data.codigoBarras || "";
      document.getElementById("field-descricao").value = data.descricao || "";
      document.getElementById("field-lote").value = data.lote || "";
      document.getElementById("field-quantidade").value = data.quantidade || "";
      document.getElementById("field-validade").value = data.validade || "";
      document.getElementById("field-observacao").value = data.observacao || "";

      document.getElementById("btn-salvar-lancamento").dataset.editId = id;
      document.getElementById("btn-salvar-lancamento").textContent = "Salvar edi√ß√£o";
    } catch (err) {
      console.error(err);
      alert("Erro ao carregar para edi√ß√£o.");
    }
  }

  // === SALVAR LAN√áAMENTO ===
  document.getElementById("btn-salvar-lancamento").addEventListener("click", async () => {
    const loja = document.getElementById("field-loja").value;
    const departamento = document.getElementById("field-departamento").value;
    const codigoBarras = document.getElementById("field-codigoBarras").value.trim();
    const descricao = document.getElementById("field-descricao").value.trim();
    const lote = document.getElementById("field-lote").value.trim();
    const quantidade = document.getElementById("field-quantidade").value;
    const validade = document.getElementById("field-validade").value.trim();
    const observacao = document.getElementById("field-observacao").value.trim();

    if (!loja || !departamento || !codigoBarras || !descricao || !quantidade || !validade) {
      alert("Preencha todos os campos obrigat√≥rios.");
      return;
    }

    if (!/^[0-9]{1,13}$/.test(codigoBarras)) {
      alert("C√≥digo de barras deve conter apenas n√∫meros (m√°x. 13).");
      return;
    }

    const { dataSimples, dataHora } = hojeFormatado();

    const payload = {
      loja,
      departamento,
      codigoBarras,
      descricao,
      lote,
      quantidade: Number(quantidade),
      validade,
      dataLancamento: dataSimples,
      observacao,
      ofertaStatus: "N√£o Lan√ßado",
      ofertaFlag: false,
      usuarioNome: nomeAtual || (usuarioAtual && usuarioAtual.displayName) || "",
      criadoPor: usuarioAtual ? usuarioAtual.email.toLowerCase() : "",
      criadoEm: serverTimestamp()
    };

    const editId = document.getElementById("btn-salvar-lancamento").dataset.editId;

    try {
      if (editId) {
        await updateDoc(doc(db, "lancamentos", editId), payload);
        document.getElementById("btn-salvar-lancamento").dataset.editId = "";
        document.getElementById("btn-salvar-lancamento").textContent = "Salvar lan√ßamento";
      } else {
        await addDoc(collection(db, "lancamentos"), payload);
      }

      // limpa alguns campos
      document.getElementById("field-codigoBarras").value = "";
      document.getElementById("field-descricao").value = "";
      document.getElementById("field-lote").value = "";
      document.getElementById("field-quantidade").value = "";
      document.getElementById("field-validade").value = "";
      document.getElementById("field-observacao").value = "";

      atualizarDataLancamento();
      await carregarLancamentos();
    } catch (err) {
      console.error(err);
      alert("Erro ao salvar lan√ßamento.");
    }
  });

  // === FILTROS ===
  document.getElementById("filtro-status").addEventListener("change", carregarLancamentos);
  document.getElementById("filtro-departamento").addEventListener("change", carregarLancamentos);

  // === MARCAR TODOS COMO OFERTA ===
  document.getElementById("btn-marcar-oferta").addEventListener("click", async () => {
    if (!confirm("Marcar todos os itens listados como 'Lan√ßado' em oferta?")) return;
    try {
      const checkboxes = document.querySelectorAll(".checkbox-flag");
      const promises = [];
      checkboxes.forEach(chk => {
        const id = chk.getAttribute("data-id");
        promises.push(
          updateDoc(doc(db, "lancamentos", id), {
            ofertaFlag: true,
            ofertaStatus: "Lan√ßado"
          })
        );
      });
      await Promise.all(promises);
      await carregarLancamentos();
    } catch (err) {
      console.error(err);
      alert("Erro ao atualizar ofertas.");
    }
  });

  // === EXPORTAR EXCEL ===
  document.getElementById("btn-export-excel").addEventListener("click", () => {
    const wb = XLSX.utils.book_new();
    const data = [];
    const header = [
      "Loja",
      "Data lan√ßamento",
      "Departamento",
      "C√≥d. barras",
      "Descri√ß√£o",
      "Qtd",
      "Validade",
      "Status",
      "Oferta",
      "Lote",
      "Usu√°rio",
      "Lan√ßado em",
      "Observa√ß√£o"
    ];
    data.push(header);

    document.querySelectorAll("#tabela-itens tbody tr").forEach(tr => {
      const cols = tr.querySelectorAll("td");
      if (cols.length < 15) return; // ignora linha de "Nenhum item"

      const row = [
        cols[0].innerText,
        cols[1].innerText,
        cols[2].innerText,
        cols[3].innerText,
        cols[4].innerText,
        cols[5].innerText,
        cols[6].innerText,
        cols[7].innerText,
        cols[8].innerText,
        cols[10].innerText,
        cols[11].innerText,
        cols[12].innerText,
        cols[13].innerText
      ];
      data.push(row);
    });

    const ws = XLSX.utils.aoa_to_sheet(data);
    XLSX.utils.book_append_sheet(wb, ws, "Validades");
    XLSX.writeFile(wb, "controle-validade-palato.xlsx");
  });

  // === EXPORTAR PDF ===
  document.getElementById("btn-export-pdf").addEventListener("click", () => {
    const { jsPDF } = window.jspdf;
    const docPdf = new jsPDF("l", "pt", "a4");

    docPdf.setFontSize(12);
    docPdf.text("Palato - Controle de Validade", 40, 40);
    docPdf.setFontSize(9);
    docPdf.text(`Gerado em: ${hojeFormatado().dataHora}`, 40, 55);

    const body = [];
    document.querySelectorAll("#tabela-itens tbody tr").forEach(tr => {
      const cols = tr.querySelectorAll("td");
      if (cols.length < 15) return;
      body.push([
        cols[0].innerText,
        cols[1].innerText,
        cols[2].innerText,
        cols[3].innerText,
        cols[4].innerText,
        cols[5].innerText,
        cols[6].innerText,
        cols[7].innerText,
        cols[8].innerText,
        cols[10].innerText,
        cols[11].innerText,
        cols[12].innerText
      ]);
    });

    docPdf.autoTable({
      startY: 70,
      head: [[
        "Loja",
        "Data lan√ß.",
        "Depto",
        "C√≥d. barras",
        "Descri√ß√£o",
        "Qtd",
        "Validade",
        "Status",
        "Oferta",
        "Lote",
        "Usu√°rio",
        "Lan√ßado em"
      ]],
      body,
      styles: {
        fontSize: 7,
        cellPadding: 3
      },
      headStyles: {
        fillColor: [0, 0, 0],
        textColor: [255, 255, 255]
      },
      alternateRowStyles: {
        fillColor: [245, 245, 245]
      }
    });

    docPdf.save("controle-validade-palato.pdf");
  });

  // === ADMINISTRA√á√ÉO DE USU√ÅRIOS ===
  async function carregarUsuarios() {
    tabelaUsuariosBody.innerHTML = "<tr><td colspan='5'>Carregando...</td></tr>";
    try {
      const snap = await getDocs(collection(db, "usuarios"));
      tabelaUsuariosBody.innerHTML = "";

      if (snap.empty) {
        tabelaUsuariosBody.innerHTML = "<tr><td colspan='5'>Nenhum usu√°rio cadastrado.</td></tr>";
        return;
      }

      snap.forEach(docSnap => {
        const u = docSnap.data();

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${u.nome || ""}</td>
          <td>${u.email || ""}</td>
          <td>
            <select data-id="${docSnap.id}" data-campo="tipo">
              <option value="repositor" ${u.tipo === "repositor" ? "selected" : ""}>Repositor</option>
              <option value="gerente" ${u.tipo === "gerente" ? "selected" : ""}>Gerente</option>
              <option value="admin" ${u.tipo === "admin" ? "selected" : ""}>Admin</option>
            </select>
          </td>
          <td>
            <select data-id="${docSnap.id}" data-campo="loja">
              <option value="" ${!u.loja ? "selected" : ""}>Nenhuma</option>
              <option value="Ponta Verde" ${u.loja === "Ponta Verde" ? "selected" : ""}>Ponta Verde</option>
              <option value="Farol" ${u.loja === "Farol" ? "selected" : ""}>Farol</option>
              <option value="Praia" ${u.loja === "Praia" ? "selected" : ""}>Praia</option>
              <option value="Riomar" ${u.loja === "Riomar" ? "selected" : ""}>Riomar</option>
              <option value="CD" ${u.loja === "CD" ? "selected" : ""}>CD</option>
            </select>
          </td>
          <td class="users-actions-cell">
            <span class="link-action" data-acao="salvar" data-id="${docSnap.id}">Salvar</span>
            <span class="link-action link-delete" data-acao="excluir" data-id="${docSnap.id}">Excluir</span>
          </td>
        `;
        tabelaUsuariosBody.appendChild(tr);
      });

      // handlers
      tabelaUsuariosBody.querySelectorAll("span[data-acao]").forEach(el => {
        el.addEventListener("click", async e => {
          const id = e.target.getAttribute("data-id");
          const acao = e.target.getAttribute("data-acao");
          if (acao === "excluir") {
            if (!confirm("Excluir este usu√°rio da tabela de controle (n√£o exclui do login)?")) return;
            await deleteDoc(doc(db, "usuarios", id));
            await carregarUsuarios();
          } else if (acao === "salvar") {
            const tipoSel = tabelaUsuariosBody.querySelector(`select[data-id="${id}"][data-campo="tipo"]`);
            const lojaSel = tabelaUsuariosBody.querySelector(`select[data-id="${id}"][data-campo="loja"]`);
            await updateDoc(doc(db, "usuarios", id), {
              tipo: tipoSel.value,
              loja: lojaSel.value
            });
            await carregarUsuarios();
          }
        });
      });
    } catch (err) {
      console.error(err);
      tabelaUsuariosBody.innerHTML = "<tr><td colspan='5'>Erro ao carregar usu√°rios.</td></tr>";
    }
  }

  document.getElementById("btn-salvar-usuario").addEventListener("click", async () => {
    const nome = document.getElementById("admin-nome").value.trim();
    const email = document.getElementById("admin-email").value.trim().toLowerCase();
    const tipo = document.getElementById("admin-perfil").value;
    const loja = document.getElementById("admin-loja").value;

    if (!email) {
      alert("Informe ao menos o e-mail.");
      return;
    }

    try {
      await addDoc(collection(db, "usuarios"), {
        nome,
        email,
        tipo,
        loja,
        criadoEm: serverTimestamp()
      });
      document.getElementById("admin-nome").value = "";
      document.getElementById("admin-email").value = "";
      await carregarUsuarios();
    } catch (err) {
      console.error(err);
      alert("Erro ao salvar usu√°rio.");
    }
  });

  document.getElementById("btn-recarregar-usuarios").addEventListener("click", carregarUsuarios);

  // === LOGIN ===
  document.getElementById("btn-login-email").addEventListener("click", async () => {
    const email = document.getElementById("login-email").value;
    const senha = document.getElementById("login-password").value;
    if (!email || !senha) {
      alert("Informe e-mail e senha.");
      return;
    }
    try {
      const cred = await signInWithEmailAndPassword(auth, email, senha);
      await garantirUsuarioNoFirestore(cred.user);
    } catch (err) {
      console.error(err);
      alert("Erro no login: " + err.message);
    }
  });

  document.getElementById("btn-login-google").addEventListener("click", async () => {
    try {
      const cred = await signInWithPopup(auth, googleProvider);
      await garantirUsuarioNoFirestore(cred.user);
    } catch (err) {
      console.error(err);
      alert("Erro no login com Google.");
    }
  });

  document.getElementById("btn-logout").addEventListener("click", async () => {
    await signOut(auth);
  });

  // === AUTH STATE ===
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      usuarioAtual = null;
      loginScreen.classList.remove("hidden");
      appScreen.classList.add("hidden");
      return;
    }

    usuarioAtual = user;

    const registro = await garantirUsuarioNoFirestore(user);
    perfilAtual = (registro && registro.tipo) || "repositor";
    lojaAtual = (registro && registro.loja) || "";
    nomeAtual = (registro && registro.nome) || (user.displayName || user.email);

    userNomeSpan.textContent = nomeAtual || user.email;
    userPerfilSpan.textContent = `Perfil: ${perfilAtual}`;

    loginScreen.classList.add("hidden");
    appScreen.classList.remove("hidden");

    atualizarDataLancamento();
    await carregarLancamentos();

    if (perfilAtual === "admin") {
      adminCard.classList.remove("hidden");
      await carregarUsuarios();
    } else {
      adminCard.classList.add("hidden");
    }
  });

  // === SCANNER ===
  const scannerModal = document.getElementById("scanner-modal");
  const scannerContainer = document.getElementById("scanner-container");

  document.getElementById("btn-open-scanner").addEventListener("click", () => {
    abrirScanner();
  });

  document.getElementById("btn-fechar-scanner").addEventListener("click", () => {
    fecharScanner();
  });

  async function abrirScanner() {
    scannerModal.style.display = "flex";
    scannerContainer.innerHTML = "";

    if (!window.Html5Qrcode) {
      alert("Biblioteca do leitor n√£o carregou corretamente.");
      return;
    }

    scannerInstance = new Html5Qrcode("scanner-container");

    try {
      const cameras = await Html5Qrcode.getCameras();
      if (!cameras || cameras.length === 0) {
        alert("Nenhuma c√¢mera encontrada.");
        fecharScanner();
        return;
      }

      // tenta achar traseira
      let cameraId = cameras[0].id;
      const traseira = cameras.find(c => /back|rear|environment/i.test(c.label));
      if (traseira) cameraId = traseira.id;

      await scannerInstance.start(
        cameraId,
        {
          fps: 10,
          qrbox: 220
        },
        (decodedText /*, decodedResult*/) => {
          // preenche campo
          const apenasNumeros = decodedText.replace(/\D/g, "").slice(0, 13);
          const inputCod = document.getElementById("field-codigoBarras");
          inputCod.value = apenasNumeros;
          fecharScanner();
        },
        (errorMessage) => {
          console.warn(errorMessage);
        }
      );
    } catch (err) {
      console.error(err);
      alert("Leitor de c√≥digo de barras n√£o carregou corretamente.");
      fecharScanner();
    }
  }

  async function fecharScanner() {
    scannerModal.style.display = "none";
    if (scannerInstance) {
      try {
        await scannerInstance.stop();
        await scannerInstance.clear();
      } catch (err) {
        console.error(err);
      }
      scannerInstance = null;
    }
  }

  // fecha modal clicando fora
  scannerModal.addEventListener("click", (e) => {
    if (e.target === scannerModal) {
      fecharScanner();
    }
  });
</script>
</body>
</html>
